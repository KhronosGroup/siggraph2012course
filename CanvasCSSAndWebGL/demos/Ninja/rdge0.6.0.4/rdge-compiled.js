var RDGE=RDGE||{};RDGE.vec2={};RDGE.vec2.string=function(a){return"{ "+a[0]+", "+a[1]+" }"};RDGE.vec2.verify=function(a){return void 0==a||void 0==a.length||2>a.length||"number"!=typeof a[0]||"number"!=typeof a[1]?!1:!0};RDGE.vec2.copy=function(a){return void 0==a.length?[a,a]:[a[0],a[1]]};RDGE.vec2.inplace_copy=function(a,b){a[0]=b[0];a[1]=b[1]};RDGE.vec2.zero=function(){return[0,0]};RDGE.vec2.up=function(){return[0,1]};RDGE.vec2.right=function(){return[1,0]};
RDGE.vec2.add=function(a,b){return[a[0]+b[0],a[1]+b[1]]};RDGE.vec2.sub=function(a,b){return[a[0]-b[0],a[1]-b[1]]};RDGE.vec2.mul=function(a,b){return[a[0]*b[0],a[1]*b[1]]};RDGE.vec2.addMul=function(a,b,c){return void 0!=c.length&&2<=c.length?[a[0]+b[0]*c[0],a[1]+b[1]*c[1]]:[a[0]+b[0]*c,a[1]+b[1]*c]};RDGE.vec2.scale=function(a,b){return void 0!=b.length&&2<=b.length?[a[0]*b[0],a[1]*b[1]]:[a[0]*b,a[1]*b]};RDGE.vec2.negate=function(a){return[-a[0],-a[1]]};
RDGE.vec2.normalize=function(a){var b=Math.sqrt(a[0]*a[0],a[1]*a[1]);return 1.0E-4<Math.abs(1-b)?(b=1/b,[a[0]*b,a[1]*b]):a};RDGE.vec2.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]};RDGE.vec2.perp=function(a){return[a[1],-a[0]]};RDGE.vec2.lengthSq=function(a){return a[0]*a[0]+a[1]*a[1]};RDGE.vec2.length=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1])};RDGE.vec2.min=function(a,b){return[Math.min(a[0],b[0]),Math.min(a[1],b[1])]};RDGE.vec2.max=function(a,b){return[Math.max(a[0],b[0]),Math.max(a[1],b[1])]};
RDGE.vec2.clamp=function(a,b,c){return RDGE.vec2.min(c,RDGE.vec2.max(a,b))};RDGE=RDGE||{};RDGE.vec3={};RDGE.vec3.string=function(a){return"{ "+a[0]+", "+a[1]+", "+a[2]+" }"};RDGE.vec3.verify=function(a){return void 0==a||void 0==a.length||3>a.length||"number"!=typeof a[0]||"number"!=typeof a[1]||"number"!=typeof a[2]?!1:!0};RDGE.vec3.inplace_copy=function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2]};RDGE.vec3.copy=function(a){return void 0==a.length?[a,a,a]:[a[0],a[1],a[2]]};RDGE.vec3.translation=function(a){return[a[12],a[13],a[14]]};
RDGE.vec3.basisX=function(a){return[a[0],a[1],a[2]]};RDGE.vec3.basisY=function(a){return[a[4],a[5],a[6]]};RDGE.vec3.basisZ=function(a){return[a[8],a[9],a[10]]};RDGE.vec3.zero=function(){return[0,0,0]};RDGE.vec3.up=function(){return[0,1,0]};RDGE.vec3.forward=function(){return[0,0,1]};RDGE.vec3.right=function(){return[1,0,0]};RDGE.vec3.random=function(a,b){return[a[0]+(b[0]-a[0])*Math.random(),a[1]+(b[1]-a[1])*Math.random(),a[2]+(b[2]-a[2])*Math.random()]};RDGE.vec3.xy=function(a){return[a[0],a[1]]};
RDGE.vec3.xz=function(a){return[a[0],a[2]]};RDGE.vec3.add=function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]};RDGE.vec3.plusEqual=function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2]};RDGE.vec3.sub=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};RDGE.vec3.mul=function(a,b){return[a[0]*b[0],a[1]*b[1],a[2]*b[2]]};RDGE.vec3.addMul=function(a,b,c){return void 0!=c.length&&3<=c.length?[a[0]+b[0]*c[0],a[1]+b[1]*c[1],a[2]+b[2]*c[2]]:[a[0]+b[0]*c,a[1]+b[1]*c,a[2]+b[2]*c]};
RDGE.vec3.plusEqualMul=function(a,b,c){void 0!==c.length&&3<=c.length?(a[0]+=b[0]*c[0],a[1]+=b[1]*c[1],a[2]+=b[2]*c[2]):(a[0]+=b[0]*c,a[1]+=b[1]*c,a[2]+=b[2]*c)};RDGE.vec3.scale=function(a,b){return void 0!==b.length&&3<=b.length?[a[0]*b[0],a[1]*b[1],a[2]*b[2]]:[a[0]*b,a[1]*b,a[2]*b]};RDGE.vec3.inplace_scale=function(a,b){void 0!==b.length&&3<=b.length?(a[0]*=b[0],a[1]*=b[1],a[2]*=b[2]):(a[0]*=b,a[1]*=b,a[2]*=b)};RDGE.vec3.negate=function(a){return[-a[0],-a[1],-a[2]]};
RDGE.vec3.inplace_negate=function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2]};RDGE.vec3.normalize=function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return 1.0E-4<Math.abs(1-b)?(b=1/b,[a[0]*b,a[1]*b,a[2]*b]):a};RDGE.vec3.cross=function(a,b){return[a[1]*b[2]-b[1]*a[2],a[2]*b[0]-b[2]*a[0],a[0]*b[1]-b[0]*a[1]]};RDGE.vec3.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};RDGE.vec3.lengthSq=function(a){return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]};
RDGE.vec3.length=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])};RDGE.vec3.distanceSq=function(a,b){var c=[a[0]-b[0],a[1]-b[1],a[2]-b[2]];return c[0]*c[0]+c[1]*c[1]+c[2]*c[2]};RDGE.vec3.distance=function(a,b){var c=[a[0]-b[0],a[1]-b[1],a[2]-b[2]];return Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2])};RDGE.vec3.angle=function(a,b){return Math.acos(RDGE.vec3.dot(a,b))/(RDGE.vec3.length(a)*RDGE.vec3.length(b))};RDGE.vec3.direction=function(a,b){return RDGE.vec3.normalize(RDGE.vec3.sub(b,a))};
RDGE.vec3.abs=function(a){return[Math.abs(a[0]),Math.abs(a[1]),Math.abs(a[2])]};RDGE.vec3.min=function(a,b){return[Math.min(a[0],b[0]),Math.min(a[1],b[1]),Math.min(a[2],b[2])]};RDGE.vec3.max=function(a,b){return[Math.max(a[0],b[0]),Math.max(a[1],b[1]),Math.max(a[2],b[2])]};RDGE.vec3.clamp=function(a,b,c){return RDGE.vec3.min(c,RDGE.vec3.max(a,b))};RDGE.vec3.equal=function(a,b,c){c||(c=0.0010);return RDGE.vec3.distanceSq(a,b)<c*c};
RDGE.vec3.lerp=function(a,b,c){return[a[0]+(b[0]-a[0])*c,a[1]+(b[1]-a[1])*c,a[2]+(b[2]-a[2])*c]};RDGE=RDGE||{};RDGE.vec4={};RDGE.vec4.string=function(a){return"{ "+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+" }"};RDGE.vec4.verify=function(a){return void 0==a||void 0==a.length||4>a.length||"number"!=typeof a[0]||"number"!=typeof a[1]||"number"!=typeof a[2]||"number"!=typeof a[3]?!1:!0};RDGE.vec4.inplace_copy=function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3]};RDGE.vec4.copy=function(a){return void 0==a.length?[a,a,a,a]:3==a.length?[a[0],a[1],a[2],1]:[a[0],a[1],a[2],a[3]]};
RDGE.vec4.zero=function(){return[0,0,0,0]};RDGE.vec4.identity=function(){return[0,0,0,1]};RDGE.vec4.up=function(){return[0,1,0,0]};RDGE.vec4.forward=function(){return[0,0,1,0]};RDGE.vec4.right=function(){return[1,0,0,0]};RDGE.vec4.random=function(a,b){return[a[0]+(b[0]-a[0])*Math.random(),a[1]+(b[1]-a[1])*Math.random(),a[2]+(b[2]-a[2])*Math.random(),a[3]+(b[3]-a[3])*Math.random()]};RDGE.vec4.add=function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3]]};
RDGE.vec4.sub=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3]]};RDGE.vec4.mul=function(a,b){return[a[0]*b[0],a[1]*b[1],a[2]*b[2],a[3]*b[3]]};RDGE.vec4.addMul=function(a,b,c){return void 0!=c.length&&4<=c.length?[a[0]+b[0]*c[0],a[1]+b[1]*c[1],a[2]+b[2]*c[2],a[3]+b[3]*c[3]]:[a[0]+b[0]*c,a[1]+b[1]*c,a[2]+b[2]*c,a[3]+b[3]*c]};RDGE.vec4.scale=function(a,b){return void 0!=b.length&&4<=b.length?[a[0]*b[0],a[1]*b[1],a[2]*b[2],a[3]*b[3]]:[a[0]*b,a[1]*b,a[2]*b,a[3]*b]};
RDGE.vec4.negate=function(a){return[-a[0],-a[1],-a[2],-a[3]]};RDGE.vec4.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]};RDGE.vec4.normalize=function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]);return 1.0E-4<Math.abs(1-b)?(b=1/b,[a[0]*b,a[1]*b,a[2]*b,a[3]*b]):a};RDGE.vec4.lengthSq=function(a){return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]};RDGE.vec4.length=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3])};
RDGE.vec4.abs=function(a){return[Math.abs(a[0]),Math.abs(a[1]),Math.abs(a[2]),Math.abs(a[3])]};RDGE.vec4.min=function(a,b){return[Math.min(a[0],b[0]),Math.min(a[1],b[1]),Math.min(a[2],b[2]),Math.min(a[3],b[3])]};RDGE.vec4.max=function(a,b){return[Math.max(a[0],b[0]),Math.max(a[1],b[1]),Math.max(a[2],b[2]),Math.min(a[3],b[3])]};RDGE.vec4.clamp=function(a,b,c){return RDGE.vec4.min(c,RDGE.vec4.max(a,b))};RDGE.vec4.equal=function(a,b,c){c||(c=0.0010);return RDGE.vec4.distanceSq(a,b)<c*c};
RDGE.vec4.lerp=function(a,b,c){return[a[0]+(b[0]-a[0])*c,a[1]+(b[1]-a[1])*c,a[2]+(b[2]-a[2])*c,a[3]+(b[3]-a[3])*c]};RDGE=RDGE||{};RDGE.mat4={};RDGE.mat4.string=function(a){var b;b="{ "+(a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", ");b+=a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", ";b+=a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", ";return b+=a[12]+", "+a[13]+", "+a[14]+", "+a[15]+" }"};
RDGE.mat4.toCSSString=function(a,b){var c=10;b&&(c=b);var d;d="matrix3d("+(a[0].toFixed(10)+", "+a[1].toFixed(10)+", "+a[2].toFixed(10)+", "+a[3].toFixed(10)+", ");d+=a[4].toFixed(10)+", "+a[5].toFixed(10)+", "+a[6].toFixed(10)+", "+a[7].toFixed(10)+", ";d+=a[8].toFixed(10)+", "+a[9].toFixed(10)+", "+a[10].toFixed(10)+", "+a[11].toFixed(10)+", ";return d+=a[12].toFixed(10)*c+", "+(600-a[13].toFixed(10)*c)+", "+a[14].toFixed(10)*c+", "+a[15].toFixed(10)+")"};
RDGE.mat4.verify=function(a){if(void 0==a||void 0==a.length||16>a.length)return!1;for(var b=16;b--;)if("number"!=typeof a[b])return!1;return!0};RDGE.mat4.copy=function(a){return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]]};RDGE.mat4.inplace_copy=function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];a[4]=b[4];a[5]=b[5];a[6]=b[6];a[7]=b[7];a[8]=b[8];a[9]=b[9];a[10]=b[10];a[11]=b[11];a[12]=b[12];a[13]=b[13];a[14]=b[14];a[15]=b[15]};
RDGE.mat4.identity=function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]};RDGE.mat4.zero=function(){return[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};RDGE.mat4.basis=function(a,b,c,d){return null==d||void 0==d?[a[0],a[1],a[2],0,b[0],b[1],b[2],0,c[0],c[1],c[2],0,0,0,0,1]:[a[0],a[1],a[2],4==a.length?a[3]:0,b[0],b[1],b[2],4==b.length?b[3]:0,c[0],c[1],c[2],4==c.length?c[3]:0,d[0],d[1],d[2],4==d.length?d[3]:1]};
RDGE.mat4.angleAxis=function(a,b){var a=a*(Math.PI/180),a=a/2,c=Math.sin(a),d=Math.cos(a),f=c*c;RDGE.vec3.normalize(b);0>=RDGE.vec3.lengthSq(b)&&(b=[0,0,0,1]);var g=RDGE.mat4.identity();if(1==b[0]&&0==b[1]&&0==b[2])g[5]=1-2*f,g[6]=2*c*d,g[9]=-2*c*d,g[10]=1-2*f;else if(0==b[0]&&1==b[1]&&0==b[2])g[0]=1-2*f,g[2]=-2*c*d,g[8]=2*c*d,g[10]=1-2*f;else if(0==b[0]&&0==b[1]&&1==b[2])g[0]=1-2*f,g[1]=2*c*d,g[4]=-2*c*d,g[5]=1-2*f;else{var h=b[0],l=b[1],m=b[2],n=h*h,p=l*l,o=m*m;g[0]=1-2*(p+o)*f;g[1]=2*(h*l*f+m*
c*d);g[2]=2*(h*m*f-l*c*d);g[4]=2*(l*h*f-m*c*d);g[5]=1-2*(o+n)*f;g[6]=2*(l*m*f+h*c*d);g[8]=2*(m*h*f+l*c*d);g[9]=2*(m*l*f-h*c*d);g[10]=1-2*(n+p)*f}return g};RDGE.mat4.lookAt=function(a,b,c){b=RDGE.vec3.normalize(RDGE.vec3.sub(a,b));1.0E-4>RDGE.vec3.length(b)&&(b=[0,0,1]);var c=RDGE.vec3.normalize(RDGE.vec3.cross(c,b)),d=RDGE.vec3.normalize(RDGE.vec3.cross(b,c)),f=RDGE.mat4.identity();RDGE.mat4.setRow(f,0,c);RDGE.mat4.setRow(f,1,d);RDGE.mat4.setRow(f,2,b);RDGE.mat4.setRow(f,3,a);return f};
RDGE.mat4.frustum=function(a,b,c,d,f,g){var h=b-a,l=d-c,m=g-f,n=2*f,p=RDGE.mat4.zero();p[0]=n/h;p[5]=n/l;p[8]=(b+a)/h;p[9]=(d+c)/l;p[10]=-(g+f)/m;p[11]=-1;p[14]=-(n*g)/m;return p};RDGE.mat4.perspective=function(a,b,c,d){var a=Math.tan(a*Math.PI/360)*c,f=-a;return RDGE.mat4.frustum(b*f,b*a,f,a,c,d)};RDGE.mat4.orthographic=function(a,b,c,d,f,g){var h=(a+b)/(a-b),l=(c+d)/(c-d),m=(g+f)/(g-f),n=RDGE.mat4.zero();n[0]=2/(a-b);n[5]=2/(c-d);n[10]=-2/(g-f);n[12]=h;n[13]=l;n[14]=m;n[15]=1;return n};
RDGE.mat4.mul=function(a,b){var c=a[0],d=a[1],f=a[2],g=a[3],h=a[4],l=a[5],m=a[6],n=a[7],p=a[8],o=a[9],q=a[10],r=a[11],u=a[12],s=a[13],w=a[14],v=a[15],x=b[0],z=b[1],A=b[2],y=b[3],B=b[4],C=b[5],D=b[6],E=b[7],F=b[8],G=b[9],H=b[10],I=b[11],J=b[12],K=b[13],L=b[14],M=b[15];return[c*x+d*B+f*F+g*J,c*z+d*C+f*G+g*K,c*A+d*D+f*H+g*L,c*y+d*E+f*I+g*M,h*x+l*B+m*F+n*J,h*z+l*C+m*G+n*K,h*A+l*D+m*H+n*L,h*y+l*E+m*I+n*M,p*x+o*B+q*F+r*J,p*z+o*C+q*G+r*K,p*A+o*D+q*H+r*L,p*y+o*E+q*I+r*M,u*x+s*B+w*F+v*J,u*z+s*C+w*G+v*K,u*
A+s*D+w*H+v*L,u*y+s*E+w*I+v*M]};RDGE.mat4.mul4x3=function(a,b){var c=a[0],d=a[1],f=a[2],g=a[4],h=a[5],l=a[6],m=a[8],n=a[9],p=a[10],o=a[12],q=a[13],r=a[14],u=b[0],s=b[1],w=b[2],v=b[4],x=b[5],z=b[6],A=b[8],y=b[9],B=b[10];return[c*u+d*v+f*A,c*s+d*x+f*y,c*w+d*z+f*B,0,g*u+h*v+l*A,g*s+h*x+l*y,g*w+h*z+l*B,0,m*u+n*v+p*A,m*s+n*x+p*y,m*w+n*z+p*B,0,o*u+q*v+r*A+b[12],o*s+q*x+r*y+b[13],o*w+q*z+r*B+b[14],1]};RDGE.mat4._det2x2=function(a,b,c,d){return a*d-b*c};
RDGE.mat4._det3x3=function(a,b,c,d,f,g,h,l,m){return a*RDGE.mat4._det2x2(f,g,l,m)-d*RDGE.mat4._det2x2(b,c,l,m)+h*RDGE.mat4._det2x2(b,c,f,g)};RDGE.mat4._det4x4=function(a){var b=a[1],c=a[2],d=a[3],f=a[4],g=a[5],h=a[6],l=a[7],m=a[8],n=a[9],p=a[10],o=a[11],q=a[12],r=a[13],u=a[14],s=a[15];return a[0]*RDGE.mat4._det3x3(g,n,r,h,p,u,l,o,s)-b*RDGE.mat4._det3x3(f,m,q,h,p,u,l,o,s)+c*RDGE.mat4._det3x3(f,m,q,g,n,r,l,o,s)-d*RDGE.mat4._det3x3(f,m,q,g,n,r,h,p,u)};
RDGE.mat4._adjoint=function(a){var b=a[0],c=a[1],d=a[2],f=a[3],g=a[4],h=a[5],l=a[6],m=a[7],n=a[8],p=a[9],o=a[10],q=a[11],r=a[12],u=a[13],s=a[14],a=a[15];return[RDGE.mat4._det3x3(h,p,u,l,o,s,m,q,a),-RDGE.mat4._det3x3(c,p,u,d,o,s,f,q,a),RDGE.mat4._det3x3(c,h,u,d,l,s,f,m,a),-RDGE.mat4._det3x3(c,h,p,d,l,o,f,m,q),-RDGE.mat4._det3x3(g,n,r,l,o,s,m,q,a),RDGE.mat4._det3x3(b,n,r,d,o,s,f,q,a),-RDGE.mat4._det3x3(b,g,r,d,l,s,f,m,a),RDGE.mat4._det3x3(b,g,n,d,l,o,f,m,q),RDGE.mat4._det3x3(g,n,r,h,p,u,m,q,a),-RDGE.mat4._det3x3(b,
n,r,c,p,u,f,q,a),RDGE.mat4._det3x3(b,g,r,c,h,u,f,m,a),-RDGE.mat4._det3x3(b,g,n,c,h,p,f,m,q),-RDGE.mat4._det3x3(g,n,r,h,p,u,l,o,s),RDGE.mat4._det3x3(b,n,r,c,p,u,d,o,s),-RDGE.mat4._det3x3(b,g,r,c,h,u,d,l,s),RDGE.mat4._det3x3(b,g,n,c,h,p,d,l,o)]};RDGE.mat4.inverse=function(a){var b=RDGE.mat4._det4x4(a);if(1.0E-8>Math.abs(b))return null;a=RDGE.mat4._adjoint(a);b=1/b;return[a[0]*b,a[1]*b,a[2]*b,a[3]*b,a[4]*b,a[5]*b,a[6]*b,a[7]*b,a[8]*b,a[9]*b,a[10]*b,a[11]*b,a[12]*b,a[13]*b,a[14]*b,a[15]*b]};
RDGE.mat4.rigidInverse=function(a){out=RDGE.mat4.transpose3x3(a);out[12]=-RDGE.vec3.dot([out[0],out[4],out[8]],[a[12],a[13],a[14]]);out[13]=-RDGE.vec3.dot([out[1],out[5],out[9]],[a[12],a[13],a[14]]);out[14]=-RDGE.vec3.dot([out[2],out[6],out[10]],[a[12],a[13],a[14]]);return out};RDGE.mat4.transpose=function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]};
RDGE.mat4.transpose3x3=function(a){return[a[0],a[4],a[8],a[3],a[1],a[5],a[9],a[7],a[2],a[6],a[10],a[11],a[12],a[13],a[14],a[15]]};RDGE.mat4.transformPoint=function(a,b){var c=b[0],d=b[1],f=b[2],g=4<=b.length?b[3]:1;return[a[0]*c+a[4]*d+a[8]*f+a[12]*g,a[1]*c+a[5]*d+a[9]*f+a[13]*g,a[2]*c+a[6]*d+a[10]*f+a[14]*g,a[3]*c+a[7]*d+a[11]*f+a[15]*g]};
RDGE.mat4.transformVector=function(a,b){var a=RDGE.mat4.inverse(a),c=b[0],d=b[1],f=b[2],g=4<=b.length?b[3]:0;return[a[0]*c+a[1]*d+a[2]*f+a[3]*g,a[4]*c+a[5]*d+a[6]*f+a[7]*g,a[8]*c+a[9]*d+a[10]*f+a[11]*g,a[12]*c+a[13]*d+a[14]*f+a[15]*g]};RDGE.mat4.transformPoint4x3=function(a,b){var c=b[0],d=b[1],f=b[2];return[a[0]*c+a[4]*d+a[8]*f+a[12],a[1]*c+a[5]*d+a[9]*f+a[13],a[2]*c+a[6]*d+a[10]*f+a[14],1]};
RDGE.mat4.transformVector4x3=function(a,b){var a=RDGE.mat4.inverse(a),c=b[0],d=b[1],f=b[2];return[a[0]*c+a[1]*d+a[2]*f,a[4]*c+a[5]*d+a[6]*f,a[8]*c+a[9]*d+a[10]*f,0]};RDGE.mat4.getRow=function(a,b){b*=4;return[a[b],a[b+1],a[b+2],a[b+3]]};RDGE.mat4.getCol=function(a,b){return[a[b],a[b+4],a[b+8],a[b+12]]};RDGE.mat4.setRow=function(a,b,c){b*=4;a[b+0]=c[0];a[b+1]=c[1];a[b+2]=c[2];4<=c.length&&(a[b+3]=c[3]);return a};
RDGE.mat4.setCol=function(a,b,c){a[b+0]=c[0];a[b+4]=c[1];a[b+8]=c[2];4<=c.length&&(a[b+12]=c[3]);return a};RDGE.mat4.rotate=function(a,b,c){return RDGE.mat4.mul(a,RDGE.mat4.angleAxis(b,c))};RDGE.mat4.rotateX=function(a,b){return RDGE.mat4.mul(a,RDGE.mat4.angleAxis(b,RDGE.vec3.basisX(a)))};RDGE.mat4.rotateY=function(a,b){return RDGE.mat4.mul(a,RDGE.mat4.angleAxis(b,RDGE.vec3.basisY(a)))};RDGE.mat4.rotateZ=function(a,b){return RDGE.mat4.mul(a,RDGE.mat4.angleAxis(b,RDGE.vec3.basisZ(a)))};
RDGE.mat4.scale=function(a,b){var c=RDGE.mat4.identity();void 0==b.length&&(b=[b,b,b]);c[0]=b[0];c[5]=b[1];c[10]=b[2];return RDGE.mat4.mul(a,c)};RDGE.mat4.scaleX=function(a,b){return RDGE.mat4.scale(a,[b,1,1])};RDGE.mat4.scaleY=function(a,b){return RDGE.mat4.scale(a,[1,b,1])};RDGE.mat4.scaleZ=function(a,b){return RDGE.mat4.scale(a,[1,1,b])};RDGE.mat4.translate=function(a,b){matT=RDGE.mat4.identity();matT[12]=b[0];matT[13]=b[1];matT[14]=b[2];return RDGE.mat4.mul(a,matT)};
RDGE.mat4.translateX=function(a,b){return RDGE.mat4.translate(a,[b,0,0])};RDGE.mat4.translateY=function(a,b){return RDGE.mat4.translate(a,[0,b,0])};RDGE.mat4.translateZ=function(a,b){return RDGE.mat4.translate(a,[0,0,b])};RDGE=RDGE||{};RDGE.quat={};RDGE.quat.string=function(a){return"{ "+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+" }"};RDGE.quat.verify=function(a){return void 0==a||void 0==a.length||4>a.length||"number"!=typeof a[0]||"number"!=typeof a[1]||"number"!=typeof a[2]||"number"!=typeof a[3]?!1:!0};RDGE.quat.identity=function(){return[0,0,0,1]};RDGE.quat.add=function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3]]};RDGE.quat.sub=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3]]};
RDGE.quat.mul=function(a,b){return[a[3]*b[3]-a[0]*b[0]-a[1]*b[1]-a[2]*b[2],a[3]*b[0]+a[0]*b[3]+a[1]*b[2]-a[2]*b[1],a[3]*b[1]-a[0]*b[2]+a[1]*b[3]+a[2]*b[0],a[3]*b[2]+a[0]*b[1]-a[1]*b[0]+a[2]*b[3]]};RDGE.quat.addMul=function(a,b,c){return void 0!=c.length&&4<=c.length?[a[0]+b[0]*c[0],a[1]+b[1]*c[1],a[2]+b[2]*c[2],a[3]+b[3]*c[3]]:[a[0]+b[0]*c,a[1]+b[1]*c,a[2]+b[2]*c,a[3]+b[3]*c]};
RDGE.quat.scale=function(a,b){return void 0!=b.length&&4<=b.length?[a[0]*b[0],a[1]*a[1],a[2]*b[2],a[3]*b[3]]:[a[0]*b,a[1]*b,a[2]*b,a[3]*b]};RDGE.quat.lengthSq=function(a){return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]};RDGE.quat.length=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3])};RDGE.quat.normalize=function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]);return 1.0E-4<Math.abs(1-b)?(b=1/b,[a[0]*b,a[1]*b,a[2]*b,a[3]*b]):a};
RDGE.quat.inverse=function(a){var b=RDGE.vec4.lengthSq(a);return 1.0E-5<b?(b=1/b,[a[0]*-b,a[1]*-b,a[2]*-b,a[3]]):a};RDGE.quat.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]};RDGE.quat.applyRotation=function(a,b){return RDGE.mat4.transformPoint(RDGE.quat.toMatrix(a),b)};RDGE.quat.lerp=function(a,b,c){return RDGE.quat.normalize([a[0]+(b[0]-a[0])*c,a[1]+(b[1]-a[1])*c,a[2]+(b[2]-a[2])*c,a[3]+(b[3]-a[3])*c])};
RDGE.quat.slerp=function(a,b,c){var d=RDGE.quat.dot(a,b);if(0.9<=d)return RDGE.quat.lerp(a,b,c);var f=Math.sqrt(Math.abs(1-d*d));if(0.0010>f)return a;var d=0>d?-1:1,g=Math.asin(f),h=1/f,f=Math.sin((1-c)*g)*h,c=Math.sin(c*g)*h*d;RDGE.quat.scale(a,f);RDGE.quat.scale(b,c);return RDGE.quat.normalize(RDGE.quat.add(a,b))};
RDGE.quat.toMatrix=function(a){var b=2*a[0],c=2*a[1],d=2*a[2],f=b*a[3],g=c*a[3],h=d*a[3],b=b*a[0],l=c*a[0],m=d*a[0],c=c*a[1],n=d*a[1],a=d*a[2];return[1-(c+a),l+h,m-g,0,l-h,1-(b+a),n+f,0,m+g,n-f,1-(b+c),0,0,0,0,1]};RDGE=RDGE||{};
RDGE.objectManager=function(){this.guidCounter=0;this.objects=[];this.numObjects=0;this.freelist=[];this.reset=function(){this.objects=[];this.freelist=[];this.guidCounter=0};this.validHandle=function(a){return-1!=this.handleToIndex(a)};this.handleToIndex=function(a){var b=a>>16&65535;return null!=this.objects[b]&&a==this.objects[b].handle?b:-1};this.handleToObject=function(a){a=this.handleToIndex(a);return-1!=a?this.objects[a]:null};this.addObject=function(a){var b=this.objects.length;0<this.freelist.length&&
(b=this.freelist.pop());65535<=++this.guidCounter&&(this.guidCounter=1);a.handle=b<<16|++this.guidCounter;this.objects[b]=a;return a.handle};this.removeObject=function(a){a=this.handleToIndex(a);if(-1!=a){if(void 0!=this.objects[a].onremove)this.objects[a].onremove();this.objects[a]=null;this.freelist.push(a)}}};RDGE=RDGE||{};
RDGE.rdgeGlobalParameters={u_projMatrix:{type:"mat4",data:RDGE.mat4.identity()},u_mvMatrix:{type:"mat4",data:RDGE.mat4.identity()},u_invMvMatrix:{type:"mat4",data:RDGE.mat4.identity()},u_normalMatrix:{type:"mat4",data:RDGE.mat4.identity()},u_worldMatrix:{type:"mat4",data:RDGE.mat4.identity()},u_viewMatrix:{type:"mat4",data:RDGE.mat4.identity()},u_invViewMatrix:{type:"mat4",data:RDGE.mat4.identity()},u_invWorldMatrix:{type:"mat4",data:RDGE.mat4.identity()},u_inv_viewport_width:{type:"float",data:[1]},
u_inv_viewport_height:{type:"float",data:[1]},u_lightPos:{type:"vec3",data:[-20,50,20]},u_lightDiff:{type:"vec4",data:[0.8,0.8,0.8,1]},u_lightAmb:{type:"vec4",data:[1,1,1,1]},rdge_lights:{u_light0Pos:{type:"vec3",data:[-20,50,20]},u_light0Diff:{type:"vec4",data:[0.8,0.8,0.8,1]},u_light0Amb:{type:"vec4",data:[8.0E-4,8.0E-4,8.0E-4,1]},u_light0Spec:{type:"vec4",data:[1,1,1,1]},u_light1Pos:{type:"vec3",data:[0,0,0]},u_light1Diff:{type:"vec4",data:[0,0,0,0]},u_light1Amb:{type:"vec4",data:[0.5,0.5,0.5,
1]},u_light1Spec:{type:"vec4",data:[1,1,1,1]},u_light2Pos:{type:"vec3",data:[0,0,0]},u_light2Diff:{type:"vec4",data:[0,0,0,1]},u_light2Amb:{type:"vec4",data:[0.5,0.5,0.5,1]},u_light2Spec:{type:"vec4",data:[1,1,1,1]},u_light3Pos:{type:"vec3",data:[0,0,0]},u_light3Diff:{type:"vec4",data:[0.8,0.8,0.8,1]},u_light3Amb:{type:"vec4",data:[0.5,0.5,0.5,1]},u_light3Spec:{type:"vec4",data:[1,1,1,1]}},colMap:{type:"tex2d",data:"assets/images/white.png"},u_matAmbient:{type:"vec4",data:[1,1,1,1]},u_matDiffuse:{type:"vec4",
data:[1,1,1,1]},u_matSpecular:{type:"vec4",data:[1,1,1,1]},u_matShininess:{type:"float",data:[128]},u_matEmission:{type:"float",data:[0,0,0,1]},u_frustumFarZ:{type:"float",data:[1E3]},u_shadowLightWorld:{type:"mat4",data:RDGE.mat4.identity()},u_shadowBiasMatrix:{type:"mat4",data:RDGE.mat4.identity()},u_vShadowLight:{type:"mat4",data:RDGE.mat4.identity()},u_shadowBPV:{type:"mat4",data:RDGE.mat4.identity()},u_farZ:{type:"float",data:[1E3]},u_shadowLightFarZ:{type:"float",data:[1E3]},u_cameraFTR:{type:"vec3",
data:[0,0,0]}};RDGE=RDGE||{};
RDGE.rdgeConstants=function(){return{colorBuffer:16384,depthBuffer:256,stencilBuffer:1024,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,VS_ELEMENT_FLOAT4:4,VS_ELEMENT_POS:3,VS_ELEMENT_NORM:3,VS_ELEMENT_FLOAT3:3,VS_ELEMENT_FLOAT2:2,VS_ELEMENT_UV:2,VS_ELEMENT_FLOAT:1,MAX_ELEM_TYPES:7,BUFFER_STATIC:35040,BUFFER_DYNAMIC:35044,BUFFER_STREAM:35048,MAX_MATERIAL_LIGHTS:4,categoryEnumeration:{BACKGROUND:0,
OPAQUE:1,TRANSPARENT:2,ADDITIVE:3,TRANSLUCENT:4,FOREGROUND:5,MAX_CAT:6},nodeType:{TRNODE:0,MESHNODE:1,MATNODE:2,LIGHTNODE:3}}}();
RDGE._renderer=function(a){try{if(this.ctx=a.getContext("experimental-webgl",{preserveDrawingBuffer:!0}),this.ctx||(this.ctx=a.getContext("webgl",{preserveDrawingBuffer:!0})),this.ctx||(this.ctx=a.getContext("webkit-3d",{preserveDrawingBuffer:!0})),!this.ctx)this.ctx=a.getContext("moz-webgl",{preserveDrawingBuffer:!0})}catch(b){}if(!this.ctx)return window.console.log("Could not create GL context"),null;this.ctx.viewport(0,0,a.width,a.height);this.console="console"in window?window.console:{log:function(){}};
this.ctx.clearColor(1,0,0,1);this.clearColor=[1,0,0,1];this.clearFlags=this.ctx.COLOR_BUFFER_BIT|this.ctx.DEPTH_BUFFER_BIT;this.colorBuffer=this.ctx.COLOR_BUFFER_BIT;this.depthBuffer=this.ctx.DEPTH_BUFFER_BIT;this.stencilBuffer=this.ctx.STENCIL_BUFFER_BIT;this.BUFFER_STATIC=0;this.BUFFER_DYNAMIC=1;this.BUFFER_STREAM=2;this.POINTS=0;this.LINES=1;this.LINE_LOOP=2;this.LINE_STRIP=3;this.TRIANGLES=4;this.TRIANGLE_STRIP=5;this.TRIANGLE_FAN=6;this.BYTE=5120;this.UNSIGNED_BYTE=5121;this.SHORT=5122;this.UNSIGNED_SHORT=
5123;this.INT=5124;this.UNSIGNED_INT=5125;this.FLOAT=5126;this.VS_ELEMENT_FLOAT4=4;this.VS_ELEMENT_FLOAT3=this.VS_ELEMENT_NORM=this.VS_ELEMENT_POS=3;this.VS_ELEMENT_UV=this.VS_ELEMENT_FLOAT2=2;this.VS_ELEMENT_FLOAT=1;this.MAX_ELEM_TYPES=7;this.BUFFER_STATIC=35040;this.BUFFER_DYNAMIC=35044;this.BUFFER_STREAM=35048;this.MAX_MATERIAL_LIGHTS=4;this.usedTextureUnits=5;this.vpY=this.vpX=0;this.vpWidth=a.width;this.vpHeight=a.height;this.cameraMan=new RDGE.cameraManager;this.buffers=[];this.cullBackFace=
function(){this.ctx.cullFace(this.ctx.Back)};this.cullFrontFace=function(){this.ctx.cullFace(this.ctx.FRONT)};this.disableCulling=function(){this.ctx.disable(this.ctx.CULL_FACE)};this.enableCulling=function(){this.ctx.enable(this.ctx.CULL_FACE)};this.enablePolyOffsetFill=function(){this.ctx.enable(this.ctx.POLYGON_OFFSET_FILL)};this.disablePolyOffsetFill=function(){this.ctx.enable(this.ctx.POLYGON_OFFSET_FILL)};this.enablePointSprites=function(){};this.disablePointSprites=function(){};this.setClearColor=
function(a){this.clearColor=a.slice();this.ctx.clearColor(a[0],a[1],a[2],a[3])};this.setClearFlags=function(a){this.clearFlags=a};this._clear=function(){this.ctx.clear(this.clearFlags)};this.clear=function(a){this.ctx.clear(a)};this.flush=function(){this.ctx.flush()};this.setViewPort=function(a,b,f,g){this.vpX=a;this.vpY=b;this.vpWidth=f;this.vpHeight=g;this.ctx.viewport(this.vpX,this.vpY,this.vpWidth,this.vpHeight)};this.cameraManager=function(){return this.cameraMan};this.textureMap=[];this.rttMap=
[];this.getTextureByName=function(a,b,f){var g=a.split(".")[1],g=g?"":".png",h=this.textureMap[a];void 0===h?(a=RDGE.globals.engine.remapAssetFolder(a),h=this.createTexture(a+g,b,f),this.textureMap[a]=h,h.lookUpName=a,h.previouslyReferenced=!1):h.previouslyReferenced=!0;return h};this.unloadedTextureCount=0;_texparams=function(a,b){this.wrap=a;this.mips=b};this.createTexture=function(a,b,f){var g=this.ctx.createTexture();this.unloadedTextureCount++;void 0===b&&(b="CLAMP");void 0===f&&(f=!0);g&&(g.image=
new Image,g.image.src=a,g.image.context=RDGE.globals.engine.getContext(),g.texparams=new _texparams(b,f),g.image.onload=function(){this.context.ctxStateManager.RDGEInitState.loadTexture(g);this.context.renderer.unloadedTextureCount--;g.callback&&g.callback(g);0>this.context.renderer.unloadedTextureCount&&console.log("more textures loaded then created...")},g.image.onerror=function(){this.context.renderer.unloadedTextureCount--;g.callback&&g.callback(g);0>this.context.renderer.unloadedTextureCount&&
console.log("more textures loaded then created...")});return g};this.commitTexture=function(a){this.ctx.bindTexture(this.ctx.TEXTURE_2D,a);this.ctx.texImage2D(this.ctx.TEXTURE_2D,0,this.ctx.RGBA,this.ctx.RGBA,this.ctx.UNSIGNED_BYTE,a.image);a.texparams.mips&&this.ctx.generateMipmap(this.ctx.TEXTURE_2D);this.ctx.texParameteri(this.ctx.TEXTURE_2D,this.ctx.TEXTURE_MAG_FILTER,this.ctx.LINEAR);this.ctx.texParameteri(this.ctx.TEXTURE_2D,this.ctx.TEXTURE_MIN_FILTER,a.texparams.mips?this.ctx.LINEAR_MIPMAP_LINEAR:
this.ctx.LINEAR);this.ctx.texParameteri(this.ctx.TEXTURE_2D,this.ctx.TEXTURE_WRAP_S,"REPEAT"===a.texparams.wrap?this.ctx.REPEAT:this.ctx.CLAMP_TO_EDGE);this.ctx.texParameteri(this.ctx.TEXTURE_2D,this.ctx.TEXTURE_WRAP_T,"REPEAT"===a.texparams.wrap?this.ctx.REPEAT:this.ctx.CLAMP_TO_EDGE);this.ctx.bindTexture(this.ctx.TEXTURE_2D,null)};this.verify=function(a){var b=this.ctx.getError();0!=b&&window.console.log("GLError ( "+a+") : "+b)};this.createRenderTargetTexture=function(a,b,f,g){var h=this.ctx,l=
h.createFramebuffer();h.bindFramebuffer(h.FRAMEBUFFER,l);l.width=b;l.height=f;b=h.createTexture();h.bindTexture(h.TEXTURE_2D,b);try{h.texImage2D(h.TEXTURE_2D,0,h.RGBA,l.width,l.height,0,h.RGBA,h.UNSIGNED_BYTE,null)}catch(m){f=new WebctxUnsignedByteArray(4*l.width*l.height),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,l.width,l.height,0,h.RGBA,h.UNSIGNED_BYTE,f)}h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.LINEAR);h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,g?h.LINEAR_MIPMAP_NEAREST:h.LINEAR);h.texParameteri(h.TEXTURE_2D,
h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE);h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE);g&&h.generateMipmap(h.TEXTURE_2D);g=h.createRenderbuffer();h.bindRenderbuffer(h.RENDERBUFFER,g);h.renderbufferStorage(h.RENDERBUFFER,h.DEPTH_COMPONENT16,l.width,l.height);h.getError(h.bindFramebuffer(h.FRAMEBUFFER,l));h.getError(h.bindRenderbuffer(h.RENDERBUFFER,g));h.getError(h.renderbufferStorage(h.RENDERBUFFER,h.DEPTH_COMPONENT16,l.width,l.height));h.bindRenderbuffer(h.RENDERBUFFER,null);h.getError(h.framebufferTexture2D(h.FRAMEBUFFER,
h.COLOR_ATTACHMENT0,h.TEXTURE_2D,b,0));h.getError(h.framebufferRenderbuffer(h.FRAMEBUFFER,h.DEPTH_ATTACHMENT,h.RENDERBUFFER,g));h.bindFramebuffer(h.FRAMEBUFFER,null);h.bindTexture(h.TEXTURE_2D,null);h.bindRenderbuffer(h.RENDERBUFFER,null);h.bindFramebuffer(h.FRAMEBUFFER,null);b.id="RT_"+RDGE.nodeIdGen.getId();b.frameBuffer=l;this.textureMap[a]&&window.console.log("Notification: render target: "+a+" has overwritten an existing render target");return this.textureMap[a]=b};this.defaultShaderDefintion=
{shaders:{defaultVShader:"assets/shaders/test_vshader.glsl",defaultFShader:"assets/shaders/test_fshader.glsl"},techniques:{defaultTechnique:[{vshader:"defaultVShader",fshader:"defaultFShader",attributes:{vert:{type:"vec3"},normal:{type:"vec3"},texcoord:{type:"vec2"}},params:{},states:{depthEnable:!0,blendEnable:!1,culling:!0,cullFace:"BACK"}}]}}};
RDGE.rdgeDefaultShaderDefintion={shaders:{defaultVShader:"assets/shaders/Basic.vert.glsl",defaultFShader:"assets/shaders/Basic.frag.glsl"},techniques:{defaultTechnique:[{vshader:"defaultVShader",fshader:"defaultFShader",attributes:{vert:{type:"vec3"},normal:{type:"vec3"},texcoord:{type:"vec2"}},params:{},states:{depthEnable:!0,blendEnable:!1,culling:!0,cullFace:"BACK"}}]}};
RDGE.rdgePrimitiveDefinition=function(){this.type=RDGE.rdgeConstants.TRIANGLE_STRIP;this.vertexDefinition={};this.bufferStreams=[];this.streamUsage=[];this.indexUsage=RDGE.rdgeConstants.BUFFER_STREAM;this.indexBuffer=[];this.setCount=0;this.indexOffsets=[];this.indexCount=this.triCount=this.posCount=0;this.indexElementSize=RDGE.rdgeConstants.UNSIGNED_SHORT;this.bufferHandles=[];this.buffersID=-1;this.indexHandle=null;this.useDoubleBuffer=!1;this.frontBufferIndex=this.doubleBufferOffset=0;this.update=
function(a){if(!this.bufferStreams[a])return null;this.bufferStreams[a].dirty=!0;return this.bufferStreams[a]};this.flip=function(a){if(!0===this.useDoubleBuffer)for(var b=0,c=this.bufferStreams.length;b<c;++b)this.bufferStreams[b].dirty&&(this.bufferStreams[b].dirty=!1,a.updateBuffer(a.buffers[this.buffersID][this.frontBufferIndex*this.doubleBufferOffset+b],this.bufferStreams[b],this.streamUsage[b]),this.frontBufferIndex=1-this.frontBufferIndex)}};RDGE._renderer.prototype._rendererID=0;
RDGE._renderer.prototype.getBufferID=function(){return RDGE._renderer.prototype._rendererID++};RDGE._renderer.prototype.createIndexBufferUINT16=function(a,b){var c=this.ctx.createBuffer();c.type=a.type;this.ctx.bindBuffer(this.ctx.ELEMENT_ARRAY_BUFFER,c);this.ctx.bufferData(this.ctx.ELEMENT_ARRAY_BUFFER,"number"==typeof k?a:new Uint16Array(a),b);return c};
RDGE._renderer.prototype.createIndexBufferUINT8=function(a,b){var c=this.ctx.createBuffer();c.type=a.type;this.ctx.bindBuffer(this.ctx.ELEMENT_ARRAY_BUFFER,c);this.ctx.bufferData(this.ctx.ELEMENT_ARRAY_BUFFER,"number"==typeof k?a:new Uint8Array(a),b);return c};RDGE._renderer.prototype.createBufferFLOAT32=function(a,b){var c=this.ctx.createBuffer();c.type=a.type;this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,c);this.ctx.bufferData(this.ctx.ARRAY_BUFFER,"number"==typeof k?a:new Float32Array(a),b);return c};
RDGE._renderer.prototype.createBufferINT32=function(a,b){var c=this.ctx.createBuffer();c.type=a.type;this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,c);this.ctx.bufferData(this.ctx.ARRAY_BUFFER,"number"==typeof k?a:new Int32Array(a),b);return c};RDGE._renderer.prototype.createBufferINT16=function(a,b){var c=this.ctx.createBuffer();c.type=a.type;this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,c);this.ctx.bufferData(this.ctx.ARRAY_BUFFER,"number"==typeof k?a:new Int16Array(a),b);return c};
RDGE._renderer.prototype.updateBuffer=function(a,b,c,d){this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,a);c===RDGE.rdgeConstants.BUFFER_DYNAMIC?this.ctx.bufferSubData(this.ctx.ARRAY_BUFFER,d||0,new Float32Array(b)):this.ctx.bufferData(this.ctx.ARRAY_BUFFER,new Float32Array(b),c)};RDGE._renderer.prototype.createPrimitive=function(a){if(a.built){if(this.buffers[a.buffersID])return}else a.buffersID=this.getBufferID(),a.built=!0;this.buffers[a.buffersID]=[];this.buffers[a.buffersID].ctxId=this.id;this.updatePrimitive(a)};
RDGE._renderer.prototype.updatePrimitive=function(a){if(a.built){var b=[],c;for(c in a.vertexDefinition){var d=a.vertexDefinition[c];if(!(-1<b.indexOf(d.bufferIndex))&&(b.push(d.bufferIndex),d.debugName=c+" buffer",d.type==this.VS_ELEMENT_POS&&(a.posCount=a.bufferStreams[d.bufferIndex].length,a.positions=a.bufferStreams[d.bufferIndex]),void 0==this.buffers[a.buffersID][d.bufferIndex]?(a.bufferStreams[d.bufferIndex].type=c+" PrimaryBuffer",a.forceVertexCount?(this.buffers[a.buffersID][d.bufferIndex]=
this.createBufferFLOAT32(4*a.forceVertexCount,d.bufferUsage),this.ctx.bufferSubData(this.ctx.ARRAY_BUFFER,0,new Float32Array(a.bufferStreams[d.bufferIndex]),d.bufferUsage)):this.buffers[a.buffersID][d.bufferIndex]=this.createBufferFLOAT32(a.bufferStreams[d.bufferIndex],d.bufferUsage)):(this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this.buffers[a.buffersID][d.bufferIndex]),this.ctx.bufferSubData(this.ctx.ARRAY_BUFFER,0,new Float32Array(a.bufferStreams[d.bufferIndex]),d.bufferUsage)),!0===a.useDoubleBuffer))a.doubleBufferOffset=
a.bufferStreams.length,a.bufferStreams[d.bufferIndex].type=c+" SecondaryBuffer",void 0==this.buffers[a.buffersID][a.doubleBufferOffset+d.bufferIndex]?a.forceVertexCount?(this.buffers[a.buffersID][a.doubleBufferOffset+d.bufferIndex]=this.createBufferFLOAT32(4*a.prim.forceVertexCount,d.bufferUsage),this.ctx.bufferSubData(this.ctx.ARRAY_BUFFER,0,new Float32Array(a.bufferStreams[d.bufferIndex]),d.bufferUsage)):this.buffers[a.buffersID][a.doubleBufferOffset+d.bufferIndex]=this.createBufferFLOAT32(a.bufferStreams[d.bufferIndex],
d.bufferUsage):(this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this.buffers[a.buffersID][a.doubleBufferOffset+d.bufferIndex]),this.ctx.bufferSubData(this.ctx.ARRAY_BUFFER,0,new Float32Array(a.bufferStreams[d.bufferIndex]),d.bufferUsage))}0<a.indexBuffer.length?(b=a.indexBuffer.length,a.indexBuffer.debugName="index Buffer",void 0==this.buffers[a.buffersID].indexHandle?a.forceIndexCount?(this.buffers[a.buffersID].indexHandle=this.createIndexBufferUINT16(2*a.forceIndexCount,a.indexUsage),this.ctx.bufferSubData(this.ctx.ELEMENT_ARRAY_BUFFER,
0,new Float32Array(a.indexBuffer),a.indexUsage)):this.buffers[a.buffersID].indexHandle=this.createIndexBufferUINT16(a.indexBuffer,a.indexUsage):(this.ctx.bindBuffer(this.ctx.ELEMENT_ARRAY_BUFFER,this.buffers[a.buffersID].indexHandle),this.ctx.bufferSubData(this.ctx.ELEMENT_ARRAY_BUFFER,0,new Float32Array(a.indexBuffer),a.indexUsage)),a.indexCount=b,a.triCount=b/3):a.triCount=a.posCount/3}else this.createPrimitive(a)};
RDGE._renderer.prototype.deletePrimitive=function(a){var b=this.buffers[a.buffersID];if(b){var c=this;b.forEach(function(a){c.ctx.deleteBuffer(a)});delete this.buffers[a.buffersID]}};RDGE._renderer.prototype.getPrimitiveBuffer=function(a,b){return this.buffers[a.buffersID][b]};RDGE._renderer.prototype.drawPrimitive=function(a,b,c){a.indexCount?this.drawIndexedPrimitive(a,b,c):this.drawNonIndexedPrimitive(a,b,c);!0===a.useDoubleBuffer&&a.flip(this)};
RDGE._renderer.prototype.drawIndexedPrimitive=function(a,b,c){var d=b=0,f=a.buffersID,g="",h=c.length,l=0,m=a.frontBufferIndex*a.doubleBufferOffset;for(RDGE.globals.engine.getContext();l<h;++l)d=c[l].loc,g=c[l].name,a.vertexDefinition[g]&&(b=a.vertexDefinition[g].bufferIndex,this.ctx.enableVertexAttribArray(d),this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this.buffers[f][m+b]),this.ctx.vertexAttribPointer(d,a.vertexDefinition[g].type,this.FLOAT,!1,0,0));this.ctx.bindBuffer(this.ctx.ELEMENT_ARRAY_BUFFER,
this.buffers[f].indexHandle);this.ctx.drawElements(a.type,a.indexCount,a.indexElementSize,0);for(l=0;l<h;++l)this.ctx.disableVertexAttribArray(c[l].loc)};
RDGE._renderer.prototype.drawIndexedPrimitiveWireFrame=function(a,b,c){for(var d=b=0,f=a.buffersID,g="",h=c.length,l=0,m=a.frontBufferIndex*a.doubleBufferOffset;l<h;++l)d=c[l].loc,g=c[l].name,a.vertexDefinition[g]&&(b=a.vertexDefinition[g].bufferIndex,this.ctx.enableVertexAttribArray(d),this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this.buffers[f][m+b]),this.ctx.vertexAttribPointer(d,a.vertexDefinition[g].type,this.FLOAT,!1,0,0));this.ctx.bindBuffer(this.ctx.ELEMENT_ARRAY_BUFFER,this.buffers[f].indexHandle);
this.ctx.drawElements(this.LINE_LOOP,a.indexCount,a.indexElementSize,0);for(l=0;l<h;++l)this.ctx.disableVertexAttribArray(c[l].loc)};
RDGE._renderer.prototype.drawNonIndexedPrimitive=function(a,b,c){for(var d=b=0,f=a.buffersID,g="",h=c.length,l=0,m=a.frontBufferIndex*a.doubleBufferOffset;l<h;++l)d=c[l].loc,g=c[l].name,b=a.vertexDefinition[g].bufferIndex,a.vertexDefinition[g]&&(this.ctx.enableVertexAttribArray(d),this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this.buffers[f][m+b]),this.ctx.vertexAttribPointer(d,a.vertexDefinition[g].type,this.FLOAT,!1,0,0));this.ctx.drawArrays(a.type,0,a.triCount);for(l=0;l<h;++l)this.ctx.disableVertexAttribArray(c[l].loc)};
RDGE._renderer.prototype.drawIndexedPrimitiveSet=function(a){window.alert("drawIndexedPrimitiveSet is not implemented");for(var b=0;b<a.setCount;++b)this.ctx.drawElements(a.type[b],mesh.numIndices[b],a.indexElementSize[b],a.indexOffsets[b])};RDGE=RDGE||{};RDGE.renderUtils=RDGE.renderUtils||{};
RDGE.renderUtils.createBox=function(){var a=RDGE.globals.engine.getContext().renderer,b=new RDGE.rdgePrimitiveDefinition;b.vertexDefinition={vert:{type:RDGE.rdgeConstants.VS_ELEMENT_POS,bufferIndex:0,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},a_pos:{type:RDGE.rdgeConstants.VS_ELEMENT_POS,bufferIndex:0,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},normal:{type:RDGE.rdgeConstants.VS_ELEMENT_FLOAT3,bufferIndex:1,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},a_nrm:{type:RDGE.rdgeConstants.VS_ELEMENT_FLOAT3,
bufferIndex:1,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},texcoord:{type:RDGE.rdgeConstants.VS_ELEMENT_FLOAT2,bufferIndex:2,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},a_uv:{type:RDGE.rdgeConstants.VS_ELEMENT_FLOAT2,bufferIndex:2,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC}};b.bufferStreams=[[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],[0,0,1,0,0,1,0,0,1,0,
0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],[1,1,0,1,0,0,1,0,0,1,0,0,1,0,1,1,1,0,1,1,0,1,0,0,1,1,0,1,0,0,1,0,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1]];b.streamUsage=[RDGE.rdgeConstants.BUFFER_STATIC,RDGE.rdgeConstants.BUFFER_STATIC,RDGE.rdgeConstants.BUFFER_STATIC];b.indexUsage=RDGE.rdgeConstants.BUFFER_STREAM;b.indexBuffer=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,
23];b.type=RDGE.rdgeConstants.TRIANGLES;a.createPrimitive(b);return b};
RDGE.renderUtils.makeSphere=function(a,b,c,d){for(var f=[],g=[],h=[],l=[],m=0;m<=c;++m)for(var n=0;n<=d;++n){var p=m*Math.PI/c,o=2*n*Math.PI/d,q=Math.sin(p),r=Math.sin(o),p=Math.cos(p),o=Math.cos(o)*q,q=r*q,r=1-n/d,u=m/c;g.push(o);g.push(p);g.push(q);h.push(r);h.push(u);f.push(b*o);f.push(b*p);f.push(b*q)}for(m=0;m<c;++m)for(n=0;n<d;++n)b=m*(d+1)+n,o=b+d+1,l.push(b),l.push(o),l.push(b+1),l.push(o),l.push(o+1),l.push(b+1);c={};c.normalObject=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c.normalObject);
a.bufferData(a.ARRAY_BUFFER,new Float32Array(g),a.STATIC_DRAW);c.texCoordObject=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c.texCoordObject);a.bufferData(a.ARRAY_BUFFER,new Float32Array(h),a.STATIC_DRAW);c.vertexObject=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c.vertexObject);a.bufferData(a.ARRAY_BUFFER,new Float32Array(f),a.STATIC_DRAW);c.numIndices=l.length;c.indexObject=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,c.indexObject);a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array(l),
a.STREAM_DRAW);return c};
RDGE.renderUtils.createPlane=function(a,b,c,d,f,g,h){for(var l=RDGE.globals.engine.getContext().renderer,m=Array(3*a*b),n=Array(3*a*b),p=Array(2*a*b),o=Array(a*b),q=0,r=0,u=0;u<b;++u)for(var s=0;s<a;++s)m[q]=s*c-0.5*(a-1)*c,m[q+1]=0,m[q+2]=u*d-0.5*(b-1)*d,n[q]=h[0],n[q+1]=h[1],n[q+2]=h[2],p[r]=s/a*f,p[r+1]=u/b*g,q+=3,r+=2;for(u=c=0;u<b;++u)for(s=0;s<a;++s)o[c+2]=u*a+s,o[c+1]=u*a+(s+1),o[c]=(u+1)*a+s,o[c+5]=(u+1)*a+s,o[c+4]=u*a+(s+1),o[c+3]=(u+1)*a+(s+1),c+=6;a=new RDGE.rdgePrimitiveDefinition;a.vertexDefinition=
{vert:{type:RDGE.rdgeConstants.VS_ELEMENT_POS,bufferIndex:0,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},a_pos:{type:RDGE.rdgeConstants.VS_ELEMENT_POS,bufferIndex:0,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},normal:{type:RDGE.rdgeConstants.VS_ELEMENT_FLOAT3,bufferIndex:1,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},a_nrm:{type:RDGE.rdgeConstants.VS_ELEMENT_FLOAT3,bufferIndex:1,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},texcoord:{type:RDGE.rdgeConstants.VS_ELEMENT_FLOAT2,bufferIndex:2,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},
a_uv:{type:RDGE.rdgeConstants.VS_ELEMENT_FLOAT2,bufferIndex:2,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC}};a.bufferStreams=[m,n,p];a.streamUsage=[RDGE.rdgeConstants.BUFFER_STATIC,RDGE.rdgeConstants.BUFFER_STATIC,RDGE.rdgeConstants.BUFFER_STATIC];a.indexUsage=RDGE.rdgeConstants.BUFFER_STREAM;a.indexBuffer=o;a.type=RDGE.rdgeConstants.TRIANGLES;l.createPrimitive(a);return a};
RDGE.renderUtils.createCubeVolume=function(a,b,c,d,f,g,h){for(var l=RDGE.globals.engine.getContext().renderer,m=Array(3*a*c*b),n=Array(a*c*b),p=0,o=0,q=0;q<b;++q)for(var r=0;r<c;++r)for(var u=0;u<a;++u)m[p]=u*d-0.5*(a-1)*d,m[p+1]=q*f-0.5*(b-1)*f,m[p+2]=r*g-0.5*(c-1)*g,p+=3,n.push(o++);h&&m.slice();a=new RDGE.rdgePrimitiveDefinition;a.vertexDefinition={a_pos:{type:RDGE.rdgeConstants.VS_ELEMENT_POS,bufferIndex:0,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC}};a.bufferStreams=[m];a.streamUsage=[RDGE.rdgeConstants.BUFFER_DYNAMIC];
a.indexUsage=RDGE.rdgeConstants.BUFFER_STREAM;a.indexBuffer=n;a.type=RDGE.rdgeConstants.POINTS;a.useDoubleBuffer=!0;l.createPrimitive(a);return a};
RDGE.renderUtils.createScreenAlignedQuad=function(){var a=RDGE.globals.engine.getContext().renderer,b=new RDGE.rdgePrimitiveDefinition;b.vertexDefinition={vert:{type:RDGE.rdgeConstants.VS_ELEMENT_POS,bufferIndex:0,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},a_pos:{type:RDGE.rdgeConstants.VS_ELEMENT_POS,bufferIndex:0,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},texcoord:{type:RDGE.rdgeConstants.VS_ELEMENT_FLOAT2,bufferIndex:1,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},a_uv:{type:RDGE.rdgeConstants.VS_ELEMENT_FLOAT2,
bufferIndex:1,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC}};b.bufferStreams=[[-1,1,0,1,1,0,-1,-1,0,-1,-1,0,1,1,0,1,-1,0],[0,0,0,1,1,1,1,1,1,0,0,0]];b.streamUsage=[RDGE.rdgeConstants.BUFFER_STATIC,RDGE.rdgeConstants.BUFFER_STATIC];b.type=RDGE.rdgeConstants.TRIANGLES;a.createPrimitive(b);return b};RDGE=RDGE||{};RDGE.bindMap={};RDGE.bindMap["int"]=function(a,b,c){a.uniform1iv(b,c)};RDGE.bindMap["float"]=function(a,b,c){a.uniform1fv(b,c)};RDGE.bindMap.vec2=function(a,b,c){a.uniform2fv(b,c)};RDGE.bindMap.vec3=function(a,b,c){a.uniform3fv(b,c)};RDGE.bindMap.vec4=function(a,b,c){a.uniform4fv(b,c)};RDGE.bindMap.mat3=function(a,b,c){a.uniformMatrix3fv(b,!1,c)};RDGE.bindMap.mat4=function(a,b,c){a.uniformMatrix4fv(b,!1,c);RDGE.globals.engine.getContext().debug.mat4CallCount++};
RDGE.bindMap.tex2d=function(a,b,c){a.activeTexture(a.TEXTURE0+c[0]);a.bindTexture(a.TEXTURE_2D,c[1]);a.uniform1iv(b,[c[0]])};RDGE.bindMap.texCube=function(a,b,c){a.activeTexture(a.TEXTURE0+c[0]);a.bindTexture(a.TEXTURE_CUBE_MAP,c[1]);a.uniform1iv(b,[c[0]])};RDGE.lightDataMap=[function(a,b,c){a.uniform3fv(b,c.position)},function(a,b,c){a.uniform4fv(b,c.lightDiffuse)},function(a,b,c){a.uniform4fv(b,c.lightAmbient)},function(a,b,c){a.uniform4fv(b,c.lightSpecular)}];RDGE.paramTypeNameMapping=null;
RDGE.jshader=function(a){this.name=a;this.def=null;this.technique={};this.params={};this.compiledShaders={};this.resetRS=!1;this.currentPass=0;this.type_jshader={};this.global={};this.renderer=RDGE.globals.engine.getContext().renderer;this.ctx=this.renderer.ctx;void 0!=a&&null!=a&&(request=new XMLHttpRequest,request.open("GET",a,!1),request.send(null),this.def=JSON.parse(request.responseText));RDGE.paramTypeNameMapping||(a=this.ctx,RDGE.paramTypeNameMapping={},RDGE.paramTypeNameMapping[a.BOOL]="bool",
RDGE.paramTypeNameMapping[a.INT]="int",RDGE.paramTypeNameMapping[a.FLOAT]="float",RDGE.paramTypeNameMapping[a.FLOAT_VEC2]="vec2",RDGE.paramTypeNameMapping[a.FLOAT_VEC3]="vec3",RDGE.paramTypeNameMapping[a.FLOAT_VEC4]="vec4",RDGE.paramTypeNameMapping[a.INT_VEC2]="vec2",RDGE.paramTypeNameMapping[a.INT_VEC3]="vec3",RDGE.paramTypeNameMapping[a.INT_VEC4]="vec4",RDGE.paramTypeNameMapping[a.BOOL_VEC2]="vec2",RDGE.paramTypeNameMapping[a.BOOL_VEC3]="vec3",RDGE.paramTypeNameMapping[a.BOOL_VEC4]="vec4",RDGE.paramTypeNameMapping[a.FLOAT_MAT2]=
"mat2",RDGE.paramTypeNameMapping[a.FLOAT_MAT3]="mat3",RDGE.paramTypeNameMapping[a.FLOAT_MAT4]="mat4",RDGE.paramTypeNameMapping[a.SAMPLER_2D]="tex2d",RDGE.paramTypeNameMapping[a.SAMPLER_CUBE]="texCube");this.bindParameters=function(a){for(var c=a.defParamsList,d=a.lightParams,f=a.lightContext,g=c.length,h=0,l=Array(2),m=0,h=0;h<g;++h)if(c[h].type=="tex2d"||c[h].type=="texCube"){l[0]=m++;l[1]=c[h].data[0];RDGE.bindMap[c[h].type](this.ctx,c[h].loc,l)}else RDGE.bindMap[c[h].type](this.ctx,c[h].loc,RDGE.rdgeGlobalParameters[c[h].name].data);
c=RDGE.rdgeConstants.MAX_MATERIAL_LIGHTS;for(g=0;g<c;++g)if(f[g]!=null&&d[g]){h=d[g].length;for(m=0;m<h;++m)RDGE.lightDataMap[d[g][m].dataIndex](this.ctx,d[g][m].loc,f[g])}m=this.renderer.usedTextureUnits;c=a.paramsList;g=c.length;for(h=0;h<g;++h)if(c[h].type=="tex2d"||c[h].type=="texCube"){l[0]=m++;l[1]=c[h].data[0];RDGE.bindMap[c[h].type](this.ctx,c[h].loc,l)}else RDGE.bindMap[c[h].type](this.ctx,c[h].loc,c[h].data)};createJShaderTexture=function(a,c){var d=null,d=typeof c.data=="string"?a.canvas.renderer.getTextureByName(c.data,
c.wrap,c.repeat,c.mips):a.canvas.renderer.getTextureByName(c.data.lookUpName,c.wrap,c.repeat,c.mips);return[d]};paramType=function(a,c,d,f,g){this.loc=a.getUniformLocation(f,c);this.loc==null&&window.console.log("ctx:"+a.canvas.rdgeid+", technique: "+g+", uniform: "+c+" was not found, jshader param will have no affect");c=d[c];this.type=c.type;if(c.data==void 0)switch(c.type){case "vec4":this.data=RDGE.vec4.zero();break;case "vec3":this.data=RDGE.vec3.zero();break;case "vec2":this.data=RDGE.vec2.zero();
break;case "mat4":this.data=RDGE.mat4.zero();break;case "mat3":this.data=Array(9);break;case "mat2":this.data=[0,0,0,0];break;case "float":this.data=[0];break;case "int":this.data=[0];break;case "tex2d":this.data=[a.canvas.renderer.getTextureByName(RDGE.globals.engine._assetPath+"images/white.png")];break;case "texCube":this.data=[a.canvas.renderer.getTextureByName(RDGE.globals.engine._assetPath+"images/white.png")]}else this.data=c.type=="tex2d"||c.type=="texCube"?createJShaderTexture(a,c):c.data.slice();
this.get=function(){return this.data.slice()};this.set=function(c){if(this.type=="tex2d"||this.type=="texCube"){typeof c=="string"&&(c=a.canvas.renderer.getTextureByName(c));this.data[0]=c}else for(var d=this.data.length,f=0;f<d;++f)this.data[f]=c[f]}};globalParam=function(a,c,d,f){this.type=d.type;this.data=d.data;this.loc=a.getUniformLocation(f,c);if(this.data)this.data=d.type=="tex2d"||d.type=="texCube"?createJShaderTexture(a,d):d.data.slice();else switch(d.type){case "vec4":this.data=RDGE.vec4.zero();
break;case "vec3":this.data=RDGE.vec3.zero();break;case "vec2":this.data=RDGE.vec2.zero();break;case "mat4":this.data=RDGE.mat4.zero();break;case "mat3":this.data=Array(9);break;case "mat2":this.data=[0,0,0,0];break;case "float":this.data=[0];break;case "int":this.data=[0];break;case "tex2d":this.data=[a.canvas.renderer.getTextureByName(RDGE.globals.engine._assetPath+"images/white.png")];break;case "texCube":this.data=[a.canvas.renderer.getTextureByName(RDGE.globals.engine._assetPath+"images/white.png")]}this.get=
function(){return this.data.slice()};this.set=function(c){if(this.type=="tex2d"||this.type=="texCube"){typeof c=="string"&&(c=a.canvas.renderer.getTextureByName(c));this.data[0]=c}else for(var d=this.data.length,f=0;f<d;++f)this.data[f]=c[f]}};this.init=function(){var a=this.def.techniques,c=null;for(t in a){var c=t,d=a[t];this[t]={passes:[]};for(var f=d.length,g=0;g<f;){var h=this.buildProgram(d[g]);this.ctx.useProgram(h);var l=this.ctx.getProgramParameter(h,this.ctx.ACTIVE_ATTRIBUTES);for(j=0;j<
l;++j){var m=this.ctx.getActiveAttrib(h,j);d[g].attributes[m.name]={type:RDGE.paramTypeNameMapping[m.type]}}l=this.ctx.getProgramParameter(h,this.ctx.ACTIVE_UNIFORMS);for(j=0;j<l;++j){m=this.ctx.getActiveUniform(h,j);RDGE.rdgeGlobalParameters[m.name]||(d[g].params[m.name]={type:RDGE.paramTypeNameMapping[m.type]})}h.ctxId=this.ctx.canvas.rdgeid;if(h)this[t].passes.push({program:h,params:{},defParams:{},states:d[g].states,attributes:d[g].attribPairs});else{this.renderer.console.log("Build errors found in technique: "+
t);this.def[t]=null;break}for(var n in RDGE.rdgeGlobalParameters){l=new globalParam(this.ctx,n,RDGE.rdgeGlobalParameters[n],h);if(l.loc!=null){l.loc.ctxID=this.ctx.canvas.rdgeid;this[t].passes[g].defParams[n]=l;this.global[n]=l}}this[t].passes[g].lightParams=[null,null,null,null];this[t].passes[g].lightContext=[null,null,null,null];if(!this[t].passes[g].paramsList)this[t].passes[g].paramsList=[];l=RDGE.rdgeConstants.MAX_MATERIAL_LIGHTS;for(m=0;m<l;++m){this[t].passes[g].lightParams[m]=null;var p=
0,o;for(o in RDGE.globals.engine.lightManager.lightUniforms[m]){loc=this.ctx.getUniformLocation(h,o);if(loc!=null){this[t].passes[g].lightParams[m]||(this[t].passes[g].lightParams[m]=[]);this[t].passes[g].lightParams[m].push({loc:loc,name:o,dataIndex:p})}p++}}for(n in d[g].params)if(typeof d[g].params[n]!="string"){l=new paramType(this.ctx,n,d[g].params,h,t);this[t].passes[g].params[n]=l;this[t][n]=l}for(n in d[g].params)typeof d[g].params[n]=="string"&&(this[t][n]=this[t].passes[g].params[n]);g++}}for(t in a){f=
this[t].passes.length;for(g=0;g<f;++g){this[t].passes[g].defParamsList=[];for(n in this[t].passes[g].params){d=this[t].passes[g].params[n];d.name=n;this[t].passes[g].paramsList.push(d)}for(n in this[t].passes[g].defParams){d=this[t].passes[g].defParams[n];d.name=n;this[t].passes[g].defParamsList.push(d)}}}this.setTechnique(c)};this.initLocalParameter=function(a,c){var d=this.def.techniques;for(t in d)for(var f=d[t],g=f.length,h=0;h<g;){var l=new paramType(this.ctx,a,c,f[h].program,t);if(l){f[h][a]=
l;if(!f[h].paramsList)f[h].paramsList=[];f[h].paramsList.push(l)}h++}};this.buildShader=function(a,c){var c="#define PC\n"+c,d=this.ctx.createShader(a);if(d==null){this.renderer.console.log("*** Error: unable to create shader '"+a+"'");return null}this.ctx.shaderSource(d,c);this.ctx.compileShader(d);if(!this.ctx.getShaderParameter(d,this.ctx.COMPILE_STATUS)){var f=this.ctx.getShaderInfoLog(d);window.console.error("*** Error compiling shader '"+a+"':"+f);this.ctx.deleteShader(d);return null}return d};
this.buildProgram=function(a){window.console.log("building shader pair: <"+a.vshader+", "+a.fshader+">");var c=RDGE.globals.engine.remapAssetFolder(this.def.shaders[a.vshader]),d=RDGE.globals.engine.remapAssetFolder(this.def.shaders[a.fshader]);this.ctx.useProgram(null);var f=null,g=null;if(c.indexOf("{")!=-1)g=c;else{g=new XMLHttpRequest;g.open("GET",c,false);g.send(null);g=g.responseText}f=this.buildShader(this.ctx.VERTEX_SHADER,g);g=null;if(c.indexOf("{")!=-1)g=d;else{g=new XMLHttpRequest;g.open("GET",
d,false);g.send(null);g=g.responseText}g=this.buildShader(this.ctx.FRAGMENT_SHADER,g);if(!f||!g)return null;this.compiledShaders[a.vshader]=f;this.compiledShaders[a.fshader]=g;c=this.ctx.createProgram();if(!c)return null;this.ctx.attachShader(c,f);this.ctx.attachShader(c,g);d=0;a.attribPairs=[];for(var h in a.attributes){a.attribPairs.push({loc:d,name:h});this.ctx.bindAttribLocation(c,d++,h)}this.ctx.linkProgram(c);if(!this.ctx.getProgramParameter(c,this.ctx.LINK_STATUS)){a=this.ctx.getProgramInfoLog(c);
window.console.log("Error in program linking:"+a);this.ctx.deleteProgram(c);this.ctx.deleteProgram(g);this.ctx.deleteProgram(f);return null}return c};this.setLightContext=function(a){for(t in this.technique)for(var c=this.technique.passes.length,d=0;d<c;++d)this.technique.passes[d].lightContext=a.slice()};this.setTextureContext=function(a){for(var c=this.technique.passes.length,d=null,f=0,g=a.length;f<g;++f)for(var h=0;h<c;++h){d=a[f];this.technique.passes[h].defParams[d.name]&&this.technique.passes[h].defParams[d.name].set(d.handle);
this.technique.passes[h].params[d.name]&&this.technique.passes[h].params[d.name].set(d.data[0])}};this.setTechnique=function(a){if(this[a]!=void 0){this.technique=this[a];return true}this.ctx.console.log("Failed to set technique:"+a);return false};this.beginRenderState=function(a){var c=this.technique.passes[a].states;if(c!=void 0){if(c.depthEnable!=void 0?c.depthEnable:1){c.depthFunc&&this.ctx.depthFunc(this.ctx[c.depthFunc]);if(c.offset){this.ctx.enable(this.ctx.POLYGON_OFFSET_FILL);this.ctx.polygonOffset(c.offset[0],
c.offset[1])}c.depthWrite&&this.ctx.depthMask(c.depthWrite);c.depthRangeMin&&this.ctx.depthRange(c.depthRangeMin);c.depthRangeMax&&this.ctx.depthRange(c.depthRangeMax)}else{this.ctx.disable(this.ctx.DEPTH_TEST);this.ctx.depthFunc(this.ctx[c.depthFunc]);this.ctx.depthMask(true)}if(c.blendEnable!=void 0&&c.blendEnable){var d=c.srcBlend!=void 0?c.srcBlend:"ONE",f=c.dstBlend!=void 0?c.dstBlend:"ZERO";this.ctx.enable(this.ctx.BLEND);this.ctx.blendFunc(this.ctx[d],this.ctx[f])}c.culling&&(c.culling?this.ctx.enable(this.ctx.CULL_FACE):
this.ctx.disable(this.ctx.CULL_FACE));c.cullFace&&this.ctx.cullFace(this.ctx[c.cullFace]);c.pointsprite&&(c.pointsprite===true?this.renderer.enablePointSprites():this.renderer.disablePointSprites());this.resetRS=this.technique.passes[a].states.reset==void 0||this.technique.passes[a].states.reset==true}};this.endRenderState=function(){var a=this.ctx;if(this.resetRS){a.enable(this.ctx.DEPTH_TEST);a.disable(this.ctx.BLEND);a.depthFunc(this.ctx.LESS);a.disable(this.ctx.POLYGON_OFFSET_FILL);a.disable(this.ctx.CULL_FACE)}};
this.begin=function(){this.currentPass=null;return this.def==null||this.technique==null?0:this.technique.passes.length};this.beginPass=function(a){this.currentPass=this.technique.passes[a];this.ctx.useProgram(this.currentPass.program);this.bindParameters(this.currentPass);this.beginRenderState(a);return this.currentPass};this.endPass=function(){this.endRenderState();this.ctx.useProgram(null)};this.end=function(){};this.exportShader=function(){for(t in this.def.techniques)for(var a=this[t].passes.length,
c=0;c<a;++c){this[t].passes[c].paramsList=[];this[t].passes[c].defParamsList=[];for(var d in this[t].passes[c].params){var f=this.def.techniques[t][c];if(f&&this[t].passes[c].params[d].type!="tex2d"&&this[t].passes[c].params[d]!="texCube")f.params[d].data=this[t].passes[c].params[d].data}}return JSON.stringify(this.def)}};RDGE=RDGE||{};RDGE.jpassGeoSet={BACKGROUND:1,OPAQUE:2,TRANSPARENT:4,ADDITIVE:8,TRANSLUCENT:16,FOREGROUND:32,ALL:127,SCREEN_QUAD:128,SHADOW:256,MAXSETS:9};
RDGE._jpassBaseClass=function(){this.context=RDGE.globals.engine.getContext();this.renderer=RDGE.globals.engine.getContext().renderer;this.sortCats=RDGE.rdgeConstants.categoryEnumeration;this.bucketCount=RDGE.rdgeConstants.categoryEnumeration.MAX_CAT;this.renderOrder=[];this.renderOrder[this.sortCats.BACKGROUND]=0;this.renderOrder[this.sortCats.OPAQUE]=1;this.renderOrder[this.sortCats.TRANSPARENT]=2;this.renderOrder[this.sortCats.ADDITIVE]=3;this.renderOrder[this.sortCats.TRANSLUCENT]=4;this.renderOrder[this.sortCats.FOREGROUND]=
5;this.name="renderPass_"+RDGE.nodeIdGen.getId();this.visibility=1;this.onHide=function(){};this.hidePass=function(){this.onHide();for(var a=0,b=this.children.length;a<b;++a)this.children[a].hidePass()};this.defaultTargetOut={};this.outputs=[];this.dirty=!1;this.outputIndex=0;this.inputs=[];this.textures=[];this.frustum_culling="enable";this.clearColor=this.clear=null;this.renderList=[];this.children=[];this.technique=this.shader=null;this.geometrySet="SCREEN_QUAD";this.camera=null;this.init=function(){};
this.insertChildPass=function(a){this.children[a.name]=a};this.process=function(){var a,b,c,d,f,g,h,l=0,m=0,n=g=0,p=RDGE.globals.engine.getContext().renderer;this.bindOutput();this.preRender();var o=p.cameraManager().getActiveCamera();this.technique&&this.shader.setTechnique(this.technique);p.projectionMatrix=o.proj;RDGE.rdgeGlobalParameters.u_inv_viewport_width.set([1/p.vpWidth]);RDGE.rdgeGlobalParameters.u_inv_viewport_height.set([1/p.vpHeight]);RDGE.rdgeGlobalParameters.u_farZ.set([o.zFar()]);
RDGE.rdgeGlobalParameters.u_projMatrix.set(p.projectionMatrix);for(var q=0,r=this.renderList.length;q<r;++q){c=this.renderList[q].length;for(l=0;l<c;++l)if(f=this.renderList[q][l].node,f.world){a=this.renderList[q][l].context;b=this.shader?this.shader:a.shaderProg;p.mvMatrix=RDGE.mat4.mul4x3(f.world,o.view);p.invMvMatrix=RDGE.mat4.inverse(p.mvMatrix);p.normalMatrix=RDGE.mat4.transpose(p.invMvMatrix);RDGE.rdgeGlobalParameters.u_mvMatrix.set(p.mvMatrix);RDGE.rdgeGlobalParameters.u_normalMatrix.set(p.normalMatrix);
RDGE.rdgeGlobalParameters.u_worldMatrix.set(f.world);RDGE.rdgeGlobalParameters.u_viewMatrix.set(o.view);RDGE.rdgeGlobalParameters.u_invViewMatrix.set(RDGE.mat4.inverse(o.view));RDGE.rdgeGlobalParameters.u_invMvMatrix.set(p.invMvMatrix);d=a.uniforms.length;for(g=0;g<d;++g)RDGE.rdgeGlobalParameters[a.uniforms[g].name].set(a.uniforms[g].value);this.updateTextureContext(a.textureList);b.setLightContext(a.lights);b.setTextureContext(a.textureList);a=b.begin();for(n=0;n<a;++n){d=b.beginPass(n);h=f.meshes.length;
for(m=0;m<h;++m)(g=RDGE.globals.meshMan.getModelByName(f.meshes[m].mesh.name))&&p.drawPrimitive(g.primitive,d.program,d.attributes);b.endPass();this.onPassEnd()}b.end()}}this.postRender();this.unbindOutput()};this.preRender=function(){};this.postRender=function(){};this.onPassEnd=function(){this.outputIndex+1<this.outputs.length&&++this.outputIndex};this.setRenderList=function(a){this.renderList=a};this.setInputs=function(a){this.inputs=a.slice()};this.updateTextureContext=function(a){for(var b=this.inputs.slice(),
c=0;c<this.inputs.length;++c)a.push(b[c]);for(c=0;c<this.textures.length;++c)this.textures[c].enabled&&a.push(this.textures[c])};this.bindOutput=function(){this.outputIndex=0;if(this.outputs[this.outputIndex]){this.dirty=!0;var a=null,b=this.outputs[this.outputIndex].data[0].frameBuffer;this.renderer.ctx.bindFramebuffer(this.renderer.ctx.FRAMEBUFFER,b);this.renderer.ctx.viewport(0,0,b.width,b.height);this.clearColor&&(a=this.renderer.clearColor,this.renderer.setClearColor(this.clearColor));this.clear?
this.renderer.clear(this.clear):this.renderer._clear();this.clearColor&&this.renderer.setClearColor(a)}};this.unbindOutput=function(){this.dirty&&(this.dirty=!1,this.renderer.ctx.bindFramebuffer(this.renderer.ctx.FRAMEBUFFER,null),this.renderer.setViewPort(0,0,this.renderer.vpWidth,this.renderer.vpHeight))}};
RDGE.jpass=function(a){this.inheritedFrom=RDGE._jpassBaseClass;this.inheritedFrom();for(var b in a)if(this[b]=a[b],"children"==b)for(var c=this[b].length,d=0;d<c;++d)this[b][d]=new RDGE.jpass(this[b][d]);else if("inputs"==b||"outputs"==b){this[b].slice()||(this[b]=[this[b]]);c=this[b].length;for(d=0;d<c;++d)if(this[b][d].data||(this[b][d].data="target"==this[b][d].type?[this.renderer.createRenderTargetTexture(this[b][d].name,this[b][d].width,this[b][d].height,this[b][d].mips)]:[null]),!this[b][d].handle)this[b][d].handle=
this[b][d].data[0]}else if("renderList"==b){c=Array(RDGE.rdgeConstants.categoryEnumeration.MAX_CAT);c[RDGE.rdgeConstants.categoryEnumeration.BACKGROUND]=[];c[RDGE.rdgeConstants.categoryEnumeration.OPAQUE]=[];c[RDGE.rdgeConstants.categoryEnumeration.TRANSPARENT]=[];c[RDGE.rdgeConstants.categoryEnumeration.ADDITIVE]=[];c[RDGE.rdgeConstants.categoryEnumeration.TRANSLUCENT]=[];c[RDGE.rdgeConstants.categoryEnumeration.FOREGROUND]=[];for(var f in this[b])for(var g=RDGE.rdgeConstants.categoryEnumeration[f],
h=this[b][f].length,d=0;d<h;++d)c[g].push(this[b][f][d]);this[b]=c}else if("shader"==b)"string"==typeof this[b]?this.shader=new RDGE.jshader(this[b]):(d=new RDGE.jshader,d.def=this[b],d.init(),this[b]=d);else if("geometrySet"==b){if("string"==typeof this[b]){c=this[b].split("|");for(d=g=0;d<c.length;++d)if(g|=RDGE.jpassGeoSet[c[d]],"SCREEN_QUAD"===c[d]){this[b]=RDGE.jpassGeoSet[c[d]];this.renderList[0]=[new renderObject(RDGE.createScreenQuadNode())];break}this[b]=g}}else if("textures"==b){d=0;for(h=
this[b].length;d<h;++d)"string"==typeof this[b][d].data?(this[b][d].name=this[b][d].data,this[b][d].data=[this[b][d].data],this[b][d].enabled=!0):this[b][d].name=this.renderer.getTextureByName(this[b][d].data[0].lookUpName)}this.init()};
RDGE.jpassGraph=function(a){this.root=null;a&&"string"==typeof a||(this.root=a?new RDGE.jpass(a):new RDGE.jpass({}));this.insert=this.find=null;this.OPAQUE=RDGE.rdgeConstants.categoryEnumeration.OPAQUE;this.setPassRoot=function(a){this.root=a};this._initHelper=function(a){if(a){this[a.name]=a;for(var b in a.children)this._initHelper(a.children[b])}};this._initHelper(this.root);this.insertAsChild=function(a,b){this.find=a;this.insert=b;this[b.name]=b;this._insertHelper(this.root);this.insert=this.find=
null};this._insertHelper=function(a){if(!a)return false;if(a.name==this.find){a.insertChildPass(this.insert);return true}for(var b in a.children)if(this._insertHelper(a.children[b]))break;return true};this.geoSetMap=[];var a=0,b;for(b in RDGE.jpassGeoSet)this.geoSetMap[a++]=RDGE.jpassGeoSet[b];this.render=function(a){var b=a.renderList,f=RDGE.globals.engine.getContext().renderer;this.root.setRenderList(b);for(var g=null,h=[{parent:this.root}],l=null,m=this.geoSetMap.length,n=0,p=0;h.length;){l=h.shift().parent;
if(a.shadowsEnabled&&l.geometrySet===RDGE.jpassGeoSet.SHADOW)l.setRenderList([a.shadowRenderList]);else if(l.geometrySet===RDGE.jpassGeoSet.SCREEN_QUAD)l.renderList[0][0].context.textureList=[];else{g=[];for(n=p=0;n<m;++n)l.geometrySet&this.geoSetMap[n]&&b[n]&&(g[p++]=b[n]);l.setRenderList(g)}l.camera&&f.cameraManager().pushCamera(l.camera);l.process();l.camera&&f.cameraManager().popCamera();for(n=l.children.length-1;n>=0;--n)if(l.children[n].visibility===1){l.children[n].setInputs(l.outputs);h.unshift({parent:l.children[n]})}else if(l.children[n].visibility===
0){l.children[n].hidePass();l.children[n].visibility=2}}}};RDGE=RDGE||{};RDGE.UNIFORMTYPE=function(){this.INT=1008;this.FLOAT=1E3;this.FLOAT2=1001;this.FLOAT3=1002;this.FLOAT4=1003;this.MATRIX3=1004;this.MATRIX4=1005;this.TEXTURE2D=1006;this.TEXTURECUBE=1007};RDGE.RenderObject=function(a){this.shader=a;this.world=null;this.bindings=new RDGE.ShaderData;this.postRenderProc=this.renderProc=this.initRenderProc=null};
RDGE.RenderObject.prototype.addUniform=function(a,b,c){var d=RDGE.globals.gl.getUniformLocation(this.shader,a);d&&(d.debugName=a,this.bindings.uniforms.push(new RDGE.UniformPair(d,b,c)))};RDGE.RenderObject.prototype.addUniformArray=function(a,b,c,d){var f=RDGE.globals.gl.getUniformLocation(this.shader,a);if(f)for(var g=0;g<d;g++)f.debugName=a+g,this.bindings.uniforms.push(new RDGE.UniformPair(f,b[g],c)),f+=b[g].length,b++};
RDGE.RenderObject.prototype.addTexture=function(a,b,c){(a=RDGE.globals.gl.getUniformLocation(this.shader,a))&&this.bindings.textures.push(new RDGE.TexUniform(a,b,c))};RDGE.RenderObject.prototype.addBuffers=function(a,b,c,d,f){void 0==c||void 0==d||void 0==f||null==c||null==d||null==f?this.bindings.buffers.push(new RDGE.BufferAttrib(a,b,null,null,null)):this.bindings.buffers.push(new RDGE.BufferAttrib(a,b,c,d,f))};
RDGE.RenderObject.prototype.bindUniforms=function(){for(var a=0;a<this.bindings.uniforms.length;a++){var b=this.bindings.uniforms[a];switch(b.type){case RDGE.UNIFORMTYPE.INT:RDGE.globals.gl.uniform1i(b.uniform,b.value);break;case RDGE.UNIFORMTYPE.FLOAT:RDGE.globals.gl.uniform1f(b.uniform,b.value);break;case RDGE.UNIFORMTYPE.FLOAT2:RDGE.globals.gl.uniform2fv(b.uniform,b.value);break;case RDGE.UNIFORMTYPE.FLOAT3:RDGE.globals.gl.uniform3fv(b.uniform,b.value);break;case RDGE.UNIFORMTYPE.FLOAT4:RDGE.globals.gl.uniform4fv(b.uniform,
b.value);break;case RDGE.UNIFORMTYPE.MATRIX3:RDGE.globals.gl.uniformMatrix3fv(b.uniform,!1,b.value);break;case RDGE.UNIFORMTYPE.MATRIX4:RDGE.globals.gl.uniformMatrix4fv(b.uniform,!1,b.value)}}};
RDGE.RenderObject.prototype.bindTextures=function(){for(var a=0;a<this.bindings.textures.length;a++){var b=this.bindings.textures[a];switch(b.type){case RDGE.UNIFORMTYPE.TEXTURE2D:RDGE.globals.gl.activeTexture(RDGE.globals.gl.TEXTURE0+b.unit);RDGE.globals.gl.uniform1i(b.uniform,b.unit);break;case RDGE.UNIFORMTYPE.TEXTURECUBE:RDGE.globals.gl.activeTexture(RDGE.globals.gl.TEXTURE0+b.unit),RDGE.globals.gl.uniform1i(b.uniform,b.unit)}}};
RDGE.RenderObject.prototype.bindBuffers=function(){for(var a=0;a<this.bindings.buffers.length;a++){var b=this.bindings.buffers[a];RDGE.globals.gl.bindBuffer(b.glBufferType,b.buffer);null!=b.glAttribType&&(RDGE.globals.gl.enableVertexAttribArray(b.attribIndex),RDGE.globals.gl.vertexAttribPointer(b.attribIndex,b.attribSize,b.glAttribType,!1,0,0))}};
RDGE.RenderObject.prototype.unBindBuffers=function(){for(var a=0;a<this.bindings.buffers.length;a++){var b=this.bindings.buffers[a];null!=b.glAttribType&&RDGE.globals.gl.disableVertexAttribArray(b.attribIndex);RDGE.globals.gl.bindBuffer(b.glBufferType,null)}};RDGE.RenderObject.prototype.initialize=function(a){a(this)};RDGE.RenderObject.prototype.clear=function(){this.world=RDGE.mat4.identity();this.bindings=new RDGE.ShaderData};
RDGE.ShaderData=function(){this.uniforms=[];this.textures=[];this.buffers=[]};RDGE.UniformPair=function(a,b,c){this.uniform=a;this.value=b;this.type=c};RDGE.TexUniform=function(a,b,c){this.uniform=a;this.unit=b;this.type=c};RDGE.BufferAttrib=function(a,b,c,d,f){this.buffer=a;this.glBufferType=b;this.attribSize=c;this.glAttribType=f;this.attribIndex=d};RDGE.setActiveTexture=function(a,b){RDGE.globals.gl.activeTexture(a);RDGE.globals.gl.bindTexture(RDGE.globals.gl.TEXTURE_2D,b)};
RDGE.renderProcDefault=function(a){var b=RDGE.globals.cameraManager.getActiveCamera();RDGE.globals.gl.mvMatrix=b.view;RDGE.globals.gl.mvMatrix=RDGE.mat4.mul(RDGE.globals.gl.mvMatrix,a.parentMesh.world);RDGE.globals.gl.invMvMatrix=RDGE.mat4.inverse(RDGE.globals.gl.mvMatrix);RDGE.globals.gl.normalMatrix=RDGE.mat4.transpose(RDGE.globals.gl.invMvMatrix);RDGE.globals.gl.useProgram(arrayPeek(a.material.shader).shaderHandle);RDGE.globals.gl.activeTexture(RDGE.globals.gl.TEXTURE0);RDGE.globals.gl.bindTexture(RDGE.globals.gl.TEXTURE_2D,
arrayPeek(a.material.tex.set1).diff);RDGE.globals.gl.activeTexture(RDGE.globals.gl.TEXTURE1);RDGE.globals.gl.bindTexture(RDGE.globals.gl.TEXTURE_2D,arrayPeek(a.material.tex.set2).diff);RDGE.globals.gl.activeTexture(RDGE.globals.gl.TEXTURE2);RDGE.globals.gl.bindTexture(RDGE.globals.gl.TEXTURE_2D,arrayPeek(a.material.tex.set1).spec);RDGE.globals.gl.activeTexture(RDGE.globals.gl.TEXTURE3);RDGE.globals.gl.bindTexture(RDGE.globals.gl.TEXTURE_2D,arrayPeek(a.material.tex.set2).spec);RDGE.globals.gl.activeTexture(RDGE.globals.gl.TEXTURE4);
RDGE.globals.gl.bindTexture(RDGE.globals.gl.TEXTURE_2D,arrayPeek(a.material.tex.env));RDGE.globals.gl.activeTexture(RDGE.globals.gl.TEXTURE5);RDGE.globals.gl.bindTexture(RDGE.globals.gl.TEXTURE_2D,arrayPeek(a.material.tex.envDiff));RDGE.setActiveTexture(RDGE.globals.gl.TEXTURE7,RDGE.globals.cam.stickerTexture[0]);RDGE.setActiveTexture(RDGE.globals.gl.TEXTURE8,RDGE.globals.cam.stickerTexture[1]);RDGE.setActiveTexture(RDGE.globals.gl.TEXTURE9,RDGE.globals.cam.stickerTexture[2]);RDGE.setActiveTexture(RDGE.globals.gl.TEXTURE10,
RDGE.globals.cam.stickerTexture[3]);RDGE.setActiveTexture(RDGE.globals.gl.TEXTURE11,RDGE.globals.cam.stickerTexture[4]);RDGE.setActiveTexture(RDGE.globals.gl.TEXTURE12,RDGE.globals.cam.stickerTexture[5]);RDGE.setActiveTexture(RDGE.globals.gl.TEXTURE13,RDGE.globals.cam.stickerTexture[6]);RDGE.setActiveTexture(RDGE.globals.gl.TEXTURE14,RDGE.globals.cam.stickerTexture[7]);for(b=0;8>b;b++)a.parentMesh.stickers[b].load(RDGE.globals.cam.stickers[b]),a.parentMesh.stickersPos[b].setvec(RDGE.globals.cam.stickersPos[b]);
RDGE.setActiveTexture(RDGE.globals.gl.TEXTURE15,arrayPeek(a.material.tex.set1).norm);RDGE.setActiveTexture(RDGE.globals.gl.TEXTURE6,arrayPeek(a.material.tex.set2).norm);arrayPeek(a.material.renderObj).bindBuffers();arrayPeek(a.material.renderObj).bindTextures();arrayPeek(a.material.renderObj).bindUniforms();RDGE.globals.gl.drawElements(RDGE.globals.gl.TRIANGLES,a.size,RDGE.globals.gl.UNSIGNED_SHORT,2*a.indexInBuffer)};
RDGE.renderProcLines=function(a,b,c,d,f){RDGE.globals.gl.useProgram(a.shader);a.lineColor[0]=b;a.lineColor[1]=c;a.lineColor[2]=d;a.lineColor[3]=f;a.bindBuffers();a.bindUniforms();RDGE.globals.gl.drawArrays(RDGE.globals.gl.LINES,0,a.numPoints/3);RDGE.globals.gl.useProgram(null)};
RDGE.renderProcScreenQuad=function(a){RDGE.globals.gl.disable(RDGE.globals.gl.DEPTH_TEST);RDGE.globals.gl.useProgram(a.shader);a.renderObj.bindBuffers();a.renderObj.bindTextures();a.renderObj.bindUniforms();RDGE.globals.gl.bindTexture(RDGE.globals.gl.TEXTURE_2D,a.texture);RDGE.globals.gl.drawArrays(RDGE.globals.gl.TRIANGLES,0,6);RDGE.globals.gl.useProgram(null);RDGE.globals.gl.enable(RDGE.globals.gl.DEPTH_TEST)};
RDGE.postRenderProcDefault=function(a){RDGE.globals.gl.useProgram(arrayPeek(a.material.renderObj).shader);RDGE.globals.gl.useProgram(null)};
RDGE.renderProcDepthMap=function(a){RDGE.globals.gl.useProgram(g_depthMap.shader);arrayPeek(a.material.renderObj).bindBuffers();g_depthMap.bindUniforms();RDGE.globals.gl.enable(RDGE.globals.gl.DEPTH_TEST);RDGE.globals.gl.enable(RDGE.globals.gl.CULL_FACE);RDGE.globals.gl.enable(RDGE.globals.gl.POLYGON_OFFSET_FILL);RDGE.globals.gl.cullFace(RDGE.globals.gl.FRONT);RDGE.globals.gl.drawElements(RDGE.globals.gl.TRIANGLES,a.size,RDGE.globals.gl.UNSIGNED_SHORT,2*a.indexInBuffer);RDGE.globals.gl.cullFace(RDGE.globals.gl.BACK);
RDGE.globals.gl.disable(RDGE.globals.gl.POLYGON_OFFSET_FILL);RDGE.globals.gl.disable(RDGE.globals.gl.CULL_FACE);RDGE.globals.gl.useProgram(null)};
RDGE.renderProcShadowReceiver=function(a){RDGE.globals.gl.bindFramebuffer(RDGE.globals.gl.FRAMEBUFFER,a.shadowTarget.frameBuffer);RDGE.globals.gl.viewport(0,0,a.shadowTarget.frameBuffer.width,a.shadowTarget.frameBuffer.height);RDGE.globals.gl.clearDepth(g_farZ);RDGE.globals.gl.clear(RDGE.globals.gl.COLOR_BUFFER_BIT|RDGE.globals.gl.DEPTH_BUFFER_BIT);RDGE.globals.gl.useProgram(arrayPeek(a.material.shader).shaderHandle);RDGE.globals.gl.activeTexture(RDGE.globals.gl.TEXTURE0);RDGE.globals.gl.bindTexture(RDGE.globals.gl.TEXTURE_2D,
g_depthMap.depthRT);arrayPeek(a.material.renderObj).bindTextures();RDGE.globals.gl.mvMatrix=RDGE.mat4.mul(g_defaultView,a.parentMesh.world);arrayPeek(a.material.renderObj).bindUniforms();error=RDGE.globals.gl.getError();arrayPeek(a.material.renderObj).bindBuffers();RDGE.globals.gl.drawElements(RDGE.globals.gl.TRIANGLES,a.size,RDGE.globals.gl.UNSIGNED_SHORT,2*a.indexInBuffer);RDGE.globals.gl.useProgram(null);RDGE.globals.gl.bindTexture(RDGE.globals.gl.TEXTURE_2D,a.shadowTarget);RDGE.globals.gl.generateMipmap(RDGE.globals.gl.TEXTURE_2D);
RDGE.globals.gl.bindTexture(RDGE.globals.gl.TEXTURE_2D,null);RDGE.globals.gl.bindFramebuffer(RDGE.globals.gl.FRAMEBUFFER,theSceneRTT.frameBuffer);RDGE.globals.gl.viewport(0,0,theSceneRTT.frameBuffer.width,theSceneRTT.frameBuffer.height);RDGE.globals.gl.bindFramebuffer(RDGE.globals.gl.FRAMEBUFFER,a.shadowTargetFinal.frameBuffer);RDGE.globals.gl.viewport(0,0,a.shadowTargetFinal.frameBuffer.width,a.shadowTargetFinal.frameBuffer.height);RDGE.globals.gl.clearDepth(g_farZ);RDGE.globals.gl.clear(RDGE.globals.gl.COLOR_BUFFER_BIT|
RDGE.globals.gl.DEPTH_BUFFER_BIT);a.screenQuad.setTexture(a.shadowTarget);a.screenQuad.render(RDGE.renderProcScreenQuad);RDGE.globals.gl.bindTexture(RDGE.globals.gl.TEXTURE_2D,a.shadowTargetFinal);RDGE.globals.gl.generateMipmap(RDGE.globals.gl.TEXTURE_2D);RDGE.globals.gl.bindTexture(RDGE.globals.gl.TEXTURE_2D,null);RDGE.globals.gl.bindFramebuffer(RDGE.globals.gl.FRAMEBUFFER,theSceneRTT.frameBuffer);RDGE.globals.gl.viewport(0,0,theSceneRTT.frameBuffer.width,theSceneRTT.frameBuffer.height);RDGE.globals.gl.bindFramebuffer(RDGE.globals.gl.FRAMEBUFFER,
a.shadowTarget.frameBuffer);RDGE.globals.gl.viewport(0,0,a.shadowTarget.frameBuffer.width,a.shadowTarget.frameBuffer.height);RDGE.globals.gl.clearDepth(g_farZ);RDGE.globals.gl.clear(RDGE.globals.gl.COLOR_BUFFER_BIT|RDGE.globals.gl.DEPTH_BUFFER_BIT);a.screenQuad.setTexture(a.shadowTargetFinal);a.screenQuad.render(RDGE.renderProcScreenQuad);RDGE.globals.gl.bindTexture(RDGE.globals.gl.TEXTURE_2D,a.shadowTarget);RDGE.globals.gl.generateMipmap(RDGE.globals.gl.TEXTURE_2D);RDGE.globals.gl.bindTexture(RDGE.globals.gl.TEXTURE_2D,
null);RDGE.globals.gl.bindFramebuffer(RDGE.globals.gl.FRAMEBUFFER,theSceneRTT.frameBuffer);RDGE.globals.gl.viewport(0,0,theSceneRTT.frameBuffer.width,theSceneRTT.frameBuffer.height)};
RDGE.renderProcShadowProjection=function(a){RDGE.globals.gl.useProgram(arrayPeek(a.material.shader).shaderHandle);RDGE.globals.gl.getError();RDGE.globals.gl.activeTexture(RDGE.globals.gl.TEXTURE0);RDGE.globals.gl.getError(RDGE.globals.gl.bindTexture(RDGE.globals.gl.TEXTURE_2D,g_depthMap.shadowTarget));RDGE.globals.gl.bindTexture(RDGE.globals.gl.TEXTURE_2D,RDGE.globals.meshMan.getModelByName("backdropReceiver").mesh.shadowToProject);arrayPeek(a.material.renderObj).bindTextures();RDGE.globals.gl.mvMatrix=
RDGE.mat4.mul(g_defaultView,a.parentMesh.world);arrayPeek(a.material.renderObj).bindUniforms();arrayPeek(a.material.renderObj).bindBuffers();RDGE.globals.gl.drawElements(RDGE.globals.gl.TRIANGLES,a.size,RDGE.globals.gl.UNSIGNED_SHORT,2*a.indexInBuffer);RDGE.globals.gl.useProgram(null)};RDGE=RDGE||{};
RDGE.renderInitProcDefault=function(a,b){var c=a.material;c.tex.env.push(arrayPeek(c.shader).envMap);c.tex.envDiff.push(arrayPeek(c.shader).envDiff);gl.useProgram(arrayPeek(c.shader).shaderHandle);arrayPeek(c.renderObj).addTexture("layerMap1",0,RDGE.UNIFORMTYPE.TEXTURE2D);arrayPeek(c.renderObj).addTexture("layerMap2",1,RDGE.UNIFORMTYPE.TEXTURE2D);arrayPeek(c.renderObj).addTexture("colorMeMap1",2,RDGE.UNIFORMTYPE.TEXTURE2D);arrayPeek(c.renderObj).addTexture("colorMeMap2",3,RDGE.UNIFORMTYPE.TEXTURE2D);arrayPeek(c.renderObj).addTexture("envMap",
4,RDGE.UNIFORMTYPE.TEXTURE2D);arrayPeek(c.renderObj).addTexture("envDiff",5,RDGE.UNIFORMTYPE.TEXTURE2D);arrayPeek(c.renderObj).addTexture("normalMap1",15,RDGE.UNIFORMTYPE.TEXTURE2D);arrayPeek(c.renderObj).addTexture("normalMap2",6,RDGE.UNIFORMTYPE.TEXTURE2D);arrayPeek(c.renderObj).addTexture("stickerMap0",7,RDGE.UNIFORMTYPE.TEXTURE2D);arrayPeek(c.renderObj).addTexture("stickerMap1",8,RDGE.UNIFORMTYPE.TEXTURE2D);arrayPeek(c.renderObj).addTexture("stickerMap2",9,RDGE.UNIFORMTYPE.TEXTURE2D);arrayPeek(c.renderObj).addTexture("stickerMap3",
10,RDGE.UNIFORMTYPE.TEXTURE2D);arrayPeek(c.renderObj).addTexture("stickerMap4",11,RDGE.UNIFORMTYPE.TEXTURE2D);arrayPeek(c.renderObj).addTexture("stickerMap5",12,RDGE.UNIFORMTYPE.TEXTURE2D);arrayPeek(c.renderObj).addTexture("stickerMap6",13,RDGE.UNIFORMTYPE.TEXTURE2D);arrayPeek(c.renderObj).addTexture("stickerMap7",14,RDGE.UNIFORMTYPE.TEXTURE2D);arrayPeek(c.renderObj).addUniform("u_normalMatrix",gl.normalMatrix,RDGE.UNIFORMTYPE.MATRIX4);arrayPeek(c.renderObj).addUniform("u_mvMatrix",gl.mvMatrix,RDGE.UNIFORMTYPE.MATRIX4);
arrayPeek(c.renderObj).addUniform("u_invMvMatrix",gl.invMvMatrix,RDGE.UNIFORMTYPE.MATRIX4);arrayPeek(c.renderObj).addUniform("u_stickerMatrix0",a.parentMesh.stickers[0],RDGE.UNIFORMTYPE.MATRIX4);arrayPeek(c.renderObj).addUniform("u_stickerMatrix1",a.parentMesh.stickers[1],RDGE.UNIFORMTYPE.MATRIX4);arrayPeek(c.renderObj).addUniform("u_stickerMatrix2",a.parentMesh.stickers[2],RDGE.UNIFORMTYPE.MATRIX4);arrayPeek(c.renderObj).addUniform("u_stickerMatrix3",a.parentMesh.stickers[3],RDGE.UNIFORMTYPE.MATRIX4);
arrayPeek(c.renderObj).addUniform("u_stickerMatrix4",a.parentMesh.stickers[4],RDGE.UNIFORMTYPE.MATRIX4);arrayPeek(c.renderObj).addUniform("u_stickerMatrix5",a.parentMesh.stickers[5],RDGE.UNIFORMTYPE.MATRIX4);arrayPeek(c.renderObj).addUniform("u_stickerMatrix6",a.parentMesh.stickers[6],RDGE.UNIFORMTYPE.MATRIX4);arrayPeek(c.renderObj).addUniform("u_stickerMatrix7",a.parentMesh.stickers[7],RDGE.UNIFORMTYPE.MATRIX4);arrayPeek(c.renderObj).addUniform("u_stickerPos0",a.parentMesh.stickersPos[0],RDGE.UNIFORMTYPE.FLOAT3);
arrayPeek(c.renderObj).addUniform("u_stickerPos1",a.parentMesh.stickersPos[1],RDGE.UNIFORMTYPE.FLOAT3);arrayPeek(c.renderObj).addUniform("u_stickerPos2",a.parentMesh.stickersPos[2],RDGE.UNIFORMTYPE.FLOAT3);arrayPeek(c.renderObj).addUniform("u_stickerPos3",a.parentMesh.stickersPos[3],RDGE.UNIFORMTYPE.FLOAT3);arrayPeek(c.renderObj).addUniform("u_stickerPos4",a.parentMesh.stickersPos[4],RDGE.UNIFORMTYPE.FLOAT3);arrayPeek(c.renderObj).addUniform("u_stickerPos5",a.parentMesh.stickersPos[5],RDGE.UNIFORMTYPE.FLOAT3);
arrayPeek(c.renderObj).addUniform("u_stickerPos6",a.parentMesh.stickersPos[6],RDGE.UNIFORMTYPE.FLOAT3);arrayPeek(c.renderObj).addUniform("u_stickerPos7",a.parentMesh.stickersPos[7],RDGE.UNIFORMTYPE.FLOAT3);arrayPeek(c.renderObj).addUniform("u_projMatrix",gl.perspectiveMatrix,RDGE.UNIFORMTYPE.MATRIX4);arrayPeek(c.renderObj).addUniform("u_fillColor1",c.fillColor[0],RDGE.UNIFORMTYPE.FLOAT4);arrayPeek(c.renderObj).addUniform("u_fillColor2",c.fillColor[1],RDGE.UNIFORMTYPE.FLOAT4);arrayPeek(c.renderObj).addUniform("u_skinColor",
c.fillColor[2],RDGE.UNIFORMTYPE.FLOAT4);b.vertexObject.name="vertexObject";b.normalObject.name="normalObject";b.texCoordObject.name="texCoordObject";b.indexObject.name="indexObject";arrayPeek(c.renderObj).addBuffers(b.vertexObject,gl.ARRAY_BUFFER,3,0,gl.FLOAT);arrayPeek(c.renderObj).addBuffers(b.normalObject,gl.ARRAY_BUFFER,3,1,gl.FLOAT);arrayPeek(c.renderObj).addBuffers(b.texCoordObject,gl.ARRAY_BUFFER,2,2,gl.FLOAT);arrayPeek(c.renderObj).addBuffers(b.indexObject,gl.ELEMENT_ARRAY_BUFFER);gl.useProgram(null)};
RDGE.renderInitScreenQuad=function(a,b){a.shader=void 0==b?RDGE.createShader(gl,"screenQuad_vShader","screenQuad_fShader",["vert","texcoord"]):b;a.renderObj=new RDGE.RenderObject(a.shader);quadBuf=getScreenAlignedQuad();a.vertBuffer=quadBuf.vertexObject;a.uvBuffer=quadBuf.texCoordObject;a.renderObj.addTexture("basemap",0,RDGE.UNIFORMTYPE.TEXTURE2D);var c=0==RDGE.globals.height?0:1/RDGE.globals.height;a.renderObj.addUniform("u_inv_viewport_width",0==RDGE.globals.width?0:1/RDGE.globals.width,RDGE.UNIFORMTYPE.FLOAT);
a.renderObj.addUniform("u_inv_viewport_height",c,RDGE.UNIFORMTYPE.FLOAT);a.renderObj.addBuffers(a.vertBuffer,gl.ARRAY_BUFFER,3,0,gl.FLOAT);a.renderObj.addBuffers(a.uvBuffer,gl.ARRAY_BUFFER,2,2,gl.FLOAT)};RDGE.renderInitProcDepthMap=function(a){a.shader=g_depthShader.shaderHandle;gl.useProgram(a.shader);a.addUniform("u_mvpLightMatrix",g_mainLight.mvpMatrix,RDGE.UNIFORMTYPE.MATRIX4);a.bindUniforms();gl.useProgram(null)};
RDGE.renderInitShadowReceiver=function(a,b){a.shadowTarget=g_texMan.loadRenderTarget("shadowTarget",256,256);a.shadowTargetFinal=g_texMan.loadRenderTarget("shadowTargetFinal",256,256);a.screenQuad=new RDGE.ScreenQuad(a.shadowTargetFinal);a.screenQuad.initialize(RDGE.renderInitRadialBlur);a.parentMesh.shadowToProject=a.shadowTarget;var c=a.material;c.tex.env.push(arrayPeek(c.shader).envMap);c.tex.envDiff.push(arrayPeek(c.shader).envDiff);gl.useProgram(arrayPeek(c.shader).shaderHandle);arrayPeek(c.renderObj).addTexture("shadowMap",
0,RDGE.UNIFORMTYPE.TEXTURE2D);arrayPeek(c.renderObj).addUniform("u_mvMatrix",gl.mvMatrix,RDGE.UNIFORMTYPE.MATRIX4);arrayPeek(c.renderObj).addUniform("u_projMatrix",gl.perspectiveMatrix,RDGE.UNIFORMTYPE.MATRIX4);arrayPeek(c.renderObj).addUniform("u_shadowBiasMatrix",g_mainLight.shadowMatrix,RDGE.UNIFORMTYPE.MATRIX4);arrayPeek(c.renderObj).addUniform("u_vShadowLight",g_mainLight.view,RDGE.UNIFORMTYPE.MATRIX4);b.vertexObject.name="vertexObject";b.normalObject.name="normalObject";b.texCoordObject.name=
"texCoordObject";b.indexObject.name="indexObject";arrayPeek(c.renderObj).addBuffers(b.vertexObject,gl.ARRAY_BUFFER,3,0,gl.FLOAT);arrayPeek(c.renderObj).addBuffers(b.normalObject,gl.ARRAY_BUFFER,3,1,gl.FLOAT);arrayPeek(c.renderObj).addBuffers(b.texCoordObject,gl.ARRAY_BUFFER,2,2,gl.FLOAT);arrayPeek(c.renderObj).addBuffers(b.indexObject,gl.ELEMENT_ARRAY_BUFFER);gl.useProgram(null)};
RDGE.renderInitShadowProjection=function(a,b){var c=a.material;gl.useProgram(arrayPeek(c.shader).shaderHandle);arrayPeek(c.renderObj).addTexture("shadowMap",0,RDGE.UNIFORMTYPE.TEXTURE2D);arrayPeek(c.renderObj).addUniform("u_mvMatrix",gl.mvMatrix,RDGE.UNIFORMTYPE.MATRIX4);arrayPeek(c.renderObj).addUniform("u_projMatrix",gl.perspectiveMatrix,RDGE.UNIFORMTYPE.MATRIX4);arrayPeek(c.renderObj).addUniform("u_shadowBiasMatrix",g_mainLight.shadowMatrix,RDGE.UNIFORMTYPE.MATRIX4);arrayPeek(c.renderObj).addUniform("u_vShadowLight",
g_mainLight.view,RDGE.UNIFORMTYPE.MATRIX4);b.vertexObject.name="vertexObject";b.normalObject.name="normalObject";b.texCoordObject.name="texCoordObject";b.indexObject.name="indexObject";arrayPeek(c.renderObj).addBuffers(b.vertexObject,gl.ARRAY_BUFFER,3,0,gl.FLOAT);arrayPeek(c.renderObj).addBuffers(b.normalObject,gl.ARRAY_BUFFER,3,1,gl.FLOAT);arrayPeek(c.renderObj).addBuffers(b.texCoordObject,gl.ARRAY_BUFFER,2,2,gl.FLOAT);arrayPeek(c.renderObj).addBuffers(b.indexObject,gl.ELEMENT_ARRAY_BUFFER);gl.useProgram(null)};
RDGE.renderInitRadialBlur=function(a,b){a.shader=void 0==b?RDGE.createShader(gl,"radialBlur_vshader","radialBlur_fshader",["vert","texcoord"]):b;a.renderObj=new RDGE.RenderObject(a.shader);quadBuf=getScreenAlignedQuad();a.vertBuffer=quadBuf.vertexObject;a.uvBuffer=quadBuf.texCoordObject;a.renderObj.addTexture("basemap",0,RDGE.UNIFORMTYPE.TEXTURE2D);a.renderObj.addUniform("u_inv_viewport_width",1/RDGE.globals.width,RDGE.UNIFORMTYPE.FLOAT);a.renderObj.addUniform("u_inv_viewport_height",1/RDGE.globals.height,
RDGE.UNIFORMTYPE.FLOAT);a.renderObj.addUniform("u_sampRadius",5,RDGE.UNIFORMTYPE.FLOAT);a.renderObj.addUniform("u_numSamples",16,RDGE.UNIFORMTYPE.INT);a.renderObj.addUniform("u_mapSize",256,RDGE.UNIFORMTYPE.FLOAT);a.renderObj.addBuffers(a.vertBuffer,gl.ARRAY_BUFFER,3,0,gl.FLOAT);a.renderObj.addBuffers(a.uvBuffer,gl.ARRAY_BUFFER,2,2,gl.FLOAT)};RDGE=RDGE||{};RDGE.Model=function(a,b){this.name=a;this.mesh=b;this.camera=null};RDGE.MeshManager=function(){this.contentUrl="assets_web/mesh/";this.modelMap={};this.readyList=[];this.meshesLoading=!0;this.postMeshLoadCallbackList=[];this.tempSphere=null;this.requestCounter=0};
RDGE.MeshManager.prototype.loadMesh=function(a,b){if(void 0!==this.modelMap[a.name])return this.modelMap[a.name];a.ready=!1;a.addr=this.contentUrl+a.name+"_mesh.json";a.ctxID=RDGE.globals.engine.getContext().renderer.id;b||(null==this.tempSphere&&(this.tempSphere=RDGE.renderUtils.makeSphere(RDGE.globals.engine.getContext().renderer.ctx,25,5,5)),b=this.tempSphere);this.modelMap[a.name]=b;this.requestCounter++;RDGE.requestMesh(a);return null};
RDGE.MeshManager.prototype.deleteMesh=function(a){var b=this.modelMap[a];b&&(RDGE.globals.engine.ctxMan.forEach(function(a){a.renderer.deletePrimitive(b.primitive)}),delete this.modelMap[a])};RDGE.MeshManager.prototype.getModelByName=function(a){return this.modelMap[a]};RDGE.MeshManager.prototype.getModelNames=function(){var a=[],b;for(b in this.modelMap)a.push(this.modelList[b].name);return a};
RDGE.MeshManager.prototype.processMeshData=function(){var a=RDGE.globals.engine.getContext().renderer,b;for(b in this.readyList)if(this.readyList[b]&&this.readyList[b].ready&&a.id===this.readyList[b].ctxID){var c=this.readyList[b];this.readyList.splice(b,1);var d=new RDGE.rdgePrimitiveDefinition;d.vertexDefinition={vert:{type:RDGE.rdgeConstants.VS_ELEMENT_POS,bufferIndex:0,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},a_pos:{type:RDGE.rdgeConstants.VS_ELEMENT_POS,bufferIndex:0,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},
normal:{type:RDGE.rdgeConstants.VS_ELEMENT_FLOAT3,bufferIndex:1,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},a_norm:{type:RDGE.rdgeConstants.VS_ELEMENT_FLOAT3,bufferIndex:1,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},a_normal:{type:RDGE.rdgeConstants.VS_ELEMENT_FLOAT3,bufferIndex:1,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},texcoord:{type:RDGE.rdgeConstants.VS_ELEMENT_FLOAT2,bufferIndex:2,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},a_texcoord:{type:RDGE.rdgeConstants.VS_ELEMENT_FLOAT2,bufferIndex:2,
bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},a_texcoords:{type:RDGE.rdgeConstants.VS_ELEMENT_FLOAT2,bufferIndex:2,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC},a_uv:{type:RDGE.rdgeConstants.VS_ELEMENT_FLOAT2,bufferIndex:2,bufferUsage:RDGE.rdgeConstants.BUFFER_STATIC}};d.bufferStreams=[c.root.data.coords,c.root.data.normals,c.root.data.uvs];d.streamUsage=[RDGE.rdgeConstants.BUFFER_STATIC,RDGE.rdgeConstants.BUFFER_STATIC,RDGE.rdgeConstants.BUFFER_STATIC];d.indexUsage=RDGE.rdgeConstants.BUFFER_STREAM;
d.indexBuffer=c.root.data.indices;a.createPrimitive(d);c.root.primitive=d;c.root.bbox=new RDGE.box;for(var d=c.root.data.coords.length,f=0;f<d-2;)c.root.bbox.addVec3([c.root.data.coords[f+0],c.root.data.coords[f+1],c.root.data.coords[f+2]]),f+=3;this.modelMap[c.root.attribs.name]=c.root;this.requestCounter--;this.onLoaded(c.root.attribs.name)}};RDGE.MeshManager.prototype.isReady=function(){return 0==this.readyList.length};RDGE.MeshManager.prototype.addOnLoadedCallback=function(a){this.postMeshLoadCallbackList.push(a)};
RDGE.MeshManager.prototype.onLoaded=function(a){var b=0;for(b in this.postMeshLoadCallbackList)this.postMeshLoadCallbackList[b].onMeshLoaded(a)};RDGE.MeshManager.prototype.exportJSON=function(){for(var a in this.modelMap)this.modelMap[a].primitive.built=!1;return JSON.stringify(this.modelMap)};
RDGE.MeshManager.prototype.importJSON=function(a){try{var b=JSON.parse(a),c;for(c in b)this.modelMap[c]||(this.modelMap[c]=b[c]);window.console.log("meshes imported")}catch(d){window.console.error("error importing meshes: "+d.description)}};
RDGE.requestMesh=function(a){var b=new XMLHttpRequest;b.mesh=a;b.onreadystatechange=function(){if(4==b.readyState)if(200==b.status||-1==window.location.href.indexOf("http")){var a=eval("("+b.responseText+")");a.ready=!0;a.ctxID=b.mesh.ctxID;RDGE.globals.meshMan.readyList.push(a)}else alert("An error has occured making the request")};b.open("GET",a.addr,!0);b.send(null)};RDGE=RDGE||{};RDGE.Shader=function(a,b,c,d,f){this.name=a;this.shaderHandle=b;this.initRenderProc=d;this.renderProc=c;this.postRenderProc=RDGE.postRenderProcDefault;this.envDiff=this.envMap=f};RDGE.ShaderManager=function(){this.shaderMap=[]};
RDGE.ShaderManager.prototype.addShader=function(a,b,c,d,f,g,h,l){var m=this.shaderMap[a];return void 0==m?(b=RDGE.createShader(RDGE.globals.engine.getContext().renderer.ctx,b,c,d),void 0!=h||void 0!=l?(h=g_texMan.loadMaterial(h),l=g_texMan.loadMaterial(l),this.shaderMap[a]=new RDGE.Shader(a,b,f,g,h),this.shaderMap[a].envDiff=l):(this.shaderMap[a]=new RDGE.Shader(a,b,f,g,null),this.shaderMap[a].envDiff=null),this.shaderMap[a].name=a,this.shaderMap[a]):m};
RDGE.ShaderManager.prototype.getShaderNames=function(){var a=[],b;for(b in this.shaderMap)a.push(this.shaderMap[b].name);return a};RDGE.ShaderManager.prototype.getShaderByName=function(a){a=this.shaderMap[a];return void 0!=a&&null!=a?a:null};
RDGE.ShaderManager.prototype.init=function(){this.addShader("default",vortexVShader,vortexFShader,["vert","normal","texcoord"],RDGE.renderProcDefault,RDGE.renderInitProcDefault,"material_DullPlastic.png","material_DullPlastic.png");this.addShader("barlights",vortexVShader,vortexFShader,["vert","normal","texcoord"],RDGE.renderProcDefault,RDGE.renderInitProcDefault,"material_barlights.png","material_barlightsDull.png");this.addShader("gloss",vortexVShader,vortexFShader,["vert","normal","texcoord"],
RDGE.renderProcDefault,RDGE.renderInitProcDefault,"material_gloss.png","material_glossDull.png");this.addShader("inGlass",vortexVShader,vortexFShader,["vert","normal","texcoord"],RDGE.renderProcDefault,RDGE.renderInitProcDefault,"material_inGlass.png","material_inGlassDull.png");this.addShader("normals",vortexVShader,vortexFShader,["vert","normal","texcoord"],RDGE.renderProcDefault,RDGE.renderInitProcDefault,"material_normal.png","material_normalDull.png");this.addShader("paint",vortexVShader,vortexFShader,
["vert","normal","texcoord"],RDGE.renderProcDefault,RDGE.renderInitProcDefault,"material_paint.png","material_paintDull.png");this.addShader("plastic",vortexVShader,vortexFShader,["vert","normal","texcoord"],RDGE.renderProcDefault,RDGE.renderInitProcDefault,"material_plastic.png","material_plasticDull.png");this.addShader("shadows",vortexVShader,vortexFShader,["vert","normal","texcoord"],RDGE.renderProcDefault,RDGE.renderInitProcDefault,"material_shadows.png","material_shadowsDull.png");this.addShader("skin",
vortexVShader,vortexFShader,["vert","normal","texcoord"],RDGE.renderProcDefault,RDGE.renderInitProcDefault,"material_skin.png","material_skinDull.png");this.addShader("wax",vortexVShader,vortexFShader,["vert","normal","texcoord"],RDGE.renderProcDefault,RDGE.renderInitProcDefault,"material_wax.png","material_waxDull.png");this.addShader("shadowReceiver",shadow_vshader,shadow_fshader,["vert","normal","texcoord"],RDGE.renderProcShadowReceiver,RDGE.renderInitShadowReceiver);this.addShader("shadowProj",
shadowProj_vshader,shadowProj_fshader,["vert","normal","texcoord"],RDGE.renderProcShadowProjection,RDGE.renderInitShadowProjection)};RDGE=RDGE||{};RDGE.ScreenQuad=function(a){this.uvBuffer=this.vertBuffer=null;this.texture=a;this.renderObj=this.shader=null};RDGE.ScreenQuad.prototype.initialize=function(a,b){a(this,b)};RDGE.ScreenQuad.prototype.setTexture=function(a){this.texture=a};RDGE.ScreenQuad.prototype.render=function(a){a(this)};RDGE=RDGE||{};RDGE.box=function(){this.MAX_VAL=1.0E38;this.min=[this.MAX_VAL,this.MAX_VAL,this.MAX_VAL];this.max=[-this.MAX_VAL,-this.MAX_VAL,-this.MAX_VAL]};RDGE.box.prototype.addBox=function(a){this.min=RDGE.vec3.min(this.min,a.min);this.max=RDGE.vec3.max(this.max,a.max)};RDGE.box.prototype.addVec3=function(a){this.min=RDGE.vec3.min(this.min,a);this.max=RDGE.vec3.max(this.max,a)};
RDGE.box.prototype.set=function(a,b){this.min[0]=a[0];this.min[1]=a[1];this.min[2]=a[2];this.max[0]=b[0];this.max[1]=b[1];this.max[2]=b[2]};RDGE.box.prototype.reset=function(){this.min[0]=this.MAX_VAL;this.min[1]=this.MAX_VAL;this.min[2]=this.MAX_VAL;this.max[0]=-this.MAX_VAL;this.max[1]=-this.MAX_VAL;this.max[2]=-this.MAX_VAL};RDGE.box.prototype.getCenter=function(){return[0.5*(this.min[0]+this.max[0]),0.5*(this.min[1]+this.max[1]),0.5*(this.min[2]+this.max[2])]};
RDGE.box.prototype.isVisible=function(a){for(var b=this.getCenter(),c=RDGE.vec3.distance(this.max,b),d=0;d<a.length;){var f=a[d];if(RDGE.vec3.dot(f,b)+f[3]<-c)return!1;d++}return!0};RDGE.box.prototype.isValid=function(){return!(this.min[0]>this.max[0]||this.min[1]>this.max[1]||this.min[2]>this.max[2])};
RDGE.box.prototype.transform=function(a){var b=new RDGE.box,c=[];c.push([this.min[0],this.min[1],this.min[2]]);c.push([this.min[0],this.max[1],this.min[2]]);c.push([this.max[0],this.max[1],this.min[2]]);c.push([this.max[0],this.min[1],this.min[2]]);c.push([this.min[0],this.min[1],this.max[2]]);c.push([this.min[0],this.max[1],this.max[2]]);c.push([this.max[0],this.max[1],this.max[2]]);c.push([this.max[0],this.min[1],this.max[2]]);var d=c.length-1;do b.addVec3(RDGE.mat4.transformPoint(a,c[d]));while(d--);
return b};RDGE=RDGE||{};
RDGE.camera=function(){this.proj=RDGE.mat4.identity();this.view=RDGE.mat4.identity();this.world=RDGE.mat4.identity();this.viewProj=RDGE.mat4.identity();this.invViewProj=RDGE.mat4.identity();this.frustum=[];this.frustumPts=[];this.controller=null;this.setPerspective=function(a,b,c,d){this.ortho=null;this.persp={};this.persp.fov=a;this.persp.aratio=b;this.persp.near=c;this.persp.far=d;this.proj=RDGE.mat4.perspective(a,b,c,d);this.recalc()};this.reset=function(){this.world=RDGE.mat4.identity();this.recalc()};
this.copy=function(a){RDGE.mat4.inplace_copy(this.view,a.view);RDGE.mat4.inplace_copy(this.world,a.world);RDGE.mat4.inplace_copy(this.proj,a.proj);RDGE.mat4.inplace_copy(this.viewProj,a.viewProj);RDGE.mat4.inplace_copy(this.invViewProj,a.invViewProj);this.frustum=a.frustum.slice();this.frustumPts=a.frustumPts.slice()};this.recalc=function(){this.frustum=[];var a=this.viewProj;normalizePlane=function(a){var b=RDGE.vec3.length(a);0.0010<Math.abs(1-b)&&(a[0]/=b,a[1]/=b,a[2]/=b,a[3]/=b);return a};var b=
normalizePlane([a[3]+a[0],a[7]+a[4],a[11]+a[8],a[15]+a[12]]),c=normalizePlane([a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]]),d=normalizePlane([a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]]),f=normalizePlane([a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]]),g=normalizePlane([a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]]),a=normalizePlane([a[3]-a[2],a[7]-a[6],a[11]-a[10],a[15]-a[14]]);this.frustum.push(b);this.frustum.push(c);this.frustum.push(d);this.frustum.push(f);this.frustum.push(g);this.frustum.push(a);
this.frustumPts=[];b=this.viewProj;this.frustumPts.push(RDGE.mat4.transformPoint(b,[-1,-1,-1]));this.frustumPts.push(RDGE.mat4.transformPoint(b,[-1,1,-1]));this.frustumPts.push(RDGE.mat4.transformPoint(b,[1,1,-1]));this.frustumPts.push(RDGE.mat4.transformPoint(b,[1,-1,-1]));this.frustumPts.push(RDGE.mat4.transformPoint(b,[-1,-1,1]));this.frustumPts.push(RDGE.mat4.transformPoint(b,[-1,1,1]));this.frustumPts.push(RDGE.mat4.transformPoint(b,[1,1,1]));this.frustumPts.push(RDGE.mat4.transformPoint(b,[1,
-1,1]))};this.setWorld=function(a){this.world=a;this.view=RDGE.mat4.inverse(a);this.viewProj=RDGE.mat4.mul(this.view,this.proj);this.invViewProj=RDGE.mat4.inverse(this.viewProj);this.recalc()};this.setView=function(a){this.view=a;this.world=RDGE.mat4.inverse(a);this.viewProj=RDGE.mat4.mul(this.view,this.proj);this.invViewProj=RDGE.mat4.inverse(this.viewProj);this.recalc()};this.setLookAt=function(a,b,c){this.setWorld(RDGE.mat4.lookAt(a,b,c))};this.setPerspective=function(a,b,c,d){this.ortho=null;
this.persp={};this.persp.fov=a;this.persp.aratio=b;this.persp.near=c;this.persp.far=d;this.proj=RDGE.mat4.perspective(a,b,c,d);this.recalc()};this.setOrthographic=function(a,b,c,d,f,g){this.persp=null;this.ortho={};this.ortho.left=a;this.ortho.right=b;this.ortho.top=c;this.ortho.bottom=d;this.ortho.near=f;this.ortho.far=g;this.proj=RDGE.mat4.orthographic(a,b,c,d,f,g);this.recalc()};this.onResize=function(a,b,c,d){this.persp&&this.setPerspective(this.persp.fov,c/d,this.persp.near,this.persp.far);this.ortho&&
this.setOrthographic(a,a+c,b,b+d,this.ortho.near,this.ortho.far)};this.zNear=function(){return this.persp?this.persp.near:this.ortho?this.ortho.near:0};this.zFar=function(){return this.persp?this.persp.far:this.ortho?this.ortho.far:0};this.getFTR=function(){var a=0.5*this.persp.fov*Math.PI/180;return[Math.tan(a)*this.persp.far,Math.tan(a/this.persp.aratio)*this.persp.far,this.persp.far]};this.attachCameraToNode=function(a){this.controller=a}};
RDGE.cameraManager=function(){this.stack=[];this.setActiveCamera=function(a){0<this.stack.length&&this.stack.pop();this.stack.push(a)};this.getActiveCamera=function(){return 0<this.stack.length?this.stack[this.stack.length-1]:null};this.pushCamera=function(a){this.stack.push(a)};this.popCamera=function(){return this.stack.pop()};this.onResize=function(a,b,c,d){for(var f=this.stack.length-1;0<=f;)this.stack[f].onResize(a,b,c,d),f--}};RDGE=RDGE||{};
RDGE.shadowLight=function(){this.inheritedFrom=RDGE.camera;this.inheritedFrom();this.invViewMatrix=RDGE.mat4.identity();this.mvpMatrix=RDGE.mat4.identity();this.shadowMatrix=RDGE.mat4.identity();this.shadowMatrix=RDGE.mat4.scale(this.shadowMatrix,[0.5,0.5,0.5]);this.shadowMatrix=RDGE.mat4.translate(this.shadowMatrix,[0.5,0.5,0.5]);this.cameraManager=this.renderer=null;this.shadowBias=0.0195;this.init=function(){this.renderer=RDGE.globals.engine.getContext().renderer;this.cameraManager=this.renderer.cameraManager()};
this.activate=function(){this.cameraManager.pushCamera(this)};this.deactivate=function(){this.cameraManager.popCamera()}};RDGE=RDGE||{};RDGE.loadShader=function(a,b,c){var c="#define PC\n"+c,d=a.createShader(b);if(null==d)return a.console.log("*** Error: unable to create shader '"+b+"'"),null;a.shaderSource(d,c);a.compileShader(d);return!a.getShaderParameter(d,a.COMPILE_STATUS)?(c=a.getShaderInfoLog(d),a.console.log("*** Error compiling shader '"+b+"':"+c),a.deleteShader(d),null):d};RDGE.g_shaderCounter=0;
RDGE.createShader=function(a,b,c,d){var f="",g="";-1!=b.indexOf("{")?f=b:(f=new XMLHttpRequest,f.open("GET",RDGE.globals.engine._assetPath+"shaders/"+b+".glsl",!1),f.send(null),f=f.responseText);-1!=c.indexOf("{")?g=c:(g=new XMLHttpRequest,g.open("GET",RDGE.globals.engine._assetPath+"shaders/"+c+".glsl",!1),g.send(null),g=g.responseText);a.useProgram(null);c=loadShader(a,a.VERTEX_SHADER,f);f=loadShader(a,a.FRAGMENT_SHADER,g);if(!c||!f)return null;g=a.createProgram();if(!g)return null;a.attachShader(g,
c);a.attachShader(g,f);for(var h in d)a.bindAttribLocation(g,h,d[h]);a.linkProgram(g);if(!a.getProgramParameter(g,a.LINK_STATUS))return b=a.getProgramInfoLog(g),a.console.log("Error in program linking:"+b),a.deleteProgram(g),a.deleteProgram(f),a.deleteProgram(c),null;g.shaderID="Shader"+RDGE.g_shaderCounter++;g.vname=b;g.RDGEUniform=new RDGE.RDGEUniformInit;return g};
RDGE.getBaseURL=function(){var a=location.href,a=a.substring(0,a.indexOf("/",14));if(-1!=a.indexOf("http://localhost")){var a=location.href,b=a.indexOf(location.pathname),b=a.indexOf("/",b+1);return a.substr(0,b)+"/"}return a+"/"};RDGE=RDGE||{};
RDGE.stateManager=function(){this.stateStack=[];this.stateTop=void 0;this.RDGERunState=this.RDGEInitState=null;this.currentState=function(){return void 0!=this.stateTop?this.stateStack[this.stateTop]:null};this.PushState=function(a,b){null!=a&&"function"==typeof a.Init&&(void 0!=this.stateTop&&this.stateStack[this.stateTop].LeaveState(),(void 0==b||"noInit"!=b)&&a.Init(),this.stateTop=this.stateStack.push(a)-1)};this.PopState=function(){state=this.stateStack.pop();null!=state&&state.Shutdown();this.stateTop=
0<this.stateTop?this.stateTop-1:0;this.stateStack[this.stateTop]&&this.stateStack[this.stateTop].ReInit()};this.PopAll=function(){for(;null!=this.stateStack[this.stateTop];)this.PopState()};this.tick=function(a){null!=this.stateStack[this.stateTop]&&(this.stateStack[this.stateTop].Update(a),this.stateStack[this.stateTop].Resize(),this.stateStack[this.stateTop].Draw())}};
RDGE.Engine=function(){this._assetPath="assets/";this.sceneMap=[];this.stateTop=void 0;this.lastWindowWidth=window.innerWidth;this.lastWindowHeight=window.innerHeight;this.lightManager=this.defaultContext=null;clearColor=[0,0,0,0];this.initializeComplete=!1;this.RDGECanvas=null;this.canvasToRendererMap={};this.canvasNameToStateStack={};this.canvasCtxList=[];invalidObj=/([()]|function)/;isValidObj=function(a){return invalidObj.test(a)?(window.console.error("invalid object name passed to RDGE, "+a+
" - looks like a function"),!1):!0};contextDef=function(){this.startUpState=this.ctxStateManager=this.renderer=this.id=null;this.sceneGraphMap=[];this.currentScene=null;this.getScene=function(){return this.sceneGraphMap[this.currentScene]};this.debug={frameCounter:0,mat4CallCount:0}};this.ctxMan=contextManager=new RDGE.objectManager;contextManager.currentCtx=null;contextManager._addObject=contextManager.addObject;contextManager.contextMap={};contextManager.addObject=function(a){this.contextMap[a.id]=
a;return this._addObject(a)};contextManager.start=function(){for(var a=this.objects.length,b=0;b<a;++b)contextManager.currentCtx=this.objects[b],this.objects[b].ctxStateManager.PushState(this.objects[b].startUpState)};contextManager.forEach=function(a){for(var b=this.objects.length,c=0;c<b;++c)a(this.objects[c])};this.getContext=function(a){return a?contextManager.contextMap[a]:contextManager.currentCtx};this.clearContext=function(a){contextManager.contextMap[a]=void 0};this.setContext=function(a){contextManager.currentCtx=
contextManager.contextMap[a]};this.tickContext=function(a){var b=contextManager.currentCtx;contextManager.currentCtx=contextManager.contextMap[a];this.objects[i].ctxStateManager.tick(dt);contextManager.currentCtx=b};this.setAssetPath=function(a){this._assetPath=a.slice()};this.remapAssetFolder=function(a){var b=a.indexOf("assets/"),c=a;0<=b&&(c=a.substr(b+7),c=this._assetPath+c);return c}};
RDGE.Engine.prototype.init=function(a,b,c){this.GlInit(c);globalParamFuncSet=function(a){this.data=a.data;this.type=a.type;this.set=function(a){for(var b=this.data?this.data.length:0,c=0;c<b;++c)this.data[c]=a[c]};this.get=function(){return void 0==this.data.length?this.data:this.data.slice()}};this.lightManager=new RDGE.LightManager(RDGE.rdgeGlobalParameters.rdge_lights);for(var d in RDGE.rdgeGlobalParameters)if("rdge_lights"!=d)RDGE.rdgeGlobalParameters[d]=new globalParamFuncSet(RDGE.rdgeGlobalParameters[d]);
else{var a=RDGE.rdgeGlobalParameters[d],f;for(f in a)RDGE.rdgeGlobalParameters[f]=new globalParamFuncSet(a[f])}this.lastWindowWidth=window.innerWidth;this.lastWindowHeight=window.innerHeight;this.defaultContext=new RDGE.RenderContext;this.defaultContext.uniforms=[{name:"u_matAmbient",value:[0.02,0.02,0.02,1]},{name:"u_matDiffuse",value:[1,1,1,1]},{name:"u_matSpecular",value:[1,1,1,1]},{name:"u_matShininess",value:[128]},{name:"u_matEmission",value:[0,0,0,1]}];contextManager.start();this.initializeComplete=
!0};RDGE.Engine.prototype.Shutdown=function(){this.PopAll()};RDGE.Engine.prototype.GlInit=function(){for(var a=document.getElementsByTagName("canvas"),b=a.length,c=0;c<b;++c){var d;"true"==a[c].getAttribute("rdge")&&(d=a[c],this.registerCanvas(d))}};
RDGE.Engine.prototype.loadScene=function(a){var b="assets_web/mesh/"+a+".json";"RunState"==contextManager.currentCtx.stateMan.currentState().name&&(contextManager.currentCtx.stateMan.PushState(contextManager.currentCtx.stateMan.RDGEInitState),contextManager.currentCtx.loadScene(b,a))};RDGE.Engine.prototype.getScene=function(a){return contextManager.currentCtx.sceneGraphMap[a]};
RDGE.Engine.prototype.AddScene=function(a,b){contextManager.currentCtx.sceneGraphMap[a]=b;contextManager.currentCtx.currentScene=a};
RDGE.Engine.prototype.registerCanvas=function(a,b){if(!a||!this.getContext(a.rdgeid)){a.renderer=new RDGE._renderer(a);this.canvasToRendererMap[a.rdgeid]=a;a.renderer.id=a.rdgeid;var c=new RDGE.stateManager,d=new contextDef;d.id=a.rdgeid;d.renderer=a.renderer;d.ctxStateManager=c;d.renderer.mvMatrix=RDGE.mat4.identity();d.renderer.invMvMatrix=RDGE.mat4.identity();d.renderer.projectionMatrix=RDGE.mat4.identity();d.renderer.normalMatrix=RDGE.mat4.identity();a.rdgeCtxHandle=contextManager.addObject(d);
contextManager.currentCtx=d;var f;if(b)f=b;else{var g=a.getAttribute("rdgerun");if(g){if(!isValidObj(g))return;try{f=new (eval(g))}catch(h){window.console.error('The provided RDGE state object "'+g+'" is not defined')}}else f={},RDGE.utilities.validateUserState(f)}g=a.getAttribute("rdgescene");c.RDGEInitState=new RDGE.LoadState(f,d);c.RDGERunState=new RDGE.RunState(f,d);RDGE.utilities.validateUserState(f);g?(c.RDGEInitState.sceneName=g,c.PushState(c.RDGERunState,"noInit"),d.startUpState=c.RDGEInitState):
d.startUpState=c.RDGERunState;this.initializeComplete&&d.ctxStateManager.PushState(d.startUpState)}};RDGE.Engine.prototype.unregisterCanvas=function(a){contextManager.removeObject(a.rdgeCtxHandle);this.clearContext(a.rdgeid)};RDGE.Engine.prototype.getCanvas=function(a){return this.canvasToRendererMap[a]};RDGE=RDGE||{};RDGE.nodeIdGen={};RDGE.nodeIdGen.counter=0;RDGE.nodeIdGen.getId=function(){return"gen_"+RDGE.nodeIdGen.counter++};RDGE.createTransformNode=function(a){node={name:a};node.transformNodeTemplate=new RDGE.transformNodeTemplate(node);return node};RDGE.createMaterialNode=function(a){node={name:a};node.materialNodeTemplate=new RDGE.materialNodeTemplate(node);return node};
RDGE.createMeshNode=function(a,b){meshNode={mesh:{},meshNodeTemplate:{}};var c=RDGE.globals.engine.getContext().renderer;b.built||c.createPrimitive(b);var d=RDGE.globals.meshMan.getModelByName(a);if(!d)return meshNode.mesh.meshNodeTemplate=new RDGE.meshNodeTemplate(meshNode.mesh,b,a),RDGE.globals.meshMan.modelMap[a]=meshNode.mesh,meshNode;c.buffers[d.primitive.buffersID]||c.createPrimitive(d.primitive);meshNode.mesh.meshNodeTemplate=new RDGE.meshNodeTemplate(meshNode.mesh,d.primitive,a);return meshNode};
RDGE.createLightNode=function(a){node={name:a};node.lightNodeTemplate=new RDGE.lightNodeTemplate(node);return node};RDGE.createScreenQuadNode=function(){var a=RDGE.createTransformNode();a.attachMeshNode("screenQuad",RDGE.renderUtils.createScreenAlignedQuad());return a};RDGE.verifyTransformNode=function(a){void 0==a.transformNodeTemplate&&(a.transformNodeTemplate=new RDGE.transformNodeTemplate(a))};RDGE.verifyMaterialNode=function(a){void 0==a.materialNodeTemplate&&(a.materialNodeTemplate=new RDGE.materialNodeTemplate(a))};
RDGE.verifyLightNode=function(a){void 0==a.lightNodeTemplate&&(a.lightNodeTemplate=new RDGE.lightNodeTemplate(a))};
RDGE.transformNodeTemplate=function(a){a.children||(a.children=[]);a.local||(a.local=RDGE.mat4.identity());a.world||(a.world=RDGE.mat4.identity());a.id||(a.id=RDGE.nodeIdGen.getId());a.name||(a.name="xfrmNode"+a.id);a.parent||(a.parent=null);a.meshes||(a.meshes=[]);a.nodeType||(a.nodeType=RDGE.rdgeConstants.nodeType.TRNODE);a.attachMaterial=function(a){RDGE.verifyMaterialNode(a);this.materialNode=a};a.attachMeshNode=function(b,c){typeof b=="string"&&(b=RDGE.createMeshNode(b,c));if(a.materialNode==
void 0)a.materialNode=RDGE.createMaterialNode(a.name+"|defMaterial");a.meshes.push({mesh:{name:b.mesh.attribs.name,id:b.mesh.attribs.id}})};a.insertAsChild=function(a){if(this!=a){RDGE.verifyTransformNode(a);a.parent=this;this.children.push({transformNode:a})}};a.insertAsParent=function(a){if(this!=a){RDGE.verifyTransformNode(a);if(this.parent){for(var c=this.parent.children.length,d=0;d<c;++d)if(this.parent.children[d].transformNode!=void 0){tr=this.parent.children[d].transformNode;if(tr.id==this.id){this.parent.children.splice(d,
1);break}}a.parent=this.parent;this.parent.children.push({transformNode:a});this.parent=a}a.children.push({transformNode:this})}}};
RDGE.materialNodeTemplate=function(a){TEX_DIF=0;TEX_SPEC=1;TEX_NORM=2;TEX_GLOW=3;a.nodeType||(a.nodeType=RDGE.rdgeConstants.nodeType.MATNODE);MATERIAL_MAX_LIGHTS=RDGE.rdgeConstants.MAX_MATERIAL_LIGHTS;a.lightChannel||(a.lightChannel=[null,null,null,null]);a.sortCategory||(a.sortCategory=RDGE.rdgeConstants.categoryEnumeration.OPAQUE);a.id||(a.id=RDGE.nodeIdGen.getId());a.name||(a.name="matNode"+a.id);a.textureList||(RDGE.globals.engine.getContext(),a.textureList=[]);a.uniforms||(a.uniforms=[]);a.setTexture=
function(a,c){var d=RDGE.globals.engine.getContext().renderer;this.textureList[a].handle=d.getTextureByName("assets/images/"+c);this.textureList[a].handle=d.getTextureByName(RDGE.globals.engine._assetPath+"/images/"+c);this.textureList[a].unit=a;this.textureList[a].type=RDGE.UNIFORMTYPE.TEXTURE2D};a.setDiffuseTexture=function(a){this.setTexture(TEX_DIF,a)};a.setSpecTexture=function(a){this.setTexture(TEX_SPEC,a)};a.setNormalTexture=function(a){this.setTexture(TEX_NORM,a)};a.setGlowTexture=function(a){this.setTexture(TEX_GLOW,
a)};a.setUniform=function(a,c){for(var d=this.uniforms.length,f=0;f<d;++f)if(this.uniforms[f].name==a){this.uniforms[f].value=c;return}window.console.log("Could not find uniform: "+a)};a.setShader=function(a){this.shaderProgram=a};a.setSortCategory=function(b){a.sortCategory=b};a.enableLightChannel=function(b,c){RDGE.verifyLightNode(c);if(typeof b=="object")for(var d=b.length,f=c.length!=void 0?c.length:0,g=0;g<d;++g)a.lightChannel[b]=f>0?c[Math.min(g,f-1)]:c;else b<MATERIAL_MAX_LIGHTS&&(a.lightChannel[b]=
c)};a.disableLightChannel=function(b){if(typeof b!="object")for(var c=b.length,d=0;d<c;++d)b[d]<MATERIAL_MAX_LIGHTS&&(a.lightChannel[b[d]]=null);else b<MATERIAL_MAX_LIGHTS&&(a.lightChannel[b]=null)};a.disableAllLights=function(){for(var b=0;b<MATERIAL_MAX_LIGHTS;++b)a.lightChannel[b]=null};a.toJSON=function(){var a={jsonExportName:"materialNode"},c;for(c in this){a[c]=this[c];if(c==="textureList")for(var d=a[c],f=0,g=d.length;f<g;++f)d[f].handle.image=d[f].handle.lookUpName;else c==="shaderProgram"&&
typeof a[c]!="string"&&(a[c]=a[c].exportShader())}return a}};
RDGE.meshNodeTemplate=function(a,b,c){b.built||renderer.createPrimitive(b);a.nodeType||(a.nodeType=RDGE.rdgeConstants.nodeType.MESHNODE);if(!a.attribs){var d=RDGE.nodeIdGen.getId();a.attribs={id:d,indexCount:b.indexCount,name:c,vertCount:b.posCount};a.name=c}a.bbox||(a.bbox=new RDGE.box);a.data=null;a.primitive=b;c=b.posCount;if(0<c){b=b.positions;for(d=0;d<c-2;)a.bbox.addVec3([b[d+0],b[d+1],b[d+2]]),d+=3}else window.console.error("mesh "+a.attribs.name+": bounding volume not created")};
RDGE.lightNodeTemplate=function(a){a.nodeType||(a.nodeType=RDGE.rdgeConstants.nodeType.LIGHTNODE);a.id||(a.id=RDGE.nodeIdGen.getId());a.name||(a.name="light_"+a.id);a.typeName||(a.typeName="dir_light");a.castShadow||(a.castShadow=!1);a.depthMapBias||(a.depthMapBias=0.0179);a.depthMapSize||(a.depthMapSize=1024);a.coneAngle||(a.coneAngle=0.707);a.penumbraAngle||(a.coneAngle=0);a.dropOff||(a.coneAngle=0.025);a.color||(a.color=[1,1,1,1]);a.dir||(a.dir=[1,-1,1]);a.links||(a.links=[]);a.position||(a.position=
[0,0,0]);a.lightDiffuse||(a.lightDiffuse=[1,1,1,1]);a.lightAmbient||(a.lightAmbient=[0.5,0.5,0.5,1]);a.lightSpecular||(a.lightSpecular=[1,1,1,1]);a.setPosition=function(a){for(var c=0;c<3;c++)this.position[c]=a[c]};a.setDiffuseColor=function(a){for(var c=0;c<4;c++)this.lightDiffuse[c]=a[c]};a.setAmbientColor=function(a){for(var c=0;c<4;c++)this.lightAmbient[c]=a[c]};a.setSpecularColor=function(a){for(var c=0;c<4;c++)this.lightSpecular[c]=a[c]}};RDGE=RDGE||{};RDGE.DefaultRender=function(){this.renderer=RDGE.globals.engine.getContext().renderer;this.jshaderProgram=new RDGE.jshader;this.jshaderProgram.def=this.renderer.defaultShaderDefintion;this.jshaderProgram.init()};RDGE.DefaultRender.prototype.process=function(){};function renderObject(a,b,c){this.node=a?a:RDGE.createTransformNode();this.context=b?b:new RDGE.RenderContext;this.parent=c?c:null}
RDGE.SceneGraph=function(a){if(void 0==a||null==a)a={};this.scene=a;this.scene=void 0!=this.scene.root?this.scene.root:{children:[]};this.tick=0;this.lastTick=-1;this.frustumCulling=!0;this.mainLight=new RDGE.shadowLight;this.bckTypes=RDGE.rdgeConstants.categoryEnumeration;this.renderList=Array(this.bckTypes.MAX_CAT);this.renderList[this.bckTypes.BACKGROUND]=[];this.renderList[this.bckTypes.OPAQUE]=[];this.renderList[this.bckTypes.TRANSPARENT]=[];this.renderList[this.bckTypes.ADDITIVE]=[];this.renderList[this.bckTypes.TRANSLUCENT]=
[];this.renderList[this.bckTypes.FOREGROUND]=[];this.shadowRenderList=[];this.shadowCuller=null;this.defaultPassDef={name:"geoPass",geometrySet:"ALL"};this.renderGraph=new RDGE.jpassGraph(this.defaultPassDef);this.animstack=[];this.pushAnim=function(a){this.animstack.push(a)};this.popAnim=function(){this.animstack.pop()};this.playAnim=function(a){this.popAnim();this.pushAnim(a)};this.stopAllAnims=function(){this.animstack=[]};this.jdefShaderProgram=new RDGE.jshader;this.jdefShaderProgram.def=RDGE.rdgeDefaultShaderDefintion;
this.jdefShaderProgram.init();mapping=[];mapping.process=function(a){mapping[a.name]=a};this.Traverse(mapping);this.findNode=function(a){return mapping[a]};findNodeByName=function(a){this.result=null;this.process=function(c){c.name==a&&(this.result=c);return!0};this.init=function(){this.result=null}};buildNodeList=function(a){this.result=[];this.process=function(c){c.name==a&&this.result.push(c);return!0};this.init=function(){this.result=[]}};buildNodeListRegex=function(a){this.result=[];this.process=
function(c){a.test(c.name)&&this.result.push(c);return!0};this.init=function(){this.result=[]}};importScene=function(){this.renderer=RDGE.globals.engine.getContext().renderer;this.process=function(a,c){a.parent=c;if(a.nodeType===RDGE.rdgeConstants.nodeType.TRNODE){a.transformNodeTemplate=void 0;RDGE.verifyTransformNode(a);if(a.materialNode){a.materialNode.materialNodeTemplate=void 0;RDGE.verifyMaterialNode(a.materialNode);if(a.materialNode.shaderProgram){var d=new RDGE.jshader;d.def=JSON.parse(a.materialNode.shaderProgram);
d.init();a.materialNode.shaderProgram=d}for(var f=a.materialNode.textureList,d=0,g=f.length;d<g;++d)f[d].handle=this.renderer.getTextureByName(f[d].handle.lookUpName,f[d].handle.texparams.wrap,f[d].handle.texparams.mips);f=a.materialNode.lightChannel;d=0;for(g=f.length;d<g;++d)f[d]&&(f[d].lightNodeTemplate=void 0,RDGE.verifyLightNode(f[d]))}d=0;for(g=a.meshes.length;d<g;++d)this.renderer.createPrimitive(RDGE.globals.meshMan.getModelByName(a.meshes[d].mesh.name).primitive)}return!0};this.init=function(){this.result=
[]}};__compareLessThan=function(a,c){return a<c};__compareGreaterThan=function(a,c){return a>c};insertIntoSortedList=function(a,c,d){a.push(c);var f=a.length,g=RDGE.globals.engine.getContext().renderer.cameraManager().getActiveCamera();c.depth=RDGE.vec3.dot([g.world[8],g.world[9],g.world[10]],[g.world[12]-c.node.world[12],g.world[13]-c.node.world[13],g.world[14]-c.node.world[14]]);f-=1;for(g=null;0<f;--f)if(d(c.depth,a[f-1].depth))g=a[f-1],a[f-1]=a[f],a[f]=g;else break};shadowCullPass=function(a,
c,d){this.result=[];this.activeCam=a;this.bucketType=c;this.compare=d;this.process=function(a,b){if(a.bbox_world&&a.bbox_world.isValid()&&!a.bbox_world.isVisible(this.activeCam.frustum))return!1;a.materialNode&&a.materialNode.sortCategory==this.bucketType&&insertIntoSortedList(this.result,{context:new RDGE.RenderContext,node:a,parent:b},this.compare);return!0};this.init=function(){this.result=[]}};insertFrontToBack=function(a,c){insertIntoSortedList(a,c,__compareLessThan)};insertBackToFront=function(a,
c){insertIntoSortedList(a,c,__compareGreaterThan)};this.sortFunc=[];this.sortFunc[this.bckTypes.BACKGROUND]=function(a,c){a.push(c)};this.sortFunc[this.bckTypes.OPAQUE]=insertFrontToBack;this.sortFunc[this.bckTypes.TRANSPARENT]=insertBackToFront;this.sortFunc[this.bckTypes.ADDITIVE]=insertBackToFront;this.sortFunc[this.bckTypes.TRANSLUCENT]=insertBackToFront;this.sortFunc[this.bckTypes.FOREGROUND]=function(a,c){a.push(c)}};
RDGE.SceneGraph.prototype.Traverse=function(a,b){null==this.scene?window.console.log("traversing a NULL scene!"):(a.init&&a.init(),b?this._TraverseDFHelper(a,this.scene):this._TraverseBFHelper(a,this.scene))};RDGE.SceneGraph.prototype.addNode=function(a){RDGE.verifyTransformNode(a);this.scene.children.push({transformNode:a})};RDGE.SceneGraph.prototype.insertUnder=function(a,b){RDGE.verifyTransformNode(a);a.insertAsChild(b)};
RDGE.SceneGraph.prototype.insertAbove=function(a,b){RDGE.verifyTransformNode(a);a.insertAsParent(b)};RDGE.SceneGraph.prototype.getNode=function(a){a=new findNodeByName(a);this.Traverse(a,!0);return a.result};RDGE.SceneGraph.prototype.getNodes=function(a){a=new buildNodeList(a);this.Traverse(a,!0);return a.result};RDGE.SceneGraph.prototype.getNodesRegex=function(a){"string"==typeof a&&(a=RegExp(a));a=new buildNodeListRegex(a);this.Traverse(a,!0);return a.result};
RDGE.SceneGraph.prototype._TraverseDFHelper=function(a,b,c){if("undefined"!=b.children){var d=[];for(d.push({node:b,parent:null});0<d.length;){c=d.pop();b=c.node;c=c.parent;if(void 0!==b.transformNode&&(b=b.transformNode,!1===a.process(b,c)))continue;if(void 0!==b.children)for(c=0;c<b.children.length;++c)d.push({node:b.children[c],parent:b})}}};
RDGE.SceneGraph.prototype._TraverseDFPostOrderHelper=function(a,b,c){if("undefined"!=b.children){var d=[];d.push({node:b,parent:null});for(b=d.length;0<b;){for(var b=d.length,c=g.children[b-1],c=void 0==c.children?0:c.children.length,f=0;f<c;++f)d.push({node:g.children[f],parent:g});if(!(0<c)){var c=d.pop(),g=c.node,c=c.parent;void 0!==g.transformNode&&(g=g.transformNode,a.process(g,c))}}}};
RDGE.SceneGraph.prototype.BuildBVHHelper=function(a){if("undefined"!=a.children){a.bbox_world?a.bbox_world.reset():a.bbox_world=new RDGE.box;void 0==a.local&&(a.local=RDGE.mat4.identity());var b=[],c=0;a.id="root";b.push({node:a,xfrm:RDGE.mat4.identity(),parent:null,visited:!1});for(var a=b.length,d=0;0<a;){var a=b.length,d=a-1,f=void 0==b[d].node.transformNode?b[d].node:b[d].node.transformNode,g=b[d].xfrm,h=b[d].parent,d=b[d].visited;void 0==f.id&&(f.id="id"+c);if(!d){if(void 0!==f.local&&(f.bbox_world?
f.bbox_world.reset():f.bbox_world=new RDGE.box,d=this.GetBBoxForNode(f),f.world=RDGE.mat4.mul(f.local,g),d&&(f.bbox_world=d.transform(f.world)),!d||!d.isValid()))g=new RDGE.box,g.set(0,0),f.bbox_world=g;g=void 0==f.children?0:f.children.length;for(d=0;d<g;++d)b.push({node:f.children[d],xfrm:f.world,parent:f,visited:!1});c++;if(0<g)continue}h&&(h.bbox_world&&h.bbox_world.isValid()&&f.bbox_world&&f.bbox_world.isValid())&&h.bbox_world.addBox(f.bbox_world);b.pop();a=b.length;if(0<a&&(void 0==b[a-1].node.transformNode?
b[a-1].node:b[a-1].node.transformNode).id==h.id)b[a-1].visited=!0}}};RDGE.SceneGraph.prototype._TraverseBFHelper=function(a,b){if("undefined"!=b.children){var c=[];for(c.push({node:b,parent:null});0<c.length;){var d=c.shift(),f=d.node,d=d.parent;void 0!==f.transformNode&&(f=f.transformNode,a.process(f,d));if(void 0!==f.children)for(d=0;d<f.children.length;++d)c.push({node:f.children[d],parent:f})}}};
RDGE.SceneGraph.prototype.update=function(a){var b=RDGE.globals.engine.getContext().renderer;RDGE.globals.engine.getContext().debug.mat4CallCount=0;for(var c=this.animstack.length-1;0<=c;)this.animstack[c].step(a),--c;this.BuildBVHHelper(this.scene);RDGE.g_particleSystemManager.update(a);a=b.cameraManager().getActiveCamera();void 0!==a&&(null!=a&&null!=a.controller&&void 0!==a.controller.world)&&a.setWorld(a.controller.world);this.tick++};
RDGE.SceneGraph.prototype.render=function(a,b){if(0!=this.scene.children.length){var c=RDGE.globals.engine.getContext().renderer;RDGE.rdgeGlobalParameters.u_shadowLightFarZ.set([this.mainLight.zFar()]);this.renderList=this._RenderDFHelper(c,a,this.scene,b);this.shadowsEnabled&&(this.Traverse(this.shadowCuller,!0),this.shadowRenderList=this.shadowCuller.result);this.renderGraph.render(this);RDGE.g_particleSystemManager.render()}};
RDGE.SceneGraph.prototype.GetBBoxForNode=function(a){var b=null;if(a.materialNode&&a.materialNode.meshNode){var c=null,c=RDGE.globals.meshMan.getModelByName(a.materialNode.meshNode.mesh.name);null!=c&&(b=c.bbox)}return b};
RDGE.SceneGraph.prototype._RenderDFHelper=function(a,b,c){renderList=[];renderList[this.bckTypes.BACKGROUND]=[];renderList[this.bckTypes.OPAQUE]=[];renderList[this.bckTypes.TRANSPARENT]=[];renderList[this.bckTypes.ADDITIVE]=[];renderList[this.bckTypes.TRANSLUCENT]=[];renderList[this.bckTypes.FOREGROUND]=[];if("undefined"!=c.children){b=[];b.push({node:c,curCtx:RDGE.globals.engine.defaultContext});for(a=a.cameraManager().getActiveCamera();0<b.length;){var d=b.pop(),c=d.node,f=new RDGE.RenderContext;
f.Load(d.curCtx);if(void 0!==c.transformNode){c=c.transformNode;if(void 0!==c.hide&&!0==c.hide)continue;if(this.frustumCulling&&(c.bbox_world&&c.bbox_world.isValid())&&!c.bbox_world.isVisible(a.frustum))continue;f.shaderProg=this.jdefShaderProgram;d=RDGE.rdgeConstants.categoryEnumeration.OPAQUE;if(c.materialNode){d=c.materialNode.sortCategory;void 0!==c.materialNode.shaderProgram&&(f.shaderProg=c.materialNode.shaderProgram);void 0!==c.materialNode.textureList&&(f.textureList=c.materialNode.textureList.slice());
0<c.materialNode.uniforms.length&&(f.uniforms=c.materialNode.uniforms.slice());for(var g=c.materialNode.lightChannel.length,h=0;h<g;++h)c.materialNode.lightChannel[h]&&(f.lights[h]=c.materialNode.lightChannel[h])}this.sortFunc[d](renderList[d],{context:f,node:c,parent:parent})}if(void 0!==c.children){d=c.children.length;for(g=0;g<d;++g)b.push({node:c.children[g],curCtx:f})}}}return renderList};
RDGE.SceneGraph.prototype.enableShadows=function(a){a?(a=RDGE.globals.engine.getContext().renderer,this.shadowCuller=new shadowCullPass(this.mainLight,RDGE.rdgeConstants.categoryEnumeration.OPAQUE,function(a,c){return a<c}),this.mainLight.init(),this.mainLight.setPerspective(45,a.vpWidth/a.vpHeight,1,200),this.mainLight.setLookAt([-60,17,-15],[-5,-5,15],RDGE.vec3.up()),RDGE.rdgeGlobalParameters.u_shadowLightWorld.set(this.mainLight.world),RDGE.rdgeGlobalParameters.u_vShadowLight.set(this.mainLight.view),
a=RDGE.mat4.identity(),a=RDGE.mat4.scale(a,[0.5,0.5,0.5]),a=RDGE.mat4.translate(a,[0.5,0.5,0.5]),RDGE.rdgeGlobalParameters.u_shadowBiasMatrix.set(a),a=RDGE.mat4.mul(this.mainLight.proj,a),a=RDGE.mat4.mul(this.mainLight.view,a),RDGE.rdgeGlobalParameters.u_shadowBPV.set(a),this.shadowsEnabled=!0):(this.mainLight=null,this.shadowsEnabled=!1)};
RDGE.SceneGraph.prototype.exportJSON=function(){objMap=[];var a={scene:null,meshes:null};a.scene=JSON.stringify(this.scene,function(a,c){return"bbox_world"==a?null:"parent"===a?"parent":c});a.meshes=RDGE.globals.meshMan.exportJSON();return a=JSON.stringify(a)};
RDGE.SceneGraph.prototype.importJSON=function(a){try{if(a){var b=JSON.parse(a);b&&(this.scene=JSON.parse(b.scene),b.meshes&&RDGE.globals.meshMan.importJSON(b.meshes),this.scene&&(this.Traverse(new importScene,!0),window.console.log("scene imported")))}}catch(c){window.console.error("error importing JSON scene: "+c.description)}};RDGE=RDGE||{};
RDGE.LightManager=function(a){this.lightUniforms=[[],[],[],[]];for(var b in a)0==b.indexOf("u_light0")?this.lightUniforms[0][b]=b:0==b.indexOf("u_light1")?this.lightUniforms[1][b]=b:0==b.indexOf("u_light2")?this.lightUniforms[2][b]=b:0==b.indexOf("u_light3")&&(this.lightUniforms[3][b]=b);this.lightToMesh=[];this.meshToLight=[];this.dirLights=[];this.pointLights=[];this.spotLights=[];this.ambLights=[];this.unknLights=[];this.typePointLight="point_light";this.typeSpotLight="spot_light";this.typeAmbLight=
"amb_light";this.typeDirLight="dir_light";this.defaultLights=[RDGE.createLightNode("default0"),RDGE.createLightNode("default1"),RDGE.createLightNode("default2"),RDGE.createLightNode("default3")]};
RDGE.LightManager.prototype.setMapping=function(a,b){this.lightToMesh[a.name]=b;for(var c=0;c<b.length;c++){var d=this.meshToLight[b[c]];void 0!==d?d.push(a):(d=[],d.push(a),this.meshToLight[b[c]]=d)}a.typeName==this.typePointLight?this.pointLights.push(a):a.typeName==this.typeSpotLight?this.spotLights.push(a):a.typeName==this.typeAmbLight?this.ambLights.push(a):a.typeName==this.typeDirLight?this.dirLights.push(a):this.unknLights.push(a)};RDGE.LightManager.prototype.getLightsForMesh=function(a){return this.meshToLight[a]};RDGE=RDGE||{};RDGE.g_whiteTex=null;RDGE.g_blackTex=null;RDGE.g_blueTex=null;
RDGE.CreateMasterList=function(){return _MasterUniformList=[{uniform:projMatrixUniform=0,name:"u_projMatrix",type:RDGE.UNIFORMTYPE.MATRIX4,value:new Float32Array(16)},{uniform:mvMatrixUniform=0,name:"u_mvMatrix",type:RDGE.UNIFORMTYPE.MATRIX4,value:new Float32Array(16)},{uniform:normalMatrixUniform=0,name:"u_normalMatrix",type:RDGE.UNIFORMTYPE.MATRIX4,value:new Float32Array(16)},{uniform:worldMatrixUniform=0,name:"u_worldMatrix",type:RDGE.UNIFORMTYPE.MATRIX4,value:new Float32Array(16)},{uniform:lightPos=
0,name:"u_lightPos",type:RDGE.UNIFORMTYPE.FLOAT3,value:new Float32Array(3)},{uniform:lightDiff=0,name:"u_lightDiff",type:RDGE.UNIFORMTYPE.FLOAT4,value:new Float32Array(4)},{uniform:lightAmb=0,name:"u_lightAmb",type:RDGE.UNIFORMTYPE.FLOAT4,value:new Float32Array(4)},{uniform:colMap=0,name:"colMap",type:RDGE.UNIFORMTYPE.TEXTURE2D,value:new Int32Array(1)},{uniform:envMap=0,name:"envMap",type:RDGE.UNIFORMTYPE.TEXTURE2D,value:new Int32Array(1)},{uniform:normalMap=0,name:"normalMap",type:RDGE.UNIFORMTYPE.TEXTURE2D,
value:new Int32Array(1)},{uniform:glowMap=0,name:"glowMap",type:RDGE.UNIFORMTYPE.TEXTURE2D,value:new Int32Array(1)},{uniform:matAmbient=0,name:"u_matAmbient",type:RDGE.UNIFORMTYPE.FLOAT4,value:new Float32Array(4)},{uniform:matDiffuse=0,name:"u_matDiffuse",type:RDGE.UNIFORMTYPE.FLOAT4,value:new Float32Array(4)},{uniform:matSpecular=0,name:"u_matSpecular",type:RDGE.UNIFORMTYPE.FLOAT4,value:new Float32Array(4)},{uniform:matShininess=0,name:"u_matShininess",type:RDGE.UNIFORMTYPE.FLOAT,value:new Float32Array(1)},
{uniform:matEmission=0,name:"u_matEmission",type:RDGE.UNIFORMTYPE.FLOAT,value:new Float32Array(4)},{uniform:frustumFarZ=0,name:"u_frustumFarZ",type:RDGE.UNIFORMTYPE.FLOAT,value:new Float32Array(1)},{uniform:shadowLightWorld=0,name:"u_shadowLightWorld",type:RDGE.UNIFORMTYPE.MATRIX4,value:new Float32Array(16)},{uniform:shadowBiasMatrix=0,name:"u_shadowBiasMatrix",type:RDGE.UNIFORMTYPE.MATRIX4,value:new Float32Array(16)},{uniform:vShadowLight=0,name:"u_vShadowLight",type:RDGE.UNIFORMTYPE.MATRIX4,value:new Float32Array(16)},
{uniform:depthMap=0,name:"depthMap",type:RDGE.UNIFORMTYPE.TEXTURE2D,value:new Int32Array(1)}]};RDGE.RDGEUniformInit=function(){this.uniformList=RDGE.CreateMasterList();this.uniformMap=[];for(var a=0;a<this.uniformList.length;++a)this.uniformMap[this.uniformList[a].name]=this.uniformList[a]};RDGE.RDGEUniformInit.prototype.SetUni=function(a,b){this.uniformMap[a].value=b};RDGE.RDGEUniform=new RDGE.RDGEUniformInit;
RDGE.RenderContext=function(){this.shaderProg=null;this.uniforms=[];this.textureList=[];this.curRenderProc=null;this.light0Color=[1,1,1,0];this.parentID=0;this.world=RDGE.mat4.identity();this.hide=!1;enableNormalMapping=!0;this.lights=[null,null,null,null];this.stateSettings=[]};
RDGE.RenderContext.prototype.Load=function(a){this.shaderProg=a.shaderProg;this.uniforms=a.uniforms.slice();this.textureList=a.textureList.slice();this.stateSettings=a.stateSettings.slice();this.curRenderProc=a.curRenderProc;this.light0Color=a.light0Color.slice();this.parentID=a.parentID;this.world=RDGE.mat4.copy(a.world);this.lights=a.lights.slice();this.cam=this.cam;this.stateSettings=this.stateSettings.slice()};RDGE.__lastInited=[];
RDGE._SetShader=function(a){gl.useProgram(a);if(void 0===RDGE.__lastInited[a.shaderID]){RDGE.__lastInited[a.shaderID]=!0;gl.enableVertexAttribArray(0);gl.enableVertexAttribArray(1);gl.enableVertexAttribArray(2);for(var b=0;b<a.RDGEUniform.uniformList.length;b++){var c=gl.getUniformLocation(a,a.RDGEUniform.uniformList[b].name);c?a.RDGEUniform.uniformList[b].uniform=c:(a.RDGEUniform.uniformList.splice(b,1),b=Math.max(b-1,0))}}};RDGE.RenderContext.prototype.AddStateSetting=function(a){this.stateSettings.push(a)};
RDGE.RenderContext.prototype.Apply=function(){shaderProg=null;null!=this.shaderProg?(RDGE._SetShader(this.shaderProg),shaderProg=this.shaderProg):(RDGE._SetShader(RDGE.globals.engine.defaultContext.shaderProg),shaderProg=RDGE.globals.engine.defaultContext.shaderProg);if(0<this.uniforms.length)for(var a=0;a<this.uniforms.length;++a)shaderProg.RDGEUniform.SetUni(this.uniforms[a].name,this.uniforms[a].value);shaderProg.RDGEUniform.SetUni("u_lightDiff",this.light0Color);for(a=0;a<this.stateSettings.length;++a)this.stateSettings[a]();
this.bindTextures()};
RDGE.RenderContext.prototype.bindTextures=function(){for(var a=RDGE.globals.engine.getContext().renderer.ctx,b=0;b<this.textureList.length;b++){var c=this.textureList[b];switch(c.type){case RDGE.UNIFORMTYPE.TEXTURE2D:a.activeTexture(a.TEXTURE0+c.unit);a.bindTexture(a.TEXTURE_2D,c.handle);break;case RDGE.UNIFORMTYPE.TEXTURECUBE:a.activeTexture(a.TEXTURE0+c.unit),a.bindTexture(a.TEXTURE_CUBE_MAP,c.handle)}}enableNormalMapping||(a.activeTexture(a.TEXTURE2),a.bindTexture(a.TEXTURE_CUBE_MAP,RDGE.g_blueTex),
a.activeTexture(a.TEXTURE2),a.bindTexture(a.TEXTURE_2D,RDGE.g_blueTex))};RDGE.funcmap={};RDGE.funcmap[RDGE.UNIFORMTYPE.INT]=function(a,b){gl.uniform1iv(a,b)};RDGE.funcmap[RDGE.UNIFORMTYPE.FLOAT]=function(a,b){gl.uniform1fv(a,b)};RDGE.funcmap[RDGE.UNIFORMTYPE.FLOAT2]=function(a,b){gl.uniform2fv(a,b)};RDGE.funcmap[RDGE.UNIFORMTYPE.FLOAT3]=function(a,b){gl.uniform3fv(a,b)};RDGE.funcmap[RDGE.UNIFORMTYPE.FLOAT4]=function(a,b){gl.uniform4fv(a,b)};
RDGE.funcmap[RDGE.UNIFORMTYPE.MATRIX3]=function(a,b){gl.uniformMatrix3fv(a,!1,b)};RDGE.funcmap[RDGE.UNIFORMTYPE.MATRIX4]=function(a,b){gl.uniformMatrix4fv(a,!1,b)};RDGE.funcmap[RDGE.UNIFORMTYPE.TEXTURE2D]=function(a,b){gl.activeTexture(gl.TEXTURE0+b);gl.uniform1iv(a,b)};RDGE.funcmap[RDGE.UNIFORMTYPE.TEXTURECUBE]=function(a,b){gl.activeTexture(gl.TEXTURE0+b);gl.uniform1iv(a,b)};
RDGE._bindUniforms=function(a){for(var b=a.RDGEUniform.uniformList.length,a=a.RDGEUniform.uniformList,c=0;c<b;c++){var d=a[c];RDGE.funcmap[d.type](d.uniform,d.value)}};RDGE=RDGE||{};
RDGE.particle=function(a,b){this.id=b;this.def=a;void 0==this.def.numFrames&&(this.def.numFrames=this.def.textureSize&&this.def.frameSize?this.def.textureSize[0]/this.def.frameSize[0]*(this.def.textureSize[1]/this.def.frameSize[1]):0);this.pos=RDGE.vec3.zero();this.delta=RDGE.vec3.zero();this.lifespan=this.age=this.rotate=0;this.velocity=RDGE.vec3.zero();this.gravity=RDGE.vec3.zero();this.frameCount=this.frame=0;this.lastPos=RDGE.vec3.zero();this.state=0;this.hide=!1;this.color=RDGE.vec4.zero();this.randomize=
function(a,b){return a+(b-a)*Math.random()};this.rate=this.randomize(-1,1);this.randomize3=function(a,b){return[this.randomize(a[0],b[0]),this.randomize(a[1],b[1]),this.randomize(a[2],b[2])]};this.spawn=function(a){this.frame=this.def.initialframe==void 0?this.id%this.def.numFrames:this.randomize(this.def.initialframe[0],this.def.initialframe[1]);this.pos=this.randomize3(this.def.initialpos[0],this.def.initialpos[1]);if(this.def.worldSpace)this.pos=RDGE.mat4.transformPoint(a,this.pos);a=Math.PI/180;
this.size=this.def.initialsize?this.randomize(this.def.initialsize[0],this.def.initialsize[1]):1;this.velocity=this.randomize3(this.def.initialvel[0],this.def.initialvel[1]);this.gravity=[this.def.gravity[0],this.def.gravity[1],this.def.gravity[2]];this.rotate=this.randomize(this.def.initialrot[0]*a,this.def.initialrot[1]*a);this.lifespan=this.randomize(this.def.lifespan[0],this.def.lifespan[1]);this.age=0;this.delta=[0,0,0];this.lastPos=RDGE.vec3.add(this.pos,RDGE.vec3.scale(this.velocity,-1/30));
this.color=[1,1,1,1]}};RDGE.DoubleBuffer=function(a,b){this.buffer={};this.buffer[0]=new a(b);this.buffer[1]=new a(b);this.bufferIndex=0;this.flip=function(){this.bufferIndex=1-this.bufferIndex};this.front=function(){return this.buffer[this.bufferIndex]};this.back=function(){return this.buffer[1-this.bufferIndex]}};
RDGE.particleBuffer=function(a,b,c){var d=RDGE.globals.engine.getContext().renderer,f=d.ctx;s_particleShader=new RDGE.jshader;s_particleShader.def={shaders:{defaultVShader:"assets/shaders/particle_vshader.glsl",defaultFShader:"assets/shaders/particle_fshader.glsl"},techniques:{defaultTechnique:[{vshader:"defaultVShader",fshader:"defaultFShader",attributes:{a_pos:{type:"vec4"},a_posId:{type:"float"},a_rotation:{type:"float"},a_size:{type:"float"},a_color:{type:"vec4"}},params:{u_projMatrix:{type:"mat4"},
u_viewMatrix:{type:"mat4"},u_worldMatrix:{type:"mat4"},u_particleSizeX:{type:"vec4"},u_particleSizeY:{type:"vec4"},u_particleRot:{type:"vec4"},u_particleColors:{type:"mat4"},u_textureSize:{type:"vec2"},u_frameSize:{type:"vec2"},s_texture0:{type:"tex2d"}}}]}};s_particleShader.init();s_particleTextures={};this.shader=s_particleShader;this.owner=b;if(a.texture&&void 0==s_particleTextures[a.texture]){s_particleTextures[a.texture]=d.createTexture(a.texture);if(!a.textureSize||!a.frameSize)a.textureSize=
[],a.textureSize[0]=s_particleTextures[a.texture].image.width,a.textureSize[1]=s_particleTextures[a.texture].image.height;a.frameSize||(a.frameSize=[],a.frameSize[0]=s_particleTextures[a.texture].image.width,a.frameSize[1]=s_particleTextures[a.texture].image.height)}a.texture2&&void 0==s_particleTextures[a.texture2]&&(s_particleTextures[a.texture2]=d.createTexture(a.texture2));this.texture=s_particleTextures[a.texture];this.texture2=s_particleTextures[a.texture2];this.bounds={};this.bounds.min=RDGE.vec3.zero();
this.bounds.max=RDGE.vec3.zero();this.srcBlend=a.srcBlend;this.dstBlend=a.dstBlend;this.particles=[];this.posBuffer=new RDGE.DoubleBuffer(Float32Array,16*c);this.posIdBuffer=new Float32Array(4*c);this.sizeBuffer=new RDGE.DoubleBuffer(Float32Array,4*c);this.rotBuffer=new RDGE.DoubleBuffer(Float32Array,4*c);this.colorBuffer=new RDGE.DoubleBuffer(Float32Array,16*c);this.indexBuffer=new RDGE.DoubleBuffer(Uint16Array,6*c);this.indexBuffer.front().numIndices=0;for(i=this.indexBuffer.back().numIndices=0;i<
c;++i){this.particles.push(new RDGE.particle(a,i));for(j=0;2>j;++j){b=this.posBuffer.front();d=16*i;for(j=0;4>j;++j){var g=d+4*j;b[g+0]=0;b[g+1]=0;b[g+2]=0;b[g+3]=1}b=4*i;d=this.rotBuffer.front();d[b+0]=0;d[b+1]=0;d[b+2]=0;d[b+3]=0;b=4*i;this.sizeBuffer.front();d[b+0]=1;d[b+1]=1;d[b+2]=1;d[b+3]=1;b=4*i;this.colorBuffer.front()[b]=16777215;d=this.indexBuffer.front();g=6*i;d[g+0]=b+1;d[g+1]=b+0;d[g+2]=b+3;d[g+3]=b+1;d[g+4]=b+3;d[g+5]=b+2;this.posBuffer.flip();this.rotBuffer.flip();this.indexBuffer.flip()}b=
4*i;this.posIdBuffer[b+0]=0;this.posIdBuffer[b+1]=1;this.posIdBuffer[b+2]=2;this.posIdBuffer[b+3]=3}this.posBufferObject=f.createBuffer();f.bindBuffer(f.ARRAY_BUFFER,this.posBufferObject);f.bufferData(f.ARRAY_BUFFER,this.posBuffer.front(),f.DYNAMIC_DRAW);this.posIdBufferObject=f.createBuffer();f.bindBuffer(f.ARRAY_BUFFER,this.posIdBufferObject);f.bufferData(f.ARRAY_BUFFER,this.posIdBuffer,f.DYNAMIC_DRAW);this.rotBufferObject=f.createBuffer();f.bindBuffer(f.ARRAY_BUFFER,this.rotBufferObject);f.bufferData(f.ARRAY_BUFFER,
this.rotBuffer.front(),f.DYNAMIC_DRAW);this.sizeBufferObject=f.createBuffer();f.bindBuffer(f.ARRAY_BUFFER,this.sizeBufferObject);f.bufferData(f.ARRAY_BUFFER,this.sizeBuffer.front(),f.DYNAMIC_DRAW);this.colorBufferObject=f.createBuffer();f.bindBuffer(f.ARRAY_BUFFER,this.colorBufferObject);f.bufferData(f.ARRAY_BUFFER,this.colorBuffer.front(),f.DYNAMIC_DRAW);this.indexBufferObject=f.createBuffer();f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,this.indexBufferObject);f.bufferData(f.ELEMENT_ARRAY_BUFFER,this.indexBuffer.front(),
f.DYNAMIC_DRAW);this.end=this.start=0;this.cap=c;this.kill=function(){this.start++;this.start>this.cap-1&&(this.start=0)};this.emit=function(){this.end++;this.end>=this.cap&&(this.end=0);this.end==this.start&&this.kill();this.particles[this.end].spawn(this.owner.world)};this.sync=function(){this.posBuffer.flip();this.rotBuffer.flip();this.sizeBuffer.flip();this.colorBuffer.flip();this.indexBuffer.flip();var b=this.posBuffer.back(),c=this.rotBuffer.back(),d=this.sizeBuffer.back(),f=this.colorBuffer.back(),
g=this.indexBuffer.back(),o=this.bounds.min,q=this.bounds.max;o[0]=1E10;o[1]=1E10;o[2]=1E10;q[0]=-1E10;q[1]=-1E10;q[2]=-1E10;for(var r=0,u=this.start;;){var s=this.particles[u],w=s.age/s.lifespan,v=Math.min(w,0.999)+Math.floor(s.frame);if(1>w){var x=s.pos[0],z=s.pos[1],A=s.pos[2];x>q[0]&&(q[0]=x);x>q[1]&&(q[1]=z);x>q[2]&&(q[2]=A);x<o[0]&&(o[0]=x);x<o[1]&&(o[1]=z);x<o[2]&&(o[2]=A);w=16*u;for(j=0;4>j;++j){var y=w+4*j;b[y+0]=x;b[y+1]=z;b[y+2]=A;b[y+3]=v}v=4*u;w=0;a.velocityAligned&&(w=Math.atan2(s.delta[0],
s.delta[1]));c[v+0]=s.rotate+w;c[v+1]=s.rotate+w;c[v+2]=s.rotate+w;c[v+3]=s.rotate+w;d[v+0]=s.size;d[v+1]=s.size;d[v+2]=s.size;d[v+3]=s.size;w=16*u;for(j=0;4>j;++j)y=w+4*j,f[y+0]=s.color[0],f[y+1]=s.color[1],f[y+2]=s.color[2],f[y+3]=s.color[3];g[r+0]=v+1;g[r+1]=v+0;g[r+2]=v+3;g[r+3]=v+1;g[r+4]=v+2;g[r+5]=v+3;r+=6}if(u==this.end)break;u++;u==this.cap&&this.end!=this.cap&&(u=0)}g.numIndices=r;a.worldSpace||(b=RDGE.mat4.mul(o,this.owner.world),c=RDGE.mat4.mul(q,this.owner.world),c[0]>q[0]&&(q[0]=c[0]),
c[1]>q[1]&&(q[1]=c[1]),c[2]>q[2]&&(q[2]=c[2]),b[0]<o[0]&&(o[0]=b[0]),b[1]<o[1]&&(o[1]=b[1]),b[2]<o[2]&&(o[2]=b[2]))};this.update=function(b,c){var d=this.start;if(void 0!=a.persist&&!1==a.persist)for(;;){var f=this.particles[d];if(f.age<f.lifespan)break;this.kill();if(d==this.end)break;d++;d==this.cap&&this.end!=this.cap&&(d=0)}for(d=this.start;;){for(var f=this.particles[d],g=c.length;g;)c[--g].move(f,b);if(d==this.end)break;d++;d==this.cap&&this.end!=this.cap&&(d=0)}this.sync()};this.render=function(){var b=
RDGE.globals.engine.getContext().renderer,c=RDGE.globals.engine.getContext().renderer.ctx,d=this.posBuffer.front(),f=this.rotBuffer.front(),g=this.sizeBuffer.front(),o=this.colorBuffer.front(),q=this.indexBuffer.front();if(0<q.numIndices){var r=this.shader.defaultTechnique,b=b.cameraManager().getActiveCamera();a.worldSpace?(r.u_viewMatrix.set(b.view),r.u_worldMatrix.set(RDGE.mat4.identity())):(r.u_viewMatrix.set(b.view),r.u_worldMatrix.set(this.owner.world));r.u_projMatrix.set(b.proj);r.u_particleSizeX.set(a.sizeX);
r.u_particleSizeY.set(a.sizeY);r.u_particleRot.set(RDGE.vec4.scale(a.rotation,Math.PI/180));r.u_particleColors.set(RDGE.mat4.transpose(a.colors));r.u_textureSize.set(a.textureSize);r.u_frameSize.set(a.frameSize);r.s_texture0.set(this.texture);r=this.shader.begin();for(passIdx=0;passIdx<r;++passIdx)this.shader.beginPass(passIdx),a.depthTest||c.disable(c.DEPTH_TEST),c.enable(c.BLEND),c.blendFunc(c[a.srcBlend],c[a.dstBlend]),c.enableVertexAttribArray(0),c.enableVertexAttribArray(1),c.enableVertexAttribArray(2),
c.enableVertexAttribArray(3),c.enableVertexAttribArray(4),c.bindBuffer(c.ARRAY_BUFFER,this.posBufferObject),c.bufferSubData(c.ARRAY_BUFFER,0,d),c.bindBuffer(c.ARRAY_BUFFER,this.posBufferObject),c.vertexAttribPointer(0,4,c.FLOAT,!1,0,0),c.bindBuffer(c.ARRAY_BUFFER,this.posIdBufferObject),c.vertexAttribPointer(1,1,c.FLOAT,!1,0,0),c.bindBuffer(c.ARRAY_BUFFER,this.rotBufferObject),c.bufferSubData(c.ARRAY_BUFFER,0,f),c.bindBuffer(c.ARRAY_BUFFER,this.rotBufferObject),c.vertexAttribPointer(2,1,c.FLOAT,!1,
0,0),c.bindBuffer(c.ARRAY_BUFFER,this.sizeBufferObject),c.bufferSubData(c.ARRAY_BUFFER,0,g),c.bindBuffer(c.ARRAY_BUFFER,this.sizeBufferObject),c.vertexAttribPointer(3,1,c.FLOAT,!1,0,0),c.bindBuffer(c.ARRAY_BUFFER,this.colorBufferObject),c.bufferSubData(c.ARRAY_BUFFER,0,o),c.bindBuffer(c.ARRAY_BUFFER,this.colorBufferObject),c.vertexAttribPointer(4,4,c.FLOAT,!1,0,0),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,this.indexBufferObject),c.bufferSubData(c.ELEMENT_ARRAY_BUFFER,0,q),c.drawElements(c.TRIANGLES,q.numIndices,
c.UNSIGNED_SHORT,0),c.disable(c.BLEND),a.depthTest||c.enable(c.DEPTH_TEST),c.blendFunc(c.ONE,c.ZERO),this.shader.endPass();this.shader.end()}}};
particleMoverDefault=function(){this.move=function(a,b){a.age+=b;a.age=a.def.persist?a.def.cycle&&a.age>0.99*a.lifespan?a.age-0.99*a.lifespan:Math.min(a.age,0.99*a.lifespan):Math.min(a.age,a.lifespan);0<a.def.frameRate&&(a.frame+=a.def.frameRate*b,a.frame=a.def.frameLoop?a.frame%a.def.numFrames:Math.min(a.def.numFrames-1,a.frame));var c=a.pos,d=a.gravity,f=a.velocity,g=a.pos,h=a.delta;f[0]+=d[0]*b;f[1]+=d[1]*b;f[2]+=d[2]*b;g[0]+=f[0]*b;g[1]+=f[1]*b;g[2]+=f[2]*b;h[0]=g[0]-c[0];h[1]=g[1]-c[1];h[2]=
g[2]-c[2];if(a.def.turbulence){var h=a.def.turbulence[0],l=a.def.turbulence[1],c=Math.random()*(l[0]-h[0])+h[0],d=Math.random()*(l[1]-h[1])+h[1],h=Math.random()*(l[2]-h[2])+h[2];f[0]+=c;f[1]+=d;f[2]+=h}a.def.jitter&&(d=a.def.jitter[0],h=a.def.jitter[1],f=Math.random()*(h[0]-d[0])+d[0],c=Math.random()*(h[1]-d[1])+d[1],d=Math.random()*(h[2]-d[2])+d[2],g[0]+=f,g[1]+=c,g[2]+=d)}};
RDGE.particleEmitter=function(a){this.def=a;this.world=RDGE.mat4.identity();this.pbuffer=new RDGE.particleBuffer(this.def.particle,this,this.def.maxParticles);this.movers=[];var b=particleMoverDefault;a.particle.moverFunc&&(b=eval(a.particle.moverFunc));this.movers.push(new b);this.emitCounter=this.lastEmitTime=this.localTime=0;this.firstUpdate=!0;this.attachToNode=function(a){this.controller=a};this.update=function(a){this.localTime+=a;this.firstUpdate&&(this.lastEmitTime=this.localTime,this.firstUpdate=
!1);void 0!=this.def.emit&&!1==this.def.emit&&(this.lastEmitTime=this.localTime-1/this.def.emitRate);for(var b=this.def.maxParticles,f=this.def.emitOnce,g=void 0==this.def.emit||!0==this.def.emit?Math.floor((this.localTime-this.lastEmitTime)*this.def.emitRate):0;g--&&!(f&&this.emitCounter++>=b);)this.pbuffer.emit(this.world),this.lastEmitTime=this.localTime;this.pbuffer.update(a,this.movers)}};
RDGE.particleSys=function(a){loaded="undefined"==typeof loaded?{}:loaded;this.node=this.def=null;this.world=RDGE.mat4.identity();this.emitters={};this.init=function(){if(null!=this.def){for(e in this.def.emitters)this.emitters[e]=new RDGE.particleEmitter(this.def.emitters[e]);this.bounds={};this.bounds.min=RDGE.vec3.zero();this.bounds.max=RDGE.vec3.zero()}};if(loaded[a])this.def=loaded[a],this.init();else{var b=new XMLHttpRequest;b.sender=this;b.onreadystatechange=function(){4==b.readyState&&(200==
b.status||-1==window.location.href.indexOf("http")?(b.sender.def=eval("("+b.responseText+")"),loaded[a]=b.sender.def,b.sender.init()):alert("An error has occured loading particle system."))};b.open("GET",a,!0);b.send(null)}this.update=function(a){if(null!=this.def){var b=this.bounds.min,f=this.bounds.max;b[0]=1E10;b[1]=1E10;b[2]=1E10;f[0]=-1E10;f[1]=-1E10;f[2]=-1E10;var g=this.node?this.node.world:this.world;for(em in this.emitters){var h=this.emitters[em];h.world=g;h.update(a);var l=h.pbuffer.bounds.min,
h=h.pbuffer.bounds.max;l[0]<b[0]&&(b[0]=l[0]);l[1]<b[1]&&(b[1]=l[1]);l[2]<b[2]&&(b[2]=l[2]);h[0]>f[0]&&(f[0]=h[0]);h[1]>f[1]&&(f[1]=h[1]);h[2]>f[2]&&(f[2]=h[2])}}};this.render=function(){if(null!=this.def)for(em in this.emitters)this.emitters[em].pbuffer.render()};this.attachToNode=function(a){this.node=a}};RDGE.g_particleSystemManager=new RDGE.objectManager;RDGE.g_particleSystemManager.update=function(a){for(var b=this.objects.length-1;0<=b;){var c=this.objects[b];c&&c.update(a);b--}};
RDGE.g_particleSystemManager.render=function(){for(var a=0;a<this.objects.length;){var b=this.objects[a];b&&b.render();a++}};RDGE=RDGE||{};RDGE.RunState=function(a,b){this.name="RunState";this.userRunState=void 0!=a?a:new RDGE.core.RDGEState;this.hasUserState=void 0!=a?!0:!1;this.renderer=b.renderer;this.initialized=!1};
RDGE.RunState.prototype.Init=function(){this.initialized=!0;var a=this.renderer.vpWidth,b=this.renderer.vpHeight,c=new RDGE.camera;c.setPerspective(45,a/b,1,100);c.setLookAt([0,0,20],[0,0,0],RDGE.vec3.up());this.renderer.cameraManager().setActiveCamera(c);this.hasUserState&&void 0!=this.userRunState.init&&this.userRunState.init();if(this.hasUserState&&this.userRunState&&this.userRunState.onRunState)this.userRunState.onRunState()};
RDGE.RunState.prototype.ReInit=function(){if(this.initialized){if(this.hasUserState&&this.userRunState&&this.userRunState.onRunState)this.userRunState.onRunState()}else this.Init()};RDGE.RunState.prototype.Update=function(a){this.userRunState.update(a)};
RDGE.RunState.prototype.Resize=function(){RDGE.globals.engine.lastWindowWidth==window.innerWidth&&RDGE.globals.engine.lastWindowHeight==window.innerHeight&&(this.userRunState.resize(),RDGE.globals.engine.lastWindowWidth=window.innerWidth,RDGE.globals.engine.lastWindowHeight=window.innerHeight)};RDGE.RunState.prototype.Draw=function(){this.userRunState.draw()};RDGE.RunState.prototype.Shutdown=function(){void 0!=this.userRunState.shutdown&&this.userRunState.shutdown()};
RDGE.RunState.prototype.LeaveState=function(){if(void 0!=this.userRunState.onComplete)this.userRunState.onComplete()};RDGE=RDGE||{};RDGE.LoadState=function(a,b){this.name="LoadState";this.userRunState=void 0!==a?a:new RDGE.core.RDGEState;this.hasUserState=void 0!==a?!0:!1;this.renderer=b.renderer;this.loadingDone=!1;this.stateManager=b.ctxStateManager;this.sceneLoadQueue=[];this.textureLoadQueue=[]};RDGE.LoadState.prototype.loadScene=function(a,b){var c=new RDGE.sceneRequestDef(a,b);c.doSceneRequest=!0;this.sceneLoadQueue.push(c)};
RDGE.LoadState.prototype.loadTexture=function(a){"LoadState"!=this.stateManager.currentState().name&&this.stateManager.PushState(this.stateManager.RDGEInitState,"noInit");this.textureLoadQueue.push(a)};RDGE.LoadState.prototype.Init=function(){this.sceneName&&this.loadScene("assets_web/mesh/"+this.sceneName+".json",this.sceneName);if(this.hasUserState&&this.userRunState&&this.userRunState.onLoadState)this.userRunState.onLoadState()};
RDGE.LoadState.prototype.ReInit=function(){if(this.hasUserState&&this.userRunState&&this.userRunState.onLoadState)this.userRunState.onLoadState()};RDGE.LoadState.prototype.Resize=function(){RDGE.globals.engine.lastWindowWidth==window.innerWidth&&RDGE.globals.engine.lastWindowHeight==window.innerHeight&&(this.userRunState.resize(),RDGE.globals.engine.lastWindowWidth=window.innerWidth,RDGE.globals.engine.lastWindowHeight=window.innerHeight)};
RDGE.LoadState.prototype.Update=function(a){var b=this.sceneLoadQueue.length-1;-1<b&&(b=this.sceneLoadQueue[b],RDGE.globals.meshMan.processMeshData(),b.doSceneRequest?b.requestScene():b.requestComplete&&(b.sceneBeginProcessing?(b.scene=new RDGE.SceneGraph(b.rawData),b.scene.enableShadows(!0),RDGE.globals.engine.AddScene(b.name,b.scene),b.scene.Traverse(b.sceneProcessor,!1),b.sceneBeginProcessing=!1):b.processingComplete()&&(b=this.sceneLoadQueue.shift(),this.userRunState.onComplete(b.name,b.scene))));
for(;0<this.textureLoadQueue.length;)this.renderer.commitTexture(this.textureLoadQueue.shift());0==this.sceneLoadQueue.length&&0==this.textureLoadQueue.length&&RDGE.globals.engine.getContext().ctxStateManager.PopState();RDGE.globals.engine.getContext().getScene()&&("not-ready"!=RDGE.globals.engine.getContext().getScene()&&this.stateManager.RDGERunState.initialized)&&this.userRunState.update(a)};
RDGE.LoadState.prototype.Draw=function(){this.renderer._clear();RDGE.globals.engine.getContext().getScene()&&("not-ready"!=RDGE.globals.engine.getContext().getScene()&&this.stateManager.RDGERunState.initialized)&&this.userRunState.draw()};RDGE.LoadState.prototype.Shutdown=function(){};RDGE.LoadState.prototype.LeaveState=function(){if(void 0!=this.userRunState.onComplete)this.userRunState.onComplete()};
RDGE.LoadState.prototype.MakeSceneRequest=function(a,b){this.hasScene=!0;this.lastSceneName=b;var c=new XMLHttpRequest;c.initState=this;RDGE.globals.engine.getContext().sceneGraphMap[b]="not-ready";c.onreadystatechange=function(){4==c.readyState&&(200==c.status||-1==window.location.href.indexOf("http")?(this.initState.scene=eval("("+c.responseText+")"),this.initState.loadingDone=!0):alert("An error has occured making the request"))};c.open("GET",a,!0);c.send(null)};
RDGE.SetupScene=function(){this.renderer=RDGE.globals.engine.getContext().renderer;this.meshLoadingMap=[];this.onMeshLoaded=function(a){this.meshLoadingMap[a]&&(this.meshLoadingMap[a].stillLoading=!1)};RDGE.globals.meshMan.addOnLoadedCallback(this)};
RDGE.SetupScene.prototype.process=function(a,b){RDGE.verifyTransformNode(a);a.parent=b;void 0!==a.local&&(a.local=RDGE.mat4.transpose(a.local));if("undefined"!=((a.materialNode||{}).meshNode||{})&&void 0!==a.materialNode){var c=RDGE.globals.meshMan.loadMesh(a.materialNode.meshNode.mesh);a.meshes.push(a.materialNode.meshNode);null==c?this.meshLoadingMap[a.materialNode.meshNode.mesh.name]={stillLoading:!0,remotelyLoading:!1}:c.primitive?this.renderer.createPrimitive(c.primitive):this.meshLoadingMap[a.materialNode.meshNode.mesh.name]||
(this.meshLoadingMap[a.materialNode.meshNode.mesh.name]={stillLoading:!0,remotelyLoading:!0});RDGE.verifyMaterialNode(a.materialNode);c=[];c.TEX_DIF={slot:0,uni:"colMap"};c.TEX_SPEC={slot:1,uni:"envMap"};c.TEX_NORM={slot:2,uni:"normalMap"};c.TEX_GLOW={slot:3,uni:"glowMap"};for(var d=a.materialNode.textureList,f=[],g=0;g<d.length;++g){var h=this.renderer.getTextureByName(d[g].name);f[g]={name:c[d[g].type].uni,handle:h,unit:c[d[g].type].slot,type:RDGE.UNIFORMTYPE.TEXTURE2D}}a.materialNode.textureList=
f}if("undefined"!=(a.lightNode||{})&&void 0!==a.lightNode)a.lightNode.parent=a,RDGE.globals.engine.lightManager.setMapping(a.lightNode,a.lightNode.links)};
RDGE.sceneRequestDef=function(a,b){this.name=b;this.addr=a;this.requestComplete=this.sceneBeginProcessing=!1;this.sceneProcessor=new RDGE.SetupScene;this.doSceneRequest=!1;this.processingComplete=function(){for(var a in this.sceneProcessor.meshLoadingMap)if(!1==this.sceneProcessor.meshLoadingMap[a].stillLoading)!0==this.sceneProcessor.meshLoadingMap[a].remotelyLoading&&this.sceneProcessor.renderer.createPrimitive(RDGE.globals.meshMan.getModelByName(a).primitive);else return!1;return!0};this.requestScene=
function(){this.doSceneRequest=!1;var b=new XMLHttpRequest;b.handler=this;RDGE.globals.engine.getContext().sceneGraphMap[name]="not-ready";b.onreadystatechange=function(){4==b.readyState&&(200==b.status||-1==window.location.href.indexOf("http")?(this.handler.rawData=eval("("+b.responseText+")"),this.handler.requestComplete=!0,this.handler.sceneBeginProcessing=!0):alert("An error has occured making the request"))};b.open("GET",a,!0);b.send(null)}};RDGE=RDGE||{};RDGE.core=RDGE.core||{};RDGE.utilities=RDGE.utilities||{};RDGE.globals=function(){return{engine:new RDGE.Engine,width:0,height:0,cam:null,shaderMan:null,meshMan:null,poolList:[],gl:null}}();RDGE.core.RDGEState=function(){};RDGE.core.RDGEState.prototype.init=function(){};RDGE.core.RDGEState.prototype.update=function(){};RDGE.core.RDGEState.prototype.draw=function(){};RDGE.core.RDGEState.prototype.resize=function(){};RDGE.core.RDGEState.prototype.shutdown=function(){};
RDGE.core.RDGEState.prototype.onComplete=function(){};
RDGE.utilities.validateUserState=function(a){a.init||(a.init=function(){});a.update||(a.update=function(a){var c=RDGE.globals.engine.getContext().currentScene,c=RDGE.globals.engine.getScene(c);c!=null&&c.update(a)});a.draw||(a.draw=function(){var a=RDGE.globals.engine.getContext().currentScene,a=RDGE.globals.engine.getScene(a);a!=null&&a.render()});a.resize||(a.resize=function(){});a.shutdown||(a.shutdown=function(){});a.onComplete||(a.onComplete=function(){})};
RDGE.RDGEStart=function(a){var b=a;"string"===typeof a&&(b=document.getElementById(a));b&&(RDGE.globals.engine.registerCanvas(b),b.task||(b.task=new RDGE.RDGETask(b,!1)),RDGE.globals.shaderMan||(RDGE.globals.shaderMan=new RDGE.ShaderManager),RDGE.globals.meshMan||(RDGE.globals.meshMan=new RDGE.MeshManager),RDGE.globals.engine.initializeComplete||RDGE.globals.engine.init())};RDGE.RDGEStop=function(){};
RDGE.RequestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();RDGERequestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();
RDGE.RDGETask=function(){var a={};return function(b,c){this.id=b.rdgeid;this.lastTime=this.currTime=0;this.running=!1;this.context=null;if(b){this.context=RDGE.globals.engine.ctxMan.handleToObject(b.rdgeCtxHandle);a[this.id]=function(){d.running&&(d.currTime=(new Date).getTime(),d.step((d.currTime-d.lastTime)/1E3),RDGERequestAnimationFrame(a[d.id],b),d.lastTime=d.currTime)};this.start=function(){this.running||(this.running=!0,this.lastTime=this.currTime=(new Date).getTime(),a[this.id]())};this.stop=
function(){this.running=!1};this.kill=function(){this.running=!1;a[this.id]=null};this.step=function(a){contextManager.currentCtx=this.context;this.context.ctxStateManager.tick(a)};var d=this;c&&d.start()}}}();
